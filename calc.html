<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <script>
            (function () {
                try {
                    document.documentElement.classList.add('pagefx');
                    window.setTimeout(function () {
                        document.documentElement.classList.add('pagefx-ready');
                    }, 900);
                } catch (e) {}
            })();
        </script>
        <style>html.pagefx:not(.pagefx-ready) body{opacity:0}</style>
        <link rel="stylesheet" href="assets/page-transitions.css">
        <script src="assets/page-transitions.js" defer></script>
        <link rel="stylesheet" href="assets/bottom-nav.css" />
        <script src="assets/bottom-nav.js" defer></script>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="manifest" href="manifest-calc.webmanifest">
    <meta name="theme-color" content="#F4C430">
    <title>Прайс-лист та Калькулятор</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
    /* Hover effect for credit comparison tables */
    #installmentsTableBody tr:hover,
    #deferredTableBody tr:hover {
        background-color: #e0f2fe !important; /* Tailwind sky-100 */
        transition: background 0.15s;
    }
    /* Dotted underline for overpayment cell */
    .dotted-underline {
        border-bottom: 1px dotted #ccc;
        cursor: help;
        text-decoration: none;
    }
    </style>
    <script>
        (function () {
            try {
                const params = new URLSearchParams(location.search);
                const isEmbed = params.get('embed') === '1';
                const inIframe = (function () {
                    try { return window.self !== window.top; } catch (e) { return true; }
                })();

                if (isEmbed && inIframe) {
                    document.documentElement.classList.add('embed');
                    return;
                }

                if (location.protocol === 'file:') {
                    return;
                }

                const target = new URL(location.href);
                target.search = '';
                target.pathname = target.pathname.replace(/[^/]+\.html$/i, 'index.html');
                target.hash = '#calc';
                location.replace(target.toString());
            } catch (e) {}
        })();
    </script>
    <style>
        html { overflow-y: scroll; scrollbar-gutter: stable; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; padding-top: var(--header-pad-top, 60px); }
        .price-btn.active {
            background-color: #22c55e; /* green-500 */
            color: rgb(255, 255, 255);
            border-color: #22c55e;
        }
        .price-btn.active:hover {
            background-color: #16a34a; /* green-600 */
        }
        .price-btn {
            transition: all 0.2s;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .chevron {
            transition: transform 0.3s;
        }
        details[open] .chevron {
            transform: rotate(180deg);
        }

        /* Floating calculator FAB (mobile) */
        #calc-fab {
            transition: opacity 220ms ease, transform 220ms ease;
            will-change: opacity, transform;
        }
        #calc-fab.calc-fab--hidden {
            opacity: 0;
            transform: translateY(6px) scale(0.92);
            pointer-events: none;
        }
        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        /* Embedded mode (inside index.html) */
        html.embed .header { display: none !important; }
        html.embed body { padding-top: var(--header-pad-top, 1rem) !important; }

        /* Tablets/phones: add top padding to main container so the first category doesn't stick to the top.
           (Works both with and without a visible header.) */
        @media (max-width: 1023px) {
            .max-w-7xl.mx-auto.px-4 { padding-top: 1rem; }
        }

        /* Non-desktop: keep a small top offset before the first category card. */
        @media (max-width: 1023px) {
            #catalog-container { padding-top: 20px; }
        }

        .logo h1 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 800;
        }

        .nav {
            display: flex;
        }

        .nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 30px;
        }

        .nav-link {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            background: #4CAF50;
            color: #fff;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background: #333;
            margin: 3px 0;
            transition: 0.3s;
        }

        /* Стиль для калькулятора, що прилипає на десктопі */
        @media (min-width: 1024px) {
            .sticky-calc {
                position: sticky;
                top: var(--sticky-calc-top, 180px); /* auto-set via JS */
                max-height: var(--sticky-calc-maxh, calc(100vh - 200px));
                overflow-y: auto;
                scrollbar-gutter: stable;
            }

            /* Align the first catalog card with the sticky calculator column.
               JS sets --catalog-top-pad based on header/sticky offsets. */
            #catalog-container {
                padding-top: var(--catalog-top-pad, 0px);
            }
        }

        /* Mobile header */
        @media (max-width: 768px) {
            .header-container {
                padding: 10px 15px;
            }

            .logo h1 {
                font-size: 20px;
            }

            .nav {
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                height: calc(100vh - 60px);
                background: #fff;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 50px;
                opacity: 0;
                transform: translateY(-6px);
                pointer-events: none;
                transition: opacity 160ms ease, transform 160ms ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                z-index: 999;
            }

            .nav.open {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }

            .nav-list {
                flex-direction: column;
                gap: 20px;
            }

            .nav-item {
                opacity: 0;
                transform: translateX(-18px);
                transition: transform 180ms ease, opacity 180ms ease;
            }

            .nav-item:nth-child(even) {
                transform: translateX(18px);
            }

            .nav.open .nav-item {
                opacity: 1;
                transform: translateX(0);
            }

            @media (prefers-reduced-motion: reduce) {
                .nav,
                .nav-item {
                    transition: none;
                    transform: none;
                }
            }

            .nav-link {
                font-size: 18px;
                padding: 15px 30px;
                display: flex;
                align-items: center;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.open .bar:nth-child(1) {
                transform: rotate(-45deg) translate(-5px, 6px);
            }

            .hamburger.open .bar:nth-child(2) {
                opacity: 0;
            }

            .hamburger.open .bar:nth-child(3) {
                transform: rotate(45deg) translate(-5px, -6px);
            }
        }
    </style>
</head>
<body class="pb-10">

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <h1>General Machines</h1>
            </div>
            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="index.html#gm-script" class="nav-link"><i class="fas fa-file-code mr-2"></i>Скрипти</a></li>
                    <li class="nav-item"><a href="calc.html" class="nav-link active"><i class="fas fa-calculator mr-2"></i>Прайс</a></li>
                    <li class="nav-item"><a href="dov.html" class="nav-link"><i class="fas fa-calendar-check mr-2"></i>План</a></li>
                    <li class="nav-item"><a href="generator-ankety.html" class="nav-link"><i class="fas fa-file-excel mr-2"></i>Анкета</a></li>
                    <li class="nav-item"><a href="education.html" class="nav-link"><i class="fas fa-graduation-cap mr-2"></i>Навчання</a></li>
                </ul>
            </nav>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </header>

    <!-- Основний контейнер з сіткою -->
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Ліва колонка: Товари (Прайс) -->
            <div class="w-full lg:w-2/3 min-w-0" id="catalog-container">
                <!-- Категорії генеруються JS -->
            </div>

            <!-- Права колонка: Калькулятор -->
            <div class="w-full lg:w-1/3 lg:flex-none min-w-0">
                <div class="sticky-calc">
                    <!-- Міні адмін-панель прайсу (над калькулятором; НЕ в хедері) -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-3 flex flex-col gap-2" id="price-admin-bar">
                        <div class="hidden text-xs font-bold uppercase tracking-wide text-amber-600" id="priceEditModeLabel">Режим редагування</div>
                        <div class="flex flex-wrap items-center gap-2" id="priceAdminButtonsRow">
                                <button type="button" id="priceEditToggle" class="inline-flex items-center justify-center gap-2 text-sm font-semibold text-slate-700 hover:text-slate-900 px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition whitespace-nowrap flex-1 basis-44 min-w-[10.5rem] h-10">
                                <i class="fas fa-pen"></i>
                                <span>Редагувати</span>
                                </button>
                                <button type="button" id="priceLastChangesBtn" class="inline-flex items-center justify-center gap-2 text-sm font-semibold text-slate-700 hover:text-slate-900 px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition whitespace-nowrap flex-1 basis-44 min-w-[10.5rem] h-10">
                                <i class="fas fa-clock"></i>
                                <span>Останні зміни</span>
                                </button>
                            <div class="hidden contents" id="priceAdminControls">
                                <button type="button" id="priceAddCategoryBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-300 text-slate-700 text-sm font-semibold hover:bg-gray-50 shadow-sm whitespace-nowrap flex-1 basis-44 min-w-[10.5rem] h-10"><i class="fas fa-folder-plus"></i>Категорія</button>
                                <button type="button" id="priceAddItemBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-300 text-slate-700 text-sm font-semibold hover:bg-gray-50 shadow-sm whitespace-nowrap flex-1 basis-44 min-w-[10.5rem] h-10"><i class="fas fa-plus"></i>Позиція</button>
                                <button type="button" id="priceApplyBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 whitespace-nowrap flex-1 basis-44 min-w-[10.5rem] h-10"><i class="fas fa-save"></i>Зберегти</button>
                            </div>
                        </div>
                    </div>

                    <!-- Панель "Останні зміни" -->
                    <div class="hidden bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-3" id="priceChangesPanel">
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold text-gray-800">Останні зміни цін</div>
                            <div class="flex items-center gap-2">
                                <div class="text-xs text-gray-500">(за полем updatedAt)</div>
                                <button type="button" id="priceClearChangesBtn" class="inline-flex items-center gap-2 text-xs font-semibold text-slate-700 hover:text-slate-900 px-3 py-1.5 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition">
                                    <i class="fas fa-eraser"></i>
                                    <span>Очистити</span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 max-h-56 overflow-auto">
                            <ul class="text-sm divide-y divide-gray-100" id="priceChangesList"></ul>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 max-w-full overflow-x-hidden" id="calculator-section">
                    <div class="flex items-center justify-between mb-4 border-b pb-2">
                        <h2 class="text-2xl font-bold text-gray-800">Калькулятор</h2>
                        <div class="flex items-center gap-2">
                            <button id="creditCompareBtn" type="button" class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded" title="Порівняти варіанти кредиту">
                                <i class="fas fa-credit-card"></i> Кредит
                            </button>
                        </div>
                    </div>

		 <!-- Кнопка "Калькулятор" (FAB, мобільні) -->
    <div class="fixed bottom-4 right-4 z-40 md:hidden" id="calc-fab">
        <button type="button" onclick="scrollToBottom()" aria-label="Калькулятор" title="Калькулятор"
                class="w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-300">
            <i class="fas fa-calculator text-xl" aria-hidden="true"></i>
        </button>
    </div>
                    <!-- Знижка та Націнка -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Знижка/Націнка</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="adjustment-input" placeholder="напр. 5000 або 5%" 
                                   class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <div class="flex gap-1">
                                <button type="button" id="adjustment-plus" class="px-3 py-2 text-sm font-bold rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition">+</button>
                                <button type="button" id="adjustment-minus" class="px-3 py-2 text-sm font-bold rounded bg-red-600 text-white hover:bg-red-700 transition">-</button>
                                <button type="button" id="adjustment-percent" class="px-3 py-2 text-sm font-bold rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition">%</button>
                            </div>
                        </div>
                    </div>

                    <!-- Чек замовлення -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 font-mono text-sm mb-4">
                        <h3 class="font-bold text-center border-b border-dashed border-gray-400 pb-2 mb-2">ЧЕК ЗАМОВЛЕННЯ</h3>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">Ціни</span>
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1.5 text-xs font-bold rounded-lg bg-green-50 text-green-700 border border-green-200">З ПДВ</span>
                                <button type="button" id="vatDiscount25Btn" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition" title="Компенсація: 25% від бази (розрахунок від суми з ПДВ)">25%</button>
                            </div>
                        </div>
                        <div id="receipt-items" class="space-y-2 mb-4">
                            <div class="text-center text-gray-400 italic">Товари не обрані</div>
                        </div>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-2 space-y-1">
                            <div class="flex justify-between" id="receipt-subtotal">
                                <span>Сума товарів:</span>
                                <span>0 грн</span>
                            </div>
                            <div class="flex justify-between text-blue-600 hidden" id="receipt-adjustment">
                                <span>Коригування:</span>
                                <span>0 грн</span>
                            </div>
                            <div class="flex justify-between text-amber-700 hidden" id="receipt-compensation">
                                <span>Компенсація:</span>
                                <span>-0 грн</span>
                            </div>
                        </div>
                        <div class="border-t-2 border-gray-800 pt-2 mt-2 flex justify-between text-xl font-bold">
                            <span>РАЗОМ:</span>
                            <span id="final-total">0 грн</span>
                        </div>
                    </div>
                    
                    <div class="text-center flex items-center justify-center gap-4">
                        <button type="button" onclick="collapseAllCatalog()" class="text-gray-600 text-sm hover:underline">Згорнути все</button>
                        <button type="button" onclick="clearCart()" class="text-red-500 text-sm hover:underline">Очистити все</button>
                    </div>

                    <!-- Спец-ціни (синя/червона) для вибраного товару -->
                    <div id="generalXCalcPrices" class="hidden mt-5">
                        <div class="text-xs font-bold uppercase tracking-wide text-slate-600 mb-2">Спец-ціни: <span id="specialPricesItemName" class="text-slate-800"></span></div>
                        <div class="flex flex-wrap gap-2">
                            <!-- Removed standalone general special-price buttons; per-item buttons shown in list -->
                            <div id="generalXPriceHint" class="text-sm text-slate-600 self-center"></div>
                        </div>

                        <div id="generalXCalcPricesEdit" class="hidden mt-3 p-3 rounded-lg border border-slate-200 bg-white">
                            <div class="text-xs font-bold uppercase tracking-wide text-slate-600 mb-2">Редагування спец-цін (з ПДВ)</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <label class="text-sm text-slate-700">
                                    <div class="text-slate-600">Синя кнопка</div>
                                    <input id="generalXBluePriceInput" type="number" inputmode="numeric" step="1" min="0" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-200" />
                                </label>
                                <label class="text-sm text-slate-700">
                                    <div class="text-slate-600">Червона кнопка</div>
                                    <input id="generalXRedPriceInput" type="number" inputmode="numeric" step="1" min="0" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-200" />
                                </label>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">Збережеться в Firestore після натискання кнопки “Зберегти” у режимі редагування.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- Credit Comparison Modal -->
    <div id="creditCompareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Порівняння всіх варіантів кредиту</h3>
                <button id="closeCreditCompareModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex border border-gray-300 rounded">
                    <button id="compareProgramInstallments" type="button" class="flex-1 px-4 py-2 text-sm font-medium rounded-l bg-blue-600 text-white">Оплата частинами</button>
                    <button id="compareProgramDeferred" type="button" class="flex-1 px-4 py-2 text-sm font-medium rounded-r bg-gray-200 text-gray-700">Відтермінування</button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Розрахунок вартості</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <label class="block text-xs font-semibold text-blue-700 mb-1">Сума за товари</label>
                        <input type="text" id="compareProductTotal" readonly class="w-full text-sm font-bold text-blue-800 bg-transparent border-none outline-none">
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <label class="block text-xs font-semibold text-green-700 mb-1">Аванс</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="compareAdvanceInput" min="0" step="any" class="w-full text-sm font-bold text-green-800 bg-white border border-green-200 rounded px-2 py-1 outline-none" autocomplete="off">
                            <button id="compareAdvanceUnitUah" type="button" class="px-2 py-1 rounded border text-xs font-semibold border-green-300 bg-green-50 text-green-700">грн</button>
                            <button id="compareAdvanceUnitPercent" type="button" class="px-2 py-1 rounded border text-xs font-semibold border-green-300 bg-green-50 text-green-700">%</button>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <label class="block text-xs font-semibold text-purple-700 mb-1">Сума кредиту</label>
                        <input type="text" id="compareLoanAmount" readonly class="w-full text-sm font-bold text-purple-800 bg-transparent border-none outline-none">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <div id="containerInstallments">
                    <table class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2 text-left">Термін</th>
                                <th class="border border-gray-300 p-2 text-right">Оплата в місяць</th>
                                <th class="border border-gray-300 p-2 text-right">Загальна сума для покупця</th>
                                <th class="border border-gray-300 p-2 text-right">Комісія</th>
                            </tr>
                        </thead>
                        <tbody id="installmentsTableBody">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="containerDeferred" style="display:none;">
                    <table class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2 text-left">Термін</th>
                                <th class="border border-gray-300 p-2 text-right">Оплата в кінці терміну</th>
                                <th class="border border-gray-300 p-2 text-right">Комісія</th>
                            </tr>
                        </thead>
                        <tbody id="deferredTableBody">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="compareOrderComposition" class="mt-4 text-[11px] text-gray-500"></div>
        </div>
    </div>

    <script>
        // --- Дані (незмінні) ---
        const categoryColors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-orange-500', 'bg-cyan-500'];

        // --- Firebase: прайс з бази (Firestore) ---
        // Колекція: priceItems
        // Документ: довільний id
        // Поля: { category, name, price1, price2, sortCategory?, sortItem?, active? }
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCIDpmrCoITjCfqMeC94ZO7Enl4HyZ-Lkw",
            authDomain: "gm-base.firebaseapp.com",
            projectId: "gm-base",
            storageBucket: "gm-base.firebasestorage.app",
            messagingSenderId: "579626247182",
            appId: "1:579626247182:web:09324aa5823c564defc85f"
        };

        // --- Спец-ціни (синя/червона) для товарів ---
        // Зберігається у Firestore в priceItems: specialPriceBlue2, specialPriceRed2 (обидва = 0 означає “вимкнено”).
        let specialEditSelectedDocId_ = '';
        let specialUiCartKey_ = '';

        let firebasePriceApiPromise_ = null;

        function discountIconHtml_() {
            // Heroicons "tag" (outline) as a generic discount icon.
            return `
                <span class="inline-flex items-center" title="Є спец-ціни (знижки)" aria-label="Є спец-ціни">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-amber-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15l6-6m-5.5 5.5h.01m4.99-4.99h.01M3 7.5V3h4.5L21 16.5 16.5 21 3 7.5z" />
                    </svg>
                </span>
            `.trim();
        }

        async function initFirebaseForPrice_() {
            if (firebasePriceApiPromise_) return firebasePriceApiPromise_;
            firebasePriceApiPromise_ = (async () => {
                const appMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

                let app;
                const appName = 'price-calc';
                try {
                    app = appMod.initializeApp(FIREBASE_CONFIG, appName);
                } catch (e) {
                    app = appMod.getApp(appName);
                }

                const db = fsMod.getFirestore(app);
                let auth = null;

                // Anonymous auth (якщо правила Firestore вимагають auth)
                try {
                    auth = authMod.getAuth(app);
                    if (!auth.currentUser) {
                        await authMod.signInAnonymously(auth);
                        console.info('[calc] Firebase auth: anonymous signed in');
                    }
                } catch (e) {
                    // Якщо provider вимкнено або домен не дозволено — все одно спробуємо читати (може бути allow read)
                    console.warn('[calc] Firebase auth: anonymous sign-in failed', { code: e?.code, message: e?.message });
                }

                return { db, auth, authMod, ...fsMod };
            })();
            return firebasePriceApiPromise_;
        }

        function buildCatalogFromPriceDocs_(docs) {
            const byCat = new Map();
            for (const d of docs) {
                const data = d.data ? d.data() : d;
                const docId = d && typeof d.id === 'string' ? d.id : null;
                if (!data) continue;
                if (data.active === false) continue;
                const category = String(data.category || '').trim();
                const name = String(data.name || '').trim();
                const price1 = Number(data.price1);
                const price2 = Number(data.price2);
                if (!category || !name) continue;
                if (!Number.isFinite(price1) || !Number.isFinite(price2)) continue;

                const sortCategory = Number.isFinite(Number(data.sortCategory)) ? Number(data.sortCategory) : null;
                const sortItem = Number.isFinite(Number(data.sortItem)) ? Number(data.sortItem) : null;

                if (!byCat.has(category)) {
                    byCat.set(category, { category, sortCategory, items: [] });
                } else {
                    // Make category sort deterministic: keep the smallest provided sortCategory.
                    const cur = byCat.get(category).sortCategory;
                    if (cur == null) byCat.get(category).sortCategory = sortCategory;
                    else if (sortCategory != null && sortCategory < cur) byCat.get(category).sortCategory = sortCategory;
                }

                const specialPriceBlue2 = Number.isFinite(Number(data.specialPriceBlue2)) ? Number(data.specialPriceBlue2) : 0;
                const specialPriceRed2 = Number.isFinite(Number(data.specialPriceRed2)) ? Number(data.specialPriceRed2) : 0;

                byCat.get(category).items.push({ id: docId, name, price1, price2, sortItem, specialPriceBlue2, specialPriceRed2 });
            }

            const cats = Array.from(byCat.values());
            cats.sort((a, b) => {
                const as = a.sortCategory;
                const bs = b.sortCategory;
                if (as != null && bs != null && as !== bs) return as - bs;
                if (as != null && bs == null) return -1;
                if (as == null && bs != null) return 1;
                return String(a.category).localeCompare(String(b.category), 'uk');
            });

            for (const c of cats) {
                c.items.sort((a, b) => {
                    const as = a.sortItem;
                    const bs = b.sortItem;
                    if (as != null && bs != null && as !== bs) return as - bs;
                    if (as != null && bs == null) return -1;
                    if (as == null && bs != null) return 1;
                    return String(a.name).localeCompare(String(b.name), 'uk');
                });
                // Keep fields in-memory so edit UI can show them.
                c.items = c.items.map(({ id, name, price1, price2, sortItem, specialPriceBlue2, specialPriceRed2 }) => ({ id, name, price1, price2, sortItem, specialPriceBlue2, specialPriceRed2 }));
            }
            return cats;
        }

        async function loadCatalogFromFirestore_() {
            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) return false;

                updateLastChangesFromPriceDocs_(snap.docs);

                const next = buildCatalogFromPriceDocs_(snap.docs);
                if (!next.length) return false;

                // Не міняємо посилання на catalogData, щоб не ламати існуючі функції.
                catalogData.length = 0;
                catalogData.push(...next);
                return true;
            } catch (e) {
                const code = e?.code;
                if (code === 'permission-denied' || /insufficient permissions/i.test(String(e?.message || ''))) {
                    console.warn('[calc] price catalog load failed: permission denied. Fix Firestore Rules for /priceItems.', e);
                } else if (code === 'auth/unauthorized-domain') {
                    console.warn('[calc] price catalog load failed: unauthorized domain. Add domain in Firebase Auth -> Settings -> Authorized domains.', e);
                } else {
                    console.warn('[calc] price catalog load failed', e);
                }
                return false;
            }
        }
        
        const catalogData = [
            {
                category: "Куни",
                items: [
                    { name: "GENERAL-X (без ковша)", price1: 170000, price2: 204000 },
                    { name: "GENERAL-XL (без ковша)", price1: 175000, price2: 210000 },
                    { name: "GENERAL-EURO (без ковша)", price1: 194167, price2: 233000 },
                    { name: "GENERAL-XL 1221 (без ковша)", price1: 183333, price2: 220000 },
                    { name: "GENERAL-EURO + 3-тя секція (без ковша) МТЗ", price1: 179167, price2: 215000 },
                    { name: "GENERAL-X (з ковшем в комплекті)", price1: 188333, price2: 226000 },
                    { name: "GENERAL-XL (з ковшем в комплекті)", price1: 193333, price2: 232000 },
                    { name: "GENERAL-EURO (з ковшем в комплекті)", price1: 212500, price2: 255000 },
                    { name: "Комплект для керування гідравлікою на дві секції (Джойстик) 2Р-40", price1: 11667, price2: 14000 },
                    { name: "Комплект для керування гідравлікою на дві секції (Джойстик) 2Р-80", price1: 15000, price2: 18000 },
                    { name: "Електро-магнітний клапан", price1: 5000, price2: 6000 }
                ]
            },
            {
                category: "Навісне до кунів",
                items: [
                    { name: "Ківш STANDART 2 м.", price1: 29167, price2: 35000 },
                    { name: "Ківш 2.2 м.", price1: 31667, price2: 38000 },
                    { name: "Ківш будівельний 1.6 м.", price1: 29167, price2: 35000 },
                    { name: "Ківш ЩЕЛЕПА 1.8 м.", price1: 59167, price2: 71000 },
                    { name: "Ківш ЩЕЛЕПА 2 м.", price1: 62500, price2: 75000 },
                    { name: "Збільшений Ківш на 1.5 м3", price1: 33333, price2: 40000 },
                    { name: "Ківш із ЗАХОПЛЕННЯМ", price1: 62500, price2: 75000 },
                    { name: "Ківш для БЕГІВ", price1: 87500, price2: 105000 },
                    { name: "Ківш для БЕГІВ (автоматичний)", price1: 91667, price2: 110000 },
                    { name: "Гак для бігбегів", price1: 25000, price2: 30000 },
                    { name: "Вила для піддонів", price1: 25000, price2: 30000 },
                    { name: "Вила для ТЮКІВ", price1: 25000, price2: 30000 },
                    { name: "Вила - Гак (2 в1)", price1: 30000, price2: 36000 },
                    { name: "Вила - Гак (3 в1)", price1: 33333, price2: 40000 },
                    { name: "Вила СІНАЖНІ", price1: 58333, price2: 70000 },
                    { name: "Захват для ТЮКІВ", price1: 58333, price2: 70000 },
                    { name: "Захват для КОЛОД", price1: 37500, price2: 45000 }
                ]
            },
            {
                category: "Культиватори",
                items: [
                    { name: "Культиватор навісний КНС 2.6", price1: 150000, price2: 165000 },
                    { name: "Культиватор навісний КНС 3.0", price1: 165000, price2: 180000 },
                    { name: "Культиватор навісний КНС 3.5", price1: 175000, price2: 190000 },
                    { name: "Культиватор навісний КНС 4.0", price1: 185000, price2: 200000 },
                    { name: "Причіпний пристрій до КНС 4.0", price1: 125000, price2: 130000 },
                    { name: "БПП балка причіпного пристрою", price1: 20000, price2: 23000 },
                    { name: "Культиватор причіпний КПС 4.0", price1: 310000, price2: 330000 },
                    { name: "Культиватор причіпний КПРС 5.0", price1: 430000, price2: 480000 },
                    { name: "Культиватор причіпний КПРС 6.0", price1: 530000, price2: 580000 }
                ]
            },
            {
                category: "Лущильники",
                items: [
                    { name: "Лущильник 2.6 м.", price1: 260000, price2: 270000 },
                    { name: "Лущильник 2.6 м. з тандемним котком", price1: 300000, price2: 310000 },
                    { name: "Лущильник 2.6 м. (причіпний)", price1: 420000, price2: 435000 },
                    { name: "Лущильник 3.2 м.", price1: 350000, price2: 360000 },
                    { name: "Лущильник 3.2 м. з тандемним котком", price1: 415000, price2: 425000 },
                    { name: "Лущильник 3.2 м. (причіпний)", price1: 530000, price2: 550000 },
                    { name: "Лущильник 4.2 м. (причіпний)", price1: 750000, price2: 780000 },
                    { name: "Лущильник 5.2 м. (причіпний)", price1: 910000, price2: 960000 },
                    { name: "Причіпний пристрій до ЛН без катків", price1: 130000, price2: 130000 },
                    { name: "Причіпний пристрій до ЛН2.6 з подвійними катками", price1: 190000, price2: 210000 },
                    { name: "Причіпний пристрій до ЛН2.6 з одинарними катками", price1: 165000, price2: 190000 },
                    { name: "Причіпний пристрій до ЛН 3.2 з одинарними катками", price1: 175000, price2: 200000 },
                    { name: "Причіпний пристрій до ЛН3.2 з подвійними катками", price1: 215000, price2: 235000 },
                    { name: "Тандемний (подвійні) котки на ЛН", price1: 65000, price2: 65000 },
                    { name: "Тандемний коток замість одинарного", price1: 40000, price2: 40000 }
                ]
            },
            {
                category: "Борони пружинні",
                items: [
                    { name: "Борона пружинна 6 м. (без опорних коліс)", price1: 130000, price2: 140000 },
                    { name: "Борона пружинна 6 м з колесами (7-ка/10-ка)", price1: 130000, price2: 140000 },
                    { name: "Борона пружинна 9 м. (без опорних коліс)", price1: 150000, price2: 160000 },
                    { name: "Борона пружинна 9 м. + опорні колеса", price1: 160000, price2: 175000 },
                    { name: "Колеса опорні", price1: 35000, price2: 40000 },
                    { name: "Кріплення \"євробалка\" до пружинної борони", price1: 5500, price2: 7000 },
                    { name: "Кріплення \"трьохточка\" до пружинної борони", price1: 8000, price2: 10000 },
                    { name: "Комплект пружин (7-ка/10ка)", price1: 40000, price2: 45000 },
                    { name: "Комплект пружин на трубі (7-ка/10ка)", price1: 65000, price2: 75000 },
                    { name: "Універсальна пружинна борона 9 м", price1: 250000, price2: 270000 }
                ]
            },
           {
                category: "КРНи",
                items: [
                    { name: "КРН 4.2 навісний (міжрядний розкладний)", price1: 290000, price2: 320000 },
                    { name: "КРН 5.6 навісний РОЗКЛАДНА рама (міжрядний)", price1: 320000, price2: 360000 },
                    { name: "КРН 5.6 навісний СУЦІЛЬНА рама (міжрядний)", price1: 250000, price2: 280000 },
                    { name: "КРН 5.6 навісний розкладний з БОЧКОЮ 500л (Під МТЗ, бочка спереду)", price1: 455000, price2: 510000 },
                    { name: "КРН 5.6 навісний розкладний з БОЧКОЮ 500л (бочка на самому КРН)", price1: 420000, price2: 510000 },
                    { name: "КРН 5.6 навісний суцільна рама з БОЧКОЮ 500л", price1: 360000, price2: 395000 },
                    { name: "Захисний щиток рядка", price1: 31000, price2: 35000 },
                    { name: "Бочка для рідких добрив на КРН на раму", price1: 130000, price2: 145000 },
                    { name: "Бочка для рідких добнив на КРН розкладний (з переду трактора)", price1: 145000, price2: 160000 }
                ]
            },
             {
                category: "Глибокорозпушувачі",
                items: [
                    { name: "Глибокорозпушувач 1.8 м.", price1: 350000, price2: 370000 },
                    { name: "Глибокорозпушувач 2.5 м.", price1: 400000, price2: 425000 },
                    { name: "Глибокорозпушувач 3 м. 5 лап", price1: 435000, price2: 450000 },
                    { name: "Глибокорозпушувач 3 м. 7 лап", price1: 490000, price2: 510000 }
                ]
            },
            {
                category: "Відвали",
                items: [
                    { name: "Грейдерний відвал", price1: 58333, price2: 70000 },
                    { name: "Відвал Універсальний (Двосторонній) на СТРІЛУ", price1: 25000, price2: 30000 },
                    { name: "Відвал Універсальний (Двосторонній)", price1: 50000, price2: 60000 },
                    { name: "Відвал Універсальний (Двосторонній) гідро-поворотний", price1: 62500, price2: 75000 },
                    { name: "Відвал Універсальний (Двосторонній) гідро-поворотний EURO", price1: 66667, price2: 80000 },
                    { name: "Відвал для буртування зерна", price1: 29167, price2: 35000 }
                ]
            },
            {
                category: "Зубові борони",
                items: [
                    { name: "Борона зубова 9 м. складна", price1: 390000, price2: 435000 }
                ]
            },
            {
                category: "Крани-маніпулятори",
                items: [
                    { name: "Кран-маніпулятор S-1500", price1: 90000, price2: 100000 },
                    { name: "Кран-маніпулятор SL-2000", price1: 300000, price2: 340000 }
                ]
            },
            {
                category: "БОЧКА КАС 8 куб.",
                items: [
                    { name: "Бочка для внесення добрив 8 куб.", price1: 480000, price2: 550000 }
                ]
            }
        ];

        // --- Стан ---
        let cart = {}; 
        let vatMode_ = 2; // only: 2 = З ПДВ
        let vatDiscount25Active_ = false;
        let adjustmentMode_ = 'minus'; // 'plus' or 'minus'
        let isPercentage_ = false;

        function updateAdjustmentButtons_() {
            const plusBtn = document.getElementById('adjustment-plus');
            const minusBtn = document.getElementById('adjustment-minus');
            const percentBtn = document.getElementById('adjustment-percent');

            if (plusBtn) {
                plusBtn.classList.toggle('bg-green-600', adjustmentMode_ === 'plus');
                plusBtn.classList.toggle('text-white', adjustmentMode_ === 'plus');
                plusBtn.classList.toggle('bg-gray-200', adjustmentMode_ !== 'plus');
                plusBtn.classList.toggle('text-gray-700', adjustmentMode_ !== 'plus');
            }

            if (minusBtn) {
                minusBtn.classList.toggle('bg-red-600', adjustmentMode_ === 'minus');
                minusBtn.classList.toggle('text-white', adjustmentMode_ === 'minus');
                minusBtn.classList.toggle('bg-gray-200', adjustmentMode_ !== 'minus');
                minusBtn.classList.toggle('text-gray-700', adjustmentMode_ !== 'minus');
            }

            if (percentBtn) {
                percentBtn.classList.toggle('bg-blue-600', isPercentage_);
                percentBtn.classList.toggle('text-white', isPercentage_);
                percentBtn.classList.toggle('bg-gray-200', !isPercentage_);
                percentBtn.classList.toggle('text-gray-700', !isPercentage_);
            }
        }
        // --- LocalStorage: persist calculator state across tab switches ---
        const CALC_STATE_KEY_ = 'gm_calc_state_v1';
        let calcSaveTimer_ = null;

        function scheduleCalcSave_() {
            if (calcSaveTimer_) clearTimeout(calcSaveTimer_);
            calcSaveTimer_ = setTimeout(() => {
                calcSaveTimer_ = null;
                saveCalcState_();
            }, 200);
        }

        function saveCalcState_() {
            try {
                const discountEl = document.getElementById('adjustment-input');

                const cartItems = Object.keys(cart).map((k) => {
                    const it = cart[k] || {};
                    return {
                        category: String(it.category || ''),
                        name: String(it.name || ''),
                        type: 2,
                        qty: Math.max(1, Math.floor(Number(it.qty) || 1)),
                        docId: String(it.docId || ''),
                        specialPriceBlue2: Number(it.specialPriceBlue2) || 0,
                        specialPriceRed2: Number(it.specialPriceRed2) || 0,
                        specialTag: String(it.specialTag || ''),
                        basePrice1: Number(it.basePrice1) || 0,
                        basePrice2: Number(it.basePrice2) || 0
                    };
                }).filter(x => x.name);

                const state = {
                    v: 1,
                    t: Date.now(),
                    vatMode: 2,
                    vatDiscount25Active: !!vatDiscount25Active_,
                    adjustmentInput: String(discountEl?.value ?? ''),
                    adjustmentMode: adjustmentMode_,
                    isPercentage: !!isPercentage_,
                    specialUiCartKey: String(specialUiCartKey_ || ''),
                    creditTerm: document.getElementById('creditTerm')?.value || '1',
                    creditAdvance: document.getElementById('creditAdvance')?.value || '',
                    creditAdvanceType: document.getElementById('advanceUah')?.classList.contains('bg-blue-600') ? 'uah' : 'percent',
                    cartItems
                };
                localStorage.setItem(CALC_STATE_KEY_, JSON.stringify(state));
            } catch (e) {}
        }

        function clearCalcState_() {
            try { localStorage.removeItem(CALC_STATE_KEY_); } catch (e) {}
        }

        function readCalcState_() {
            try {
                const raw = localStorage.getItem(CALC_STATE_KEY_);
                const obj = raw ? JSON.parse(raw) : null;
                return obj && typeof obj === 'object' ? obj : null;
            } catch (e) {
                return null;
            }
        }

        function findCatalogItemByRef_(ref) {
            const wantDocId = String(ref?.docId || '');
            const wantCat = String(ref?.category || '');
            const wantName = String(ref?.name || '');
            for (let ci = 0; ci < catalogData.length; ci++) {
                const cat = catalogData[ci];
                if (!cat) continue;
                if (wantCat && String(cat.category) !== wantCat) continue;
                const items = Array.isArray(cat.items) ? cat.items : [];
                for (let ii = 0; ii < items.length; ii++) {
                    const it = items[ii];
                    if (!it) continue;
                    if (wantDocId && it.id && String(it.id) === wantDocId) return { catIdx: ci, itemIdx: ii, cat, item: it };
                    if (wantName && String(it.name) === wantName) return { catIdx: ci, itemIdx: ii, cat, item: it };
                }
            }
            return null;
        }

        function restoreCalcState_() {
            const st = readCalcState_();
            if (!st) return;

            // Inputs
            const adjustmentEl = document.getElementById('adjustment-input');
            if (adjustmentEl) adjustmentEl.value = String(st.adjustmentInput ?? '');

            // VAT / 25% (VAT mode is fixed: only "З ПДВ")
            vatMode_ = 2;
            vatDiscount25Active_ = !!st.vatDiscount25Active;
            adjustmentMode_ = String(st.adjustmentMode || 'minus');
            isPercentage_ = !!st.isPercentage;
            specialUiCartKey_ = String(st.specialUiCartKey || '');
            updateVatToggleUi_();
            updateVat25Ui_();
            updateAdjustmentButtons_();

            // Cart
            cart = {};
            const saved = Array.isArray(st.cartItems) ? st.cartItems : [];
            const enforcedType = 2;
            for (const ref of saved) {
                const found = findCatalogItemByRef_(ref);
                if (!found) continue;

                const id = `${found.catIdx}_${found.itemIdx}`;
                const qty = Math.max(1, Math.floor(Number(ref?.qty) || 1));
                const price1 = Number(found.item.price1);
                const price2 = Number(found.item.price2);
                cart[id] = {
                    name: String(found.item.name),
                    category: String(found.cat.category),
                    docId: found.item.id ? String(found.item.id) : '',
                    price1,
                    price2,
                    type: enforcedType,
                    price: price2,
                    qty,
                    specialPriceBlue2: Number(ref?.specialPriceBlue2) || 0,
                    specialPriceRed2: Number(ref?.specialPriceRed2) || 0,
                    specialTag: String(ref?.specialTag || ''),
                    basePrice1: Number(ref?.basePrice1) || price1,
                    basePrice2: Number(ref?.basePrice2) || price2
                };
            }
            // Credit state
            const creditTermEl = document.getElementById('creditTerm');
            const creditAdvanceEl = document.getElementById('creditAdvance');
            const advanceUahEl = document.getElementById('advanceUah');
            const advancePercentEl = document.getElementById('advancePercent');
            const termTextEl = document.getElementById('termText');
            if (creditTermEl) creditTermEl.value = String(st.creditTerm || '1');
            if (creditAdvanceEl) creditAdvanceEl.value = String(st.creditAdvance || '');
            const advanceType = String(st.creditAdvanceType || 'uah');
            if (advanceUahEl && advancePercentEl) {
                if (advanceType === 'uah') {
                    advanceUahEl.classList.add('bg-blue-600', 'text-white');
                    advanceUahEl.classList.remove('bg-gray-200', 'text-gray-700');
                    advancePercentEl.classList.add('bg-gray-200', 'text-gray-700');
                    advancePercentEl.classList.remove('bg-blue-600', 'text-white');
                } else {
                    advancePercentEl.classList.add('bg-blue-600', 'text-white');
                    advancePercentEl.classList.remove('bg-gray-200', 'text-gray-700');
                    advanceUahEl.classList.add('bg-gray-200', 'text-gray-700');
                    advanceUahEl.classList.remove('bg-blue-600', 'text-white');
                }
            }
            // Update term display
            const termOptions = {
                1: '<span style="font-weight: bold;">1 міс.</span> | Один платіж в кінці',
                2: '<span style="font-weight: bold;">2  міс.</span> | Один платіж в кінці',
                3: '<span style="font-weight: bold;">3  міс.</span> | Один платіж в кінці',
                4: '<span style="font-weight: bold;">4  міс.</span> | Один платіж в кінці',
                5: '<span style="font-weight: bold;">5  міс.</span> | Один платіж в кінці',
                6: '<span style="font-weight: bold;">6  міс.</span> | Один платіж в кінці',
                7: '<span style="font-weight: bold;">7  міс.</span> | Один платіж в кінці',
                8: '<span style="font-weight: bold;">8  міс.</span> | Один платіж в кінці',
                9: '<span style="font-weight: bold;">9  міс.</span> | Один платіж в кінці',
                10: '<span style="font-weight: bold;">10  міс.</span> | Рівними частинами',
                11: '<span style="font-weight: bold;">11  міс.</span> | Рівними частинами',
                12: '<span style="font-weight: bold;">12  міс.</span> | Рівними частинами'
            };
            if (termTextEl) termTextEl.innerHTML = termOptions[creditTermEl?.value] || termOptions[1];
            updateVatToggleUi_();
            syncCatalogActiveStates_();
            calculateTotal();
            updateGeneralXCalcPricesUi_();
        }

        // --- Міні адмін редагування прайсу ---
        // ВАЖЛИВО: Firestore Rules не можуть перевіряти цей пароль.
        // Для запису з цієї сторінки використовується Firebase Auth Email/Password користувач.

        const PRICE_ADMIN_EMAIL = 'price-admin@gm-base.local';
        const PRICE_ADMIN_PASSWORD = '123456';
        let priceEditUnlocked_ = false;
        let priceEditMode_ = false;
        const priceEdits_ = new Map(); // docId -> { price1, price2, sortItem? }
        const categorySortEdits_ = new Map(); // category -> sortCategory|null
        const priceDocSnapshot_ = new Map(); // docId -> { price1, price2, sortItem, category } (current values from catalog)

        // --- Останні зміни (updatedAt) ---
        let priceLastChanges_ = []; // [{ category, name, updatedAt: Date|null, fromPrice1, fromPrice2, toPrice1, toPrice2 }]
        let priceChangesOpen_ = false;

        function tsToDate_(ts) {
            try {
                if (!ts) return null;
                if (typeof ts.toDate === 'function') return ts.toDate();
                if (typeof ts.seconds === 'number') return new Date(ts.seconds * 1000);
                return null;
            } catch (e) {
                return null;
            }
        }

        function formatUaDateTime_(d) {
            if (!d) return '—';
            try {
                return d.toLocaleString('uk-UA');
            } catch (e) {
                return String(d);
            }
        }

        function formatMoney_(n) {
            const v = Number(n);
            if (!Number.isFinite(v)) return '—';
            try {
                return v.toLocaleString('uk-UA');
            } catch (e) {
                return String(v);
            }
        }

        function formatDelta_(from, to) {
            const a = Number(from);
            const b = Number(to);
            if (!Number.isFinite(a) || !Number.isFinite(b)) return '';
            const d = b - a;
            if (!d) return '';
            const sign = d > 0 ? '+' : '';
            return ` (${sign}${formatMoney_(d)})`;
        }

        function updateLastChangesFromPriceDocs_(docs) {
            const list = [];
            for (const d of docs || []) {
                const data = d?.data ? d.data() : d;
                if (!data) continue;
                if (data.active === false) continue;
                const category = String(data.category || '').trim();
                const name = String(data.name || '').trim();
                if (!category || !name) continue;
                const lastChange = data.lastChange && typeof data.lastChange === 'object' ? data.lastChange : null;
                const updatedAt = tsToDate_(lastChange?.at || data.updatedAt);
                // If there is no timestamp, there's no "change" to show.
                if (!updatedAt) continue;
                const toPrice1 = Number(data.price1);
                const toPrice2 = Number(data.price2);
                const fromPrice1 = Number.isFinite(Number(lastChange?.fromPrice1)) ? Number(lastChange.fromPrice1) : null;
                const fromPrice2 = Number.isFinite(Number(lastChange?.fromPrice2)) ? Number(lastChange.fromPrice2) : null;
                const lastToPrice1 = Number.isFinite(Number(lastChange?.toPrice1)) ? Number(lastChange.toPrice1) : (Number.isFinite(toPrice1) ? toPrice1 : null);
                const lastToPrice2 = Number.isFinite(Number(lastChange?.toPrice2)) ? Number(lastChange.toPrice2) : (Number.isFinite(toPrice2) ? toPrice2 : null);
                list.push({ category, name, updatedAt, fromPrice1, fromPrice2, toPrice1: lastToPrice1, toPrice2: lastToPrice2 });
            }
            list.sort((a, b) => {
                const at = a.updatedAt ? a.updatedAt.getTime() : 0;
                const bt = b.updatedAt ? b.updatedAt.getTime() : 0;
                return bt - at;
            });
            priceLastChanges_ = list.slice(0, 20);
        }

        function setChangesUi_() {
            const panel = document.getElementById('priceChangesPanel');
            if (!panel) return;
            panel.classList.toggle('hidden', !priceChangesOpen_);
            if (priceChangesOpen_) renderLastChanges_();
        }

        function renderLastChanges_() {
            const ul = document.getElementById('priceChangesList');
            if (!ul) return;
            ul.innerHTML = '';

            if (!priceLastChanges_.length) {
                const li = document.createElement('li');
                li.className = 'py-2 text-gray-500';
                li.textContent = 'Немає даних. Зміни з\'являться після збереження цін.';
                ul.appendChild(li);
                return;
            }

            for (const it of priceLastChanges_) {
                const li = document.createElement('li');
                li.className = 'py-2 flex items-start justify-between gap-3';

                const hasFrom = Number.isFinite(Number(it.fromPrice1)) || Number.isFinite(Number(it.fromPrice2));
                const p2Line = hasFrom && Number.isFinite(Number(it.fromPrice2))
                    ? `З ПДВ: ${formatMoney_(it.fromPrice2)} → ${formatMoney_(it.toPrice2)}${formatDelta_(it.fromPrice2, it.toPrice2)} грн`
                    : `З ПДВ: ${formatMoney_(it.toPrice2)} грн`;

                li.innerHTML = `
                    <div class="min-w-0">
                        <div class="text-gray-800 font-medium truncate">${it.name}</div>
                        <div class="text-xs text-gray-500 truncate">${it.category}</div>
                        <div class="text-xs text-gray-700 mt-1">${p2Line}</div>
                    </div>
                    <div class="text-xs font-semibold text-gray-700 whitespace-nowrap">${formatUaDateTime_(it.updatedAt)}</div>
                `;
                ul.appendChild(li);
            }
        }

        // --- Ініціалізація ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCatalog();

            // Restore persisted state (must run after initial render so buttons exist).
            restoreCalcState_();

            updateStickyCalcOffset_();
            window.addEventListener('load', updateStickyCalcOffset_);

            const vat25 = document.getElementById('vatDiscount25Btn');
            if (vat25) vat25.addEventListener('click', () => {
                if (!vatDiscount25Active_) {
                    // Toggle ON
                    vatDiscount25Active_ = true;
                    setVatMode_(2, true);
                } else {
                    // Toggle OFF
                    vatDiscount25Active_ = false;
                }
                updateVat25Ui_();
                calculateTotal();
            });
            updateVatToggleUi_();
            updateVat25Ui_();

            // Спробувати підвантажити прайс з Firestore і перерендерити каталог.
            loadCatalogFromFirestore_().then((ok) => {
                if (ok) {
                    renderCatalog();
                    // Re-apply state after catalog potentially changed.
                    restoreCalcState_();
                }
            });

            // Адмін панель
            const editBtn = document.getElementById('priceEditToggle');
            const applyBtn = document.getElementById('priceApplyBtn');
            const addCatBtn = document.getElementById('priceAddCategoryBtn');
            const addItemBtn = document.getElementById('priceAddItemBtn');
            const changesBtn = document.getElementById('priceLastChangesBtn');
            const clearChangesBtn = document.getElementById('priceClearChangesBtn');
            if (editBtn) editBtn.addEventListener('click', onPriceEditToggle_);
            if (applyBtn) applyBtn.addEventListener('click', onPriceApply_);
            if (addCatBtn) addCatBtn.addEventListener('click', onPriceAddCategory_);
            if (addItemBtn) addItemBtn.addEventListener('click', () => onPriceAddItem_(null));
            setAdminUi_();
            if (changesBtn) {
                changesBtn.addEventListener('click', () => {
                    priceChangesOpen_ = !priceChangesOpen_;
                    setChangesUi_();
                });
            }
            if (clearChangesBtn) clearChangesBtn.addEventListener('click', onPriceClearChanges_);
            setChangesUi_();

            window.addEventListener('resize', () => {
                updateStickyCalcOffset_();
            });

            setupCalcFabVisibility_();

            // Adjustment buttons
            const plusBtn = document.getElementById('adjustment-plus');
            const minusBtn = document.getElementById('adjustment-minus');
            const percentBtn = document.getElementById('adjustment-percent');
            const adjustmentInput = document.getElementById('adjustment-input');

            updateAdjustmentButtons_();

            if (plusBtn) plusBtn.addEventListener('click', () => {
                adjustmentMode_ = 'plus';
                updateAdjustmentButtons_();
                calculateTotal();
                scheduleCalcSave_();
            });

            if (minusBtn) minusBtn.addEventListener('click', () => {
                adjustmentMode_ = 'minus';
                updateAdjustmentButtons_();
                calculateTotal();
                scheduleCalcSave_();
            });

            if (percentBtn) percentBtn.addEventListener('click', () => {
                isPercentage_ = !isPercentage_;
                updateAdjustmentButtons_();
                calculateTotal();
                scheduleCalcSave_();
            });

            if (adjustmentInput) adjustmentInput.addEventListener('input', () => {
                calculateTotal();
                scheduleCalcSave_();
            });


            // Credit Comparison Modal
            const creditCompareBtn = document.getElementById('creditCompareBtn');
            const creditCompareModal = document.getElementById('creditCompareModal');
            const closeCreditCompareModal = document.getElementById('closeCreditCompareModal');
            const creditCompareTableBody = document.getElementById('creditCompareTableBody');
            const compareOrderComposition = document.getElementById('compareOrderComposition');
            let activeCompareProgram = 'installments'; // 'installments' or 'deferred'
            // Program switch buttons for comparison
            const compareProgramInstallments = document.getElementById('compareProgramInstallments');
            const compareProgramDeferred = document.getElementById('compareProgramDeferred');
            const containerInstallments = document.getElementById('containerInstallments');
            const containerDeferred = document.getElementById('containerDeferred');
            const installmentsTableBody = document.getElementById('installmentsTableBody');
            const deferredTableBody = document.getElementById('deferredTableBody');


            // --- Modal state snapshot and local logic ---
            let popupBaseTotal = 0;
            let popupAdvanceValue = 0;
            let popupAdvanceUnit = 'uah'; // 'uah' or 'percent'


            function renderInstallmentsTable(advanceAmount, baseTotal) {
                installmentsTableBody.innerHTML = '';
                const rates = {
                    1: 0.025, 2: 0.050, 3: 0.075, 4: 0.100, 5: 0.125, 6: 0.150,
                    7: 0.180, 8: 0.200, 9: 0.225, 10: 0.210, 11: 0.210, 12: 0.210
                };
                const loanPrincipal = baseTotal - advanceAmount;
                let minOverpayment = Infinity;
                let minOverpaymentRow = null;
                for (let month = 1; month <= 12; month++) {
                    const rate = rates[month];
                    const buyerBill = loanPrincipal / (1 - rate);
                    const overpayment = buyerBill - loanPrincipal;
                    const monthly = buyerBill / month;
                    const row = document.createElement('tr');
                    if (overpayment < minOverpayment) {
                        minOverpayment = overpayment;
                        minOverpaymentRow = row;
                    }
                    const termText = `${month} міс.`;
                    const equalPart = `<span class=\"font-bold text-blue-600\">${monthly.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2})} грн</span>`;
                    // Tooltip content
                    const overpaymentPerMonth = Math.round(overpayment / month);
                    const overpaymentPerDay = Math.round(overpayment / (month * 30.42));
                    const tooltip = `Ставка: ${(rate * 100).toFixed(1).replace(/\.0$/, '')}%\nВартість сервісу: ${overpaymentPerMonth} грн / міс\nВартість сервісу: ${overpaymentPerDay} грн / день`;
                    const overpaymentCell = `<span class=\"dotted-underline tooltip-overpay\" title=\"${tooltip}\">${overpayment.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2})} грн</span>`;
                    row.innerHTML = `
                        <td class=\"border border-gray-300 p-2\">${termText}</td>
                        <td class=\"border border-gray-300 p-2 text-right\">${equalPart}</td>
                        <td class=\"border border-gray-300 p-2 text-right\">${buyerBill.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2})} грн</td>
                        <td class=\"border border-gray-300 p-2 text-right\">${overpaymentCell}</td>
                    `;
                    installmentsTableBody.appendChild(row);
                }
                if (minOverpaymentRow) {
                    minOverpaymentRow.classList.add('bg-green-50');
                }
            }

            function renderDeferredTable(advanceAmount, baseTotal) {
                deferredTableBody.innerHTML = '';
                const rates = {
                    1: 0.025, 2: 0.050, 3: 0.075, 4: 0.100, 5: 0.125, 6: 0.150,
                    7: 0.175, 8: 0.200, 9: 0.225, 10: 0.225, 11: 0.225, 12: 0.225
                };
                const loanPrincipal = baseTotal - advanceAmount;
                for (let month = 1; month <= 12; month++) {
                    const rate = rates[month];
                    const buyerBill = loanPrincipal / (1 - rate);
                    const overpayment = buyerBill - loanPrincipal;
                    const row = document.createElement('tr');
                    const termText = `${month} міс.`;
                    const overpaymentPerMonth = Math.round(overpayment / month);
                    const overpaymentPerDay = Math.round(overpayment / (month * 30.42));
                    const tooltip = `Ставка: ${(rate * 100).toFixed(1).replace(/\.0$/, '')}%\nВартість сервісу: ${overpaymentPerMonth} грн / міс\nВартість сервісу: ${overpaymentPerDay} грн / день`;
                    const overpaymentCell = `<span class=\"dotted-underline tooltip-overpay\" title=\"${tooltip}\">${overpayment.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2})} грн</span>`;
                    row.innerHTML = `
                        <td class=\"border border-gray-300 p-2\">${termText}</td>
                        <td class=\"border border-gray-300 p-2 text-right\">${buyerBill.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2})} грн</td>
                        <td class=\"border border-gray-300 p-2 text-right\">${overpaymentCell}</td>
                    `;
                    deferredTableBody.appendChild(row);
                }
            }

            function updateCompareTablesModal() {
                // Calculate advance and loan based on modal state
                let advanceAmount = 0;
                if (popupAdvanceUnit === 'percent') {
                    advanceAmount = Math.round(popupBaseTotal * popupAdvanceValue / 100);
                } else {
                    advanceAmount = Math.round(popupAdvanceValue);
                }
                // Validation: advance cannot exceed base total
                if (advanceAmount > popupBaseTotal) advanceAmount = popupBaseTotal;
                if (advanceAmount < 0) advanceAmount = 0;
                // Update UI fields (safe checks)
                const productTotalEl = document.getElementById('compareProductTotal');
                if (productTotalEl) productTotalEl.value = popupBaseTotal.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';
                const advanceInputEl = document.getElementById('compareAdvanceInput');
                if (advanceInputEl) advanceInputEl.value = popupAdvanceValue;
                const advanceAmountEl = document.getElementById('compareAdvanceAmount');
                if (advanceAmountEl) advanceAmountEl.value = advanceAmount.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';
                const loanAmountEl = document.getElementById('compareLoanAmount');
                if (loanAmountEl) loanAmountEl.value = (popupBaseTotal - advanceAmount).toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';
                // Render tables
                renderInstallmentsTable(advanceAmount, popupBaseTotal);
                renderDeferredTable(advanceAmount, popupBaseTotal);
            }

            // --- Modal event handlers ---
            function openCreditCompareModal() {
                // Take snapshot of current base total
                const finalTotalEl = document.getElementById('final-total');
                popupBaseTotal = finalTotalEl ? parseFloat(finalTotalEl.textContent.replace(/\s|грн/g, '')) || 0 : 0;
                // Reset advance to 0 грн
                popupAdvanceValue = 0;
                popupAdvanceUnit = 'uah';
                // Set UI
                document.getElementById('compareAdvanceInput').value = '';
                document.getElementById('compareAdvanceUnitUah').classList.add('bg-green-600', 'text-white');
                document.getElementById('compareAdvanceUnitPercent').classList.remove('bg-green-600', 'text-white');
                updateCompareTablesModal();
                switchCompareProgram(activeCompareProgram);
                creditCompareModal.classList.remove('hidden');
            }

            if (creditCompareBtn) creditCompareBtn.addEventListener('click', openCreditCompareModal);

            // Advance input listeners
            document.getElementById('compareAdvanceInput').addEventListener('input', function(e) {
                let val = parseFloat(e.target.value.replace(/\s/g, ''));
                if (isNaN(val) || val < 0) val = 0;
                popupAdvanceValue = val;
                updateCompareTablesModal();
            });
            document.getElementById('compareAdvanceUnitUah').addEventListener('click', function() {
                popupAdvanceUnit = 'uah';
                document.getElementById('compareAdvanceUnitUah').classList.add('bg-green-600', 'text-white');
                document.getElementById('compareAdvanceUnitPercent').classList.remove('bg-green-600', 'text-white');
                updateCompareTablesModal();
            });
            document.getElementById('compareAdvanceUnitPercent').addEventListener('click', function() {
                popupAdvanceUnit = 'percent';
                document.getElementById('compareAdvanceUnitPercent').classList.add('bg-green-600', 'text-white');
                document.getElementById('compareAdvanceUnitUah').classList.remove('bg-green-600', 'text-white');
                updateCompareTablesModal();
            });


            function updateCompareTables() {
                // Calculate base total and adjustment
                let baseTotal = 0;
                for (let key in cart) {
                    const item = cart[key];
                    const qty = Math.max(1, Math.floor(Number(item.qty) || 1));
                    baseTotal += item.price * qty;
                }
                const adjustmentEl = document.getElementById('adjustment-input');
                const adjustmentInput = String(adjustmentEl?.value ?? '');
                let adjustmentVal = 0;
                if (adjustmentInput) {
                    const num = parseFloat(adjustmentInput.replace(/\s/g, ''));
                    if (!isNaN(num)) {
                        if (isPercentage_) {
                            adjustmentVal = baseTotal * num / 100;
                        } else {
                            adjustmentVal = num;
                        }
                        if (adjustmentMode_ === 'minus') {
                            adjustmentVal = -adjustmentVal;
                        }
                    }
                }
                const advanceAmount = adjustmentVal < 0 ? -adjustmentVal : 0;
                const baseAmount = document.getElementById('final-total') ? parseFloat(document.getElementById('final-total').textContent.replace(/\s|грн/g, '')) || 0 : 0;

                document.getElementById('compareProductTotal').value = baseTotal.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';
                document.getElementById('compareAdvanceAmount').value = advanceAmount.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';
                document.getElementById('compareLoanAmount').value = baseAmount.toLocaleString('uk-UA', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' грн';

                renderInstallmentsTable(baseAmount, advanceAmount);
                renderDeferredTable(baseAmount, advanceAmount);
            }

            function switchCompareProgram(program) {
                activeCompareProgram = program;
                if (program === 'installments') {
                    compareProgramInstallments.classList.add('bg-blue-600', 'text-white');
                    compareProgramInstallments.classList.remove('bg-gray-200', 'text-gray-700');
                    compareProgramDeferred.classList.add('bg-gray-200', 'text-gray-700');
                    compareProgramDeferred.classList.remove('bg-blue-600', 'text-white');
                    containerInstallments.style.display = '';
                    containerDeferred.style.display = 'none';
                } else {
                    compareProgramDeferred.classList.add('bg-blue-600', 'text-white');
                    compareProgramDeferred.classList.remove('bg-gray-200', 'text-gray-700');
                    compareProgramInstallments.classList.add('bg-gray-200', 'text-gray-700');
                    compareProgramInstallments.classList.remove('bg-blue-600', 'text-white');
                    containerInstallments.style.display = 'none';
                    containerDeferred.style.display = '';
                }
            }


            if (compareProgramInstallments) compareProgramInstallments.addEventListener('click', () => {
                switchCompareProgram('installments');
            });
            if (compareProgramDeferred) compareProgramDeferred.addEventListener('click', () => {
                switchCompareProgram('deferred');
            });

            // Update tables when shared data changes
            document.getElementById('adjustment-input').addEventListener('input', updateCompareTables);
            // If you have other triggers for recalculation, add them here

            const closeCompareModal = () => {
                creditCompareModal.classList.add('hidden');
            };

            if (closeCreditCompareModal) closeCreditCompareModal.addEventListener('click', closeCompareModal);

            creditCompareModal.addEventListener('click', (e) => {
                if (e.target === creditCompareModal) closeCompareModal();
            });
        });

        function setupCalcFabVisibility_() {
            const fab = document.getElementById('calc-fab');
            const discountBlock = document.querySelector('label.text-red-700');
            if (!fab || !discountBlock) return;

            let discountVisible = false;

            const applyVisibility_ = () => {
                fab.classList.toggle('calc-fab--hidden', !!discountVisible);
            };

            if (typeof IntersectionObserver === 'function') {
                const obs = new IntersectionObserver((entries) => {
                    const e = entries && entries[0];
                    discountVisible = !!e && (e.isIntersecting || (typeof e.intersectionRatio === 'number' && e.intersectionRatio > 0));
                    applyVisibility_();
                }, { root: null, threshold: [0, 0.05, 0.15] });
                obs.observe(discountBlock);
                applyVisibility_();
                return;
            }

            // Fallback: scroll handler
            const onScroll = () => {
                const r = discountBlock.getBoundingClientRect();
                const vh = Math.max(1, window.innerHeight || document.documentElement.clientHeight || 1);
                discountVisible = r.top < vh * 0.95 && r.bottom > vh * 0.05;
                applyVisibility_();
            };
            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('resize', onScroll);
            onScroll();
        }

        function updateStickyCalcOffset_() {
            try {
                // Ensure body padding matches the real header height on all viewports.
                const headerAny = document.querySelector('header.header');
                const hh = headerAny ? Math.max(0, Math.round(headerAny.offsetHeight || 0)) : 0;
                const hasVisibleHeader = hh > 0 && !document.documentElement.classList.contains('embed');
                if (hasVisibleHeader) {
                    const extra = 12;
                    document.documentElement.style.setProperty('--header-pad-top', Math.max(0, hh + extra) + 'px');
                } else {
                    // When there's no visible header (e.g. embed), keep 1rem offset from the top.
                    document.documentElement.style.setProperty('--header-pad-top', '16px');
                }

                if (!window.matchMedia('(min-width: 1024px)').matches) return;
                const delivery = document.getElementById('delivery-panel');
                const header = document.querySelector('header.header');

                let stickyTop = 180;
                if (delivery) {
                    const cs = window.getComputedStyle(delivery);
                    const top = parseFloat(cs.top || '0') || 0;
                    const mb = parseFloat(cs.marginBottom || '0') || 0;
                    const h = delivery.offsetHeight || 0;
                    stickyTop = Math.max(0, Math.round(top + h + mb));
                } else if (header) {
                    const h = header.offsetHeight || 0;
                    stickyTop = Math.max(0, Math.round(h + 20));
                }
                document.documentElement.style.setProperty('--sticky-calc-top', stickyTop + 'px');
                document.documentElement.style.setProperty('--sticky-calc-maxh', `calc(100vh - ${stickyTop + 20}px)`);

                // Keep the left catalog aligned with the sticky right column.
                const bodyPadTop = (function () {
                    try {
                        const v = parseFloat(getComputedStyle(document.body).paddingTop || '0');
                        return Number.isFinite(v) ? v : 0;
                    } catch (e) {
                        return 0;
                    }
                })();
                const catPad = Math.max(0, Math.round(stickyTop - bodyPadTop));
                document.documentElement.style.setProperty('--catalog-top-pad', catPad + 'px');
            } catch (e) {
                // ignore
            }
        }

        function renderCatalog() {
            const container = document.getElementById('catalog-container');
            container.innerHTML = '';
            priceDocSnapshot_.clear();
            
            catalogData.forEach((cat, catIdx) => {
                const details = document.createElement('details');
                details.className = "group mb-4 bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200";
                details.setAttribute('data-cat-name', String(cat.category || ''));
                
                const summary = document.createElement('summary');
                summary.className = "flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition";
                const color = categoryColors[catIdx % categoryColors.length];
                summary.innerHTML = `
                    <span class="flex items-center">
                        <div class="w-3 h-3 rounded-full ${color} mr-3"></div>
                        <span class="font-bold text-lg text-gray-800">${cat.category}</span>
                    </span>
                    <span class="cat-actions flex items-center gap-2 justify-end">
                        <span class="chevron text-gray-400"><i class="fas fa-chevron-down"></i></span>
                    </span>
                `;

                if (priceEditMode_) {
                    const actions = summary.querySelector('.cat-actions');

                    const dragBtn = document.createElement('button');
                    dragBtn.type = 'button';
                    dragBtn.className = 'inline-flex items-center justify-center w-9 h-9 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition cursor-move';
                    dragBtn.title = 'Перетягніть, щоб змінити порядок категорій';
                    dragBtn.setAttribute('aria-label', 'Перетягнути категорію');
                    dragBtn.setAttribute('data-cat-drag-handle', String(cat.category || ''));
                    dragBtn.setAttribute('draggable', 'true');
                    dragBtn.innerHTML = '<i class="fas fa-grip-vertical"></i>';

                    const sortVal = categorySortEdits_.has(String(cat.category || ''))
                        ? categorySortEdits_.get(String(cat.category || ''))
                        : (Number.isFinite(Number(cat.sortCategory)) ? Number(cat.sortCategory) : null);

                    const sortInp = document.createElement('input');
                    sortInp.type = 'number';
                    sortInp.inputMode = 'numeric';
                    sortInp.step = '1';
                    sortInp.min = '0';
                    sortInp.value = (sortVal == null ? '' : String(sortVal));
                    sortInp.className = 'w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right outline-none focus:ring-2 focus:ring-gray-300 bg-white';
                    sortInp.title = 'Сортування категорії (менше = вище)';
                    sortInp.setAttribute('aria-label', 'Сортування категорії');
                    sortInp.setAttribute('data-cat-sort', String(cat.category || ''));

                    const delCat = document.createElement('button');
                    delCat.type = 'button';
                    delCat.className = 'inline-flex items-center justify-center w-9 h-9 rounded-lg text-red-600 hover:text-red-700 hover:bg-red-50 transition';
                    delCat.title = 'Видалити категорію';
                    delCat.setAttribute('aria-label', 'Видалити категорію');
                    delCat.innerHTML = '<i class="fas fa-trash"></i>';
                    delCat.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        onPriceDeleteCategory_(String(cat.category || ''));
                    });

                    if (actions) {
                        // Place controls on the right, before the chevron.
                        const chevronEl = actions.querySelector('.chevron');
                        actions.insertBefore(dragBtn, chevronEl);
                        actions.insertBefore(sortInp, chevronEl);
                        actions.insertBefore(delCat, chevronEl);
                    }
                }
                
                const content = document.createElement('div');
                content.className = "p-4 space-y-4";
                
                cat.items.forEach((item, itemIdx) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = "flex flex-col md:flex-row md:justify-between md:items-center border-b border-gray-100 last:border-0 pb-3 last:pb-0 gap-2";
                    itemRow.setAttribute('data-cat-name', String(cat.category || ''));
                    
                    const id = `${catIdx}_${itemIdx}`;

                    const docId = item.id ? String(item.id) : '';
                    const pending = docId && priceEdits_.has(docId) ? priceEdits_.get(docId) : null;
                    const p1 = pending && Number.isFinite(Number(pending.price1)) ? Number(pending.price1) : item.price1;
                    const p2 = pending && Number.isFinite(Number(pending.price2)) ? Number(pending.price2) : item.price2;
                    const sItem = pending && Number.isFinite(Number(pending.sortItem)) ? Number(pending.sortItem) : (Number.isFinite(Number(item.sortItem)) ? Number(item.sortItem) : null);

                    const baseBlue2 = Number.isFinite(Number(item.specialPriceBlue2)) ? Number(item.specialPriceBlue2) : 0;
                    const baseRed2 = Number.isFinite(Number(item.specialPriceRed2)) ? Number(item.specialPriceRed2) : 0;
                    const effBlue2 = (pending && pending.specialPriceBlue2 != null && Number.isFinite(Number(pending.specialPriceBlue2)))
                        ? Number(pending.specialPriceBlue2)
                        : baseBlue2;
                    const effRed2 = (pending && pending.specialPriceRed2 != null && Number.isFinite(Number(pending.specialPriceRed2)))
                        ? Number(pending.specialPriceRed2)
                        : baseRed2;

                    const hasSpecialPrices = effBlue2 > 0 || effRed2 > 0;
                    const discountIcon = hasSpecialPrices ? discountIconHtml_() : '';

                    if (docId && !priceDocSnapshot_.has(docId)) {
                        priceDocSnapshot_.set(docId, {
                            price1: item.price1,
                            price2: item.price2,
                            sortItem: Number.isFinite(Number(item.sortItem)) ? Number(item.sortItem) : null,
                            category: String(cat.category || ''),
                            specialPriceBlue2: baseBlue2,
                            specialPriceRed2: baseRed2,
                        });
                    }
                    
                    if (priceEditMode_) {
                        itemRow.setAttribute('data-doc-id', docId);
                        itemRow.innerHTML = `
                            <div class="font-medium text-gray-700 md:w-1/2 min-w-0 flex items-center gap-2">
                                ${discountIcon}
                                <span class="truncate">${item.name}</span>
                                <button type="button" data-special-edit-select="${docId}" ${docId ? '' : 'disabled'}
                                        class="px-2 py-1 rounded-md text-xs font-bold border border-amber-200 bg-amber-50 text-amber-800 hover:bg-amber-100 transition disabled:opacity-40 disabled:hover:bg-amber-50">
                                    Спец-ціни
                                </button>
                            </div>
                            <div class="flex items-end gap-2 md:w-1/2 justify-end">
                                <button type="button" data-item-drag-handle="${docId}" ${docId ? '' : 'disabled'}
                                        class="inline-flex items-center justify-center w-10 h-10 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition cursor-move disabled:opacity-30 disabled:cursor-not-allowed" title="Перетягнути" aria-label="Перетягнути" draggable="${docId ? 'true' : 'false'}">
                                    <i class="fas fa-grip-vertical"></i>
                                </button>
                                <div class="w-20 border border-gray-300 rounded px-2 py-2 bg-white">
                                    <span class="text-xs text-gray-500 mb-1 block">Сорт</span>
                                    <input data-sort-doc="${docId}" type="number" inputmode="numeric" step="1" min="0"
                                           class="w-full outline-none font-bold text-sm text-right"
                                           value="${sItem == null ? '' : String(sItem)}" ${docId ? '' : 'disabled'} />
                                </div>
                                <div class="w-full md:w-auto border border-gray-300 rounded px-3 py-2 bg-white min-w-[120px]">
                                    <span class="text-xs text-gray-500 mb-1 block">З ПДВ</span>
                                    <input data-price-doc="${docId}" data-price-field="price2" type="number" inputmode="numeric" step="1" min="0"
                                           class="w-full outline-none font-bold text-sm"
                                           value="${Number.isFinite(Number(p2)) ? Number(p2) : ''}" ${docId ? '' : 'disabled'} />
                                </div>
                                <button type="button" data-delete-doc="${docId}" ${docId ? '' : 'disabled'}
                                        class="inline-flex items-center justify-center w-10 h-10 rounded-lg text-red-600 hover:text-red-700 hover:bg-red-50 transition disabled:opacity-30 disabled:hover:bg-transparent" title="Видалити позицію" aria-label="Видалити позицію">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        const active2 = !!(cart[id] && cart[id].type === 2);
                        itemRow.innerHTML = `
                            <div class="font-medium text-gray-700 md:w-1/2 flex items-center gap-2">${discountIcon}<span>${item.name}</span></div>
                            <div class="flex gap-2 md:w-1/2 justify-end">
                                    <button data-item-id="${id}" data-item-type="2" onclick="toggleItem('${id}', '${item.name}', ${item.price1}, ${item.price2}, 2, this, '${item.id ? String(item.id) : ''}', '${cat.category}', ${effBlue2}, ${effRed2})" 
                                            class="price-btn w-full md:w-auto border border-gray-300 rounded px-3 py-2 text-center text-sm hover:bg-gray-50 flex flex-col items-center justify-center min-w-[120px] ${active2 ? 'active' : ''}">
                                    <span class="text-xs text-gray-500 mb-1">З ПДВ</span>
                                    <span class="font-bold">${item.price2.toLocaleString()} грн</span>
                                </button>
                            </div>
                        `;
                    }
                    content.appendChild(itemRow);
                });

                details.appendChild(summary);
                details.appendChild(content);
                container.appendChild(details);
            });

            if (priceEditMode_) {
                container.querySelectorAll('input[data-cat-sort]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const cat = String(el.getAttribute('data-cat-sort') || '').trim();
                        if (!cat) return;

                        const raw = String(el.value ?? '').trim();
                        if (!raw) {
                            categorySortEdits_.set(cat, null);
                            return;
                        }
                        const v = Math.floor(Number(raw));
                        if (!Number.isFinite(v) || v < 0) return;
                        categorySortEdits_.set(cat, v);
                    });
                });

                container.querySelectorAll('input[data-price-doc][data-price-field]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const docId = String(el.getAttribute('data-price-doc') || '');
                        const field = String(el.getAttribute('data-price-field') || '');
                        if (!docId) return;

                        const raw = String(el.value ?? '');
                        const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: '' };
                        const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                        const next = { ...prev };

                        // Empty input = don't overwrite; keep fallback to base on save.
                        if (raw.trim() === '') {
                            if (field === 'price1') next.price1 = null;
                            if (field === 'price2') next.price2 = null;
                            priceEdits_.set(docId, next);
                            return;
                        }

                        const v = Number(raw);
                        if (!Number.isFinite(v) || v < 0) return;
                        if (field === 'price1') next.price1 = v;
                        if (field === 'price2') next.price2 = v;
                        priceEdits_.set(docId, next);
                    });
                });

                container.querySelectorAll('input[data-sort-doc]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const docId = String(el.getAttribute('data-sort-doc') || '');
                        if (!docId) return;

                        const raw = String(el.value ?? '').trim();
                        const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: '' };
                        const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                        const next = { ...prev };

                        if (!raw) {
                            next.sortItem = null;
                            priceEdits_.set(docId, next);
                            return;
                        }

                        const v = Math.floor(Number(raw));
                        if (!Number.isFinite(v) || v < 0) return;
                        next.sortItem = v;
                        priceEdits_.set(docId, next);
                    });
                });

                container.querySelectorAll('button[data-delete-doc]').forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        const el = e.currentTarget;
                        const docId = String(el.getAttribute('data-delete-doc') || '');
                        if (!docId) return;
                        onPriceDeleteItem_(docId);
                    });
                });

                // Select an item in edit mode to reveal/edit its special prices under calculator.
                container.querySelectorAll('button[data-special-edit-select]').forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!priceEditUnlocked_ || !priceEditMode_) return;
                        const docId = String(btn.getAttribute('data-special-edit-select') || '').trim();
                        if (!docId) return;
                        specialEditSelectedDocId_ = (specialEditSelectedDocId_ === docId) ? '' : docId;
                        updateGeneralXCalcPricesUi_();
                    });
                });

                setupDragSort_();
            }
        }

        function moveArrayItem_(arr, fromIndex, toIndex) {
            if (!Array.isArray(arr)) return;
            const from = Number(fromIndex);
            const to = Number(toIndex);
            if (!Number.isInteger(from) || !Number.isInteger(to)) return;
            if (from < 0 || from >= arr.length) return;
            const clampedTo = Math.max(0, Math.min(arr.length - 1, to));
            if (from === clampedTo) return;
            const [it] = arr.splice(from, 1);
            arr.splice(clampedTo, 0, it);
        }

        function applyAutoSortFromCurrentOrder_() {
            // Categories
            const step = 10;
            for (let i = 0; i < catalogData.length; i++) {
                const cat = catalogData[i];
                const name = String(cat?.category || '').trim();
                if (!name) continue;
                const v = (i + 1) * step;
                categorySortEdits_.set(name, v);
                cat.sortCategory = v;

                // Items
                const items = Array.isArray(cat.items) ? cat.items : [];
                for (let j = 0; j < items.length; j++) {
                    const item = items[j];
                    const docId = String(item?.id || '').trim();
                    const iv = (j + 1) * step;
                    item.sortItem = iv;
                    if (!docId) continue;
                    const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: name };
                    const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                    priceEdits_.set(docId, { ...prev, sortItem: iv });
                }
            }
        }

        function setupDragSort_() {
            const container = document.getElementById('catalog-container');
            if (!container) return;

            const dragState = window.__gmPriceDragState || (window.__gmPriceDragState = { type: null, cat: null, docId: null });

            // --- Categories ---
            container.querySelectorAll('button[data-cat-drag-handle]').forEach((h) => {
                h.addEventListener('click', (e) => {
                    // Prevent toggling the <details> when clicking the handle.
                    e.preventDefault();
                    e.stopPropagation();
                });
                h.addEventListener('dragstart', (e) => {
                    const cat = String(h.getAttribute('data-cat-drag-handle') || '').trim();
                    if (!cat) return;
                    dragState.type = 'cat';
                    dragState.cat = cat;
                    dragState.docId = null;
                    try {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'cat:' + cat);
                    } catch (err) {}
                });
            });

            container.querySelectorAll('details[data-cat-name]').forEach((d) => {
                d.addEventListener('dragover', (e) => {
                    if (dragState.type !== 'cat') return;
                    e.preventDefault();
                    d.classList.add('ring-2', 'ring-blue-300');
                });
                d.addEventListener('dragleave', () => {
                    d.classList.remove('ring-2', 'ring-blue-300');
                });
                d.addEventListener('drop', (e) => {
                    if (dragState.type !== 'cat') return;
                    e.preventDefault();
                    d.classList.remove('ring-2', 'ring-blue-300');
                    const fromCat = String(dragState.cat || '').trim();
                    const toCat = String(d.getAttribute('data-cat-name') || '').trim();
                    if (!fromCat || !toCat || fromCat === toCat) return;

                    const fromIndex = catalogData.findIndex((c) => String(c?.category || '').trim() === fromCat);
                    const toIndex = catalogData.findIndex((c) => String(c?.category || '').trim() === toCat);
                    if (fromIndex < 0 || toIndex < 0) return;

                    moveArrayItem_(catalogData, fromIndex, toIndex);
                    applyAutoSortFromCurrentOrder_();
                    renderCatalog();
                });
            });

            // --- Items ---
            container.querySelectorAll('button[data-item-drag-handle]').forEach((h) => {
                h.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                h.addEventListener('dragstart', (e) => {
                    const docId = String(h.getAttribute('data-item-drag-handle') || '').trim();
                    if (!docId) return;
                    dragState.type = 'item';
                    dragState.docId = docId;
                    dragState.cat = null;
                    try {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'item:' + docId);
                    } catch (err) {}
                });
            });

            container.querySelectorAll('div[data-doc-id][data-cat-name]').forEach((row) => {
                row.addEventListener('dragover', (e) => {
                    if (dragState.type !== 'item') return;
                    const docId = String(row.getAttribute('data-doc-id') || '').trim();
                    if (!docId) return;
                    e.preventDefault();
                    row.classList.add('ring-2', 'ring-blue-200');
                });
                row.addEventListener('dragleave', () => {
                    row.classList.remove('ring-2', 'ring-blue-200');
                });
                row.addEventListener('drop', (e) => {
                    if (dragState.type !== 'item') return;
                    e.preventDefault();
                    row.classList.remove('ring-2', 'ring-blue-200');

                    const fromDocId = String(dragState.docId || '').trim();
                    const toDocId = String(row.getAttribute('data-doc-id') || '').trim();
                    const catName = String(row.getAttribute('data-cat-name') || '').trim();
                    if (!fromDocId || !toDocId || !catName || fromDocId === toDocId) return;

                    const cat = catalogData.find((c) => String(c?.category || '').trim() === catName);
                    const items = cat && Array.isArray(cat.items) ? cat.items : null;
                    if (!items) return;

                    const fromIndex = items.findIndex((it) => String(it?.id || '').trim() === fromDocId);
                    const targetIndex = items.findIndex((it) => String(it?.id || '').trim() === toDocId);
                    if (fromIndex < 0 || targetIndex < 0) return;

                    const r = row.getBoundingClientRect();
                    const after = e.clientY > (r.top + r.height / 2);
                    let toIndex = after ? (targetIndex + 1) : targetIndex;
                    if (fromIndex < toIndex) toIndex -= 1;
                    toIndex = Math.max(0, Math.min(items.length - 1, toIndex));

                    moveArrayItem_(items, fromIndex, toIndex);
                    applyAutoSortFromCurrentOrder_();
                    renderCatalog();
                });
            });
        }

        function toggleItem(id, name, price1, price2, type, btn, docId, category, specialPriceBlue2, specialPriceRed2) {
            const targetType = 2; // fixed: only "З ПДВ"
            const exists = cart[id];

            const keysNow = Object.keys(cart);
            const cartTypeNow = keysNow.length ? (Number(cart[keysNow[0]]?.type) === 2 ? 2 : 1) : null;

            if (exists) {
                // Ensure we have both prices stored for switching.
                if (!Number.isFinite(Number(exists.price1))) exists.price1 = Number(price1);
                if (!Number.isFinite(Number(exists.price2))) exists.price2 = Number(price2);

                // Same type click => toggle off (remove)
                if (Number(exists.type) === targetType) {
                    delete cart[id];
                    if (specialUiCartKey_ === id) specialUiCartKey_ = '';
                    syncCatalogActiveStates_();
                    calculateTotal();
                    return;
                }

                // Different type click => do NOT convert other items.
                // Enforce single VAT mode: clear previous selections, then select this item in requested mode.
                cart = {};
                setVatMode_(targetType, false);
                cart[id] = {
                    name,
                    category: String(category || ''),
                    docId: String(docId || ''),
                    price1,
                    price2,
                    type: targetType,
                    price: price2,
                    qty: Math.max(1, Math.floor(Number(exists?.qty) || 1)),
                    basePrice1: Number(price1),
                    basePrice2: Number(price2),
                    specialPriceBlue2: Number.isFinite(Number(specialPriceBlue2)) ? Number(specialPriceBlue2) : 0,
                    specialPriceRed2: Number.isFinite(Number(specialPriceRed2)) ? Number(specialPriceRed2) : 0,
                    specialTag: null,
                };
                specialUiCartKey_ = id;
                syncCatalogActiveStates_();
                calculateTotal();
                scheduleCalcSave_();
                return;
            }

            // New selection: enforce single VAT mode.
            // If user selects a different VAT type than the current cart type, turn off previous items.
            if (cartTypeNow != null && cartTypeNow !== targetType) {
                cart = {};
                syncCatalogActiveStates_();
            }
            if (vatMode_ !== targetType) {
                setVatMode_(targetType, false);
            }

            const prevQty = Number.isFinite(Number(cart[id]?.qty)) ? Number(cart[id].qty) : 1;
            cart[id] = {
                name,
                category: String(category || ''),
                docId: String(docId || ''),
                price1,
                price2,
                type: targetType,
                price: price2,
                qty: Math.max(1, Math.floor(prevQty)),
                basePrice1: Number(price1),
                basePrice2: Number(price2),
                specialPriceBlue2: Number.isFinite(Number(specialPriceBlue2)) ? Number(specialPriceBlue2) : 0,
                specialPriceRed2: Number.isFinite(Number(specialPriceRed2)) ? Number(specialPriceRed2) : 0,
                specialTag: null,
            };
            specialUiCartKey_ = id;
            syncCatalogActiveStates_();
            calculateTotal();
            scheduleCalcSave_();
        }

        function computePrice1FromVatPrice_(price2) {
            const p2 = Number(price2);
            if (!Number.isFinite(p2)) return 0;
            return Math.round(p2 / 1.2);
        }

        function findSelectedCartKeyForSpecialPrices_() {
            if (specialUiCartKey_ && cart[specialUiCartKey_]) return specialUiCartKey_;
            const keys = Object.keys(cart);
            if (keys.length === 1) return keys[0];
            return null;
        }

        function findItemByDocId_(docId) {
            const id = String(docId || '').trim();
            if (!id) return null;
            for (const c of catalogData) {
                const items = c && Array.isArray(c.items) ? c.items : [];
                const hit = items.find((it) => String(it?.id || '') === id);
                if (hit) return hit;
            }
            return null;
        }

        function getEffectiveSpecialPricesForDocId_(docId) {
            const base = priceDocSnapshot_.get(String(docId)) || { specialPriceBlue2: 0, specialPriceRed2: 0 };
            const pending = priceEdits_.get(String(docId)) || {};
            const blue = (pending.specialPriceBlue2 != null && Number.isFinite(Number(pending.specialPriceBlue2)))
                ? Number(pending.specialPriceBlue2)
                : Number(base.specialPriceBlue2) || 0;
            const red = (pending.specialPriceRed2 != null && Number.isFinite(Number(pending.specialPriceRed2)))
                ? Number(pending.specialPriceRed2)
                : Number(base.specialPriceRed2) || 0;
            return { blue, red };
        }

        function toggleSelectedItemSpecialPrice_(tag) {
            const key = findSelectedCartKeyForSpecialPrices_();
            if (!key) return;
            toggleItemSpecialPriceForKey(tag, key);
        }

        // Toggle special price for a specific cart key (supports multiple special-priced items).
        function toggleItemSpecialPriceForKey(tag, key) {
            if (!key || !cart[key]) return;
            const it = cart[key];

            const blue2 = Number(it.specialPriceBlue2) || 0;
            const red2 = Number(it.specialPriceRed2) || 0;

            const nextP2 = Number(tag === 'red' ? red2 : blue2);
            if (!Number.isFinite(nextP2) || nextP2 <= 0) return;

            if (!Number.isFinite(Number(it.basePrice2))) it.basePrice2 = Number(it.price2);
            if (!Number.isFinite(Number(it.basePrice1))) it.basePrice1 = Number(it.price1);

            if (String(it.specialTag || '') === String(tag)) {
                const bp2 = Number(it.basePrice2);
                const bp1 = Number(it.basePrice1);
                if (Number.isFinite(bp2)) {
                    it.price2 = bp2;
                    it.price = bp2;
                }
                if (Number.isFinite(bp1)) it.price1 = bp1;
                it.specialTag = null;
            } else {
                it.price2 = nextP2;
                it.price1 = computePrice1FromVatPrice_(nextP2);
                it.price = nextP2;
                it.specialTag = tag;
            }

            calculateTotal();
            scheduleCalcSave_();
        }

        // Quick inline edit for per-cart-item special price (affects calculator immediately).
        function editCartItemSpecialPrice(key, tag) {
            if (!key || !cart[key]) return;
            const it = cart[key];
            const prop = tag === 'red' ? 'specialPriceRed2' : 'specialPriceBlue2';
            const current = Number(it[prop]) || 0;
            const raw = prompt('Нова спец-ціна (грн)', String(Math.round(current || 0)));
            if (raw == null) return;
            const v = parsePriceNumber_(raw);
            if (!Number.isFinite(v) || v < 0) return;
            it[prop] = v;
            updateGeneralXCalcPricesUi_();
            scheduleCalcSave_();
        }

        function updateGeneralXCalcPricesUi_() {
            const wrap = document.getElementById('generalXCalcPrices');
            if (!wrap) return;

            const editDocId = (priceEditUnlocked_ && priceEditMode_) ? String(specialEditSelectedDocId_ || '').trim() : '';
            const editItem = editDocId ? findItemByDocId_(editDocId) : null;
            const editName = editItem ? String(editItem.name || '') : '';
            const effEdit = editDocId ? getEffectiveSpecialPricesForDocId_(editDocId) : { blue: 0, red: 0 };

            const cartSpecialKeys = Object.keys(cart).filter((k) => {
                const it = cart[k];
                return !!(it && (Number(it.specialPriceBlue2) > 0 || Number(it.specialPriceRed2) > 0));
            });
            const showInCart = cartSpecialKeys.length > 0;
            const showInEdit = !!(priceEditUnlocked_ && priceEditMode_ && editDocId);

            wrap.classList.toggle('hidden', !(showInCart || showInEdit));
            if (!(showInCart || showInEdit)) return;

            // Keep existing edit block; render dynamic list of cart special-priced items in a dedicated container.
            const listId = 'generalXCalcPricesList';
            let list = document.getElementById(listId);
            if (!list) {
                list = document.createElement('div');
                list.id = listId;
                list.className = 'space-y-2 mt-2';
                const editWrap = document.getElementById('generalXCalcPricesEdit');
                if (editWrap) wrap.insertBefore(list, editWrap);
                else wrap.appendChild(list);
            }
            list.innerHTML = '';

            // Helper to create button element
            function createBtn(label, cls, onClick) {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = cls;
                b.textContent = label;
                b.setAttribute('onclick', onClick);
                return b;
            }

            if (showInCart) {
                for (const key of cartSpecialKeys) {
                    const it = cart[key];
                    const blueVal = Math.round(Number(it.specialPriceBlue2) || 0);
                    const redVal = Math.round(Number(it.specialPriceRed2) || 0);
                    const current = Math.round(Number(it.price2) || 0);


                    const row = document.createElement('div');
                    row.className = 'flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-100 w-full';

                    const left = document.createElement('div');
                    left.className = 'w-full text-sm font-semibold text-slate-800 mb-2';
                    left.textContent = String(it.name || '');

                    const middle = document.createElement('div');
                    middle.className = 'w-full flex flex-row flex-wrap items-center gap-2 mb-2';

                    if (blueVal > 0) {
                        const isActiveBlue = it.specialTag === 'blue';
                        const b = createBtn(
                            blueVal.toLocaleString('uk-UA'),
                            'inline-flex items-center justify-center px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition' + (isActiveBlue ? ' ring-2 ring-blue-400 ring-offset-2' : ''),
                            `toggleItemSpecialPriceForKey('blue','${key}')`
                        );
                        if (isActiveBlue) b.classList.add('active');
                        middle.appendChild(b);
                        // Only show inline edit for admins in edit mode
                        if (priceEditUnlocked_ && priceEditMode_) {
                            const eb = createBtn('Ред.', 'ml-1 text-xs px-2 py-1 border rounded hover:bg-gray-100', `editCartItemSpecialPrice('${key}','blue')`);
                            middle.appendChild(eb);
                        }
                    }

                    if (redVal > 0) {
                        const isActiveRed = it.specialTag === 'red';
                        const r = createBtn(
                            redVal.toLocaleString('uk-UA'),
                            'inline-flex items-center justify-center px-3 py-1 rounded-lg bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition' + (isActiveRed ? ' ring-2 ring-red-400 ring-offset-2' : ''),
                            `toggleItemSpecialPriceForKey('red','${key}')`
                        );
                        if (isActiveRed) r.classList.add('active');
                        middle.appendChild(r);
                        // Only show inline edit for admins in edit mode
                        if (priceEditUnlocked_ && priceEditMode_) {
                            const er = createBtn('Ред.', 'ml-1 text-xs px-2 py-1 border rounded hover:bg-gray-100', `editCartItemSpecialPrice('${key}','red')`);
                            middle.appendChild(er);
                        }
                    }

                    const right = document.createElement('div');
                    right.className = 'w-full text-xs text-slate-600';
                    right.textContent = Number.isFinite(current) ? `Поточна: ${current.toLocaleString('uk-UA')} грн` : '';

                    row.appendChild(left);
                    row.appendChild(middle);
                    row.appendChild(right);
                    list.appendChild(row);
                }
            }

            // Update edit block visibility and inputs
            const editWrap = document.getElementById('generalXCalcPricesEdit');
            if (editWrap) editWrap.classList.toggle('hidden', !showInEdit);
            if (showInEdit) {
                const blueInp = document.getElementById('generalXBluePriceInput');
                const redInp = document.getElementById('generalXRedPriceInput');
                if (blueInp && document.activeElement !== blueInp) blueInp.value = String(Math.round(Number(effEdit.blue) || 0));
                if (redInp && document.activeElement !== redInp) redInp.value = String(Math.round(Number(effEdit.red) || 0));
                const nameEl = document.getElementById('specialPricesItemName');
                if (nameEl) nameEl.textContent = editName;
            } else {
                const nameEl = document.getElementById('specialPricesItemName');
                if (nameEl) nameEl.textContent = '';
            }
        }

        function setVatMode_(mode, applyToCart) {
            vatMode_ = 2;
            updateVatToggleUi_();
            updateVat25Ui_();
            if (applyToCart) {
                for (const k of Object.keys(cart)) {
                    const it = cart[k];
                    it.type = vatMode_;
                    const p1 = Number(it.price1);
                    const p2 = Number(it.price2);
                    it.price = Number.isFinite(p2) ? p2 : (Number.isFinite(p1) ? p1 * 1.2 : 0);
                }
                syncCatalogActiveStates_();
            }
            scheduleCalcSave_();
        }

        function computeC2WithVat_() {
            // C2 = total price with VAT for goods (sum of price2 * qty)
            let c2 = 0;
            for (const k of Object.keys(cart)) {
                const it = cart[k];
                const qty = Math.max(1, Math.floor(Number(it?.qty) || 1));
                const p2 = Number(it?.price2);
                const p1 = Number(it?.price1);
                const priceWithVat = Number.isFinite(p2) ? p2 : (Number.isFinite(p1) ? p1 * 1.2 : 0);
                c2 += priceWithVat * qty;
            }
            return c2;
        }

        function updateVat25Ui_() {
            const btn = document.getElementById('vatDiscount25Btn');
            if (!btn) return;

            // Inactive: blue. Active: amber + ring (high visibility).
            btn.classList.toggle('bg-blue-600', !vatDiscount25Active_);
            btn.classList.toggle('hover:bg-blue-700', !vatDiscount25Active_);
            btn.classList.toggle('bg-amber-500', vatDiscount25Active_);
            btn.classList.toggle('hover:bg-amber-600', vatDiscount25Active_);
            btn.classList.toggle('ring-2', vatDiscount25Active_);
            btn.classList.toggle('ring-amber-300', vatDiscount25Active_);
            btn.classList.toggle('ring-offset-1', vatDiscount25Active_);

            btn.setAttribute('aria-pressed', vatDiscount25Active_ ? 'true' : 'false');
        }

        function updateVatToggleUi_() {
            // VAT mode toggle UI was removed; mode is fixed to "З ПДВ".
            vatMode_ = 2;
        }

        function syncCatalogActiveStates_() {
            document.querySelectorAll('.price-btn[data-item-id][data-item-type]').forEach((b) => {
                const id = String(b.getAttribute('data-item-id') || '');
                const t = Number(b.getAttribute('data-item-type'));
                const isActive = !!(id && cart[id] && cart[id].type === t);
                b.classList.toggle('active', isActive);
            });
        }

        function setAdminUi_() {
            const controls = document.getElementById('priceAdminControls');
            const label = document.getElementById('priceEditModeLabel');
            if (controls) controls.classList.toggle('hidden', !priceEditMode_);
            if (label) label.classList.toggle('hidden', !priceEditMode_);

            if (!priceEditMode_) {
                specialEditSelectedDocId_ = '';
            }

            // Clear-history button is admin-only and only in edit mode.
            const clearBtn = document.getElementById('priceClearChangesBtn');
            if (clearBtn) clearBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));

            const addCatBtn = document.getElementById('priceAddCategoryBtn');
            const addItemBtn = document.getElementById('priceAddItemBtn');
            if (addCatBtn) addCatBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));
            if (addItemBtn) addItemBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));

            updateGeneralXCalcPricesUi_();
        }

        async function onPriceEditToggle_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            priceEditMode_ = !priceEditMode_;
            if (priceEditMode_) {
                // Hide special prices until user selects an item in edit mode.
                specialEditSelectedDocId_ = '';
            }
            setAdminUi_();
            renderCatalog();
        }

        async function ensurePriceAdmin_() {
            if (priceEditUnlocked_) return true;

            const pass = prompt('Пароль для редагування прайсу');
            if (pass !== PRICE_ADMIN_PASSWORD) {
                alert('Невірний пароль');
                return false;
            }

            // Sign in as price admin (Email/Password) so Firestore Rules can allow write securely.
            try {
                const api = await initFirebaseForPrice_();
                if (!api?.auth || !api?.authMod?.signInWithEmailAndPassword) {
                    throw new Error('Firebase Auth not available');
                }
                await api.authMod.signInWithEmailAndPassword(api.auth, PRICE_ADMIN_EMAIL, pass);
                console.info('[calc] price admin signed in');
            } catch (e) {
                console.warn('[calc] price admin sign-in failed', e);
                alert('Не вдалося отримати доступ до запису. Створи користувача Email/Password у Firebase Auth з email: ' + PRICE_ADMIN_EMAIL + ' та паролем 123456.');
               
                return false;
            }

            priceEditUnlocked_ = true;
            setAdminUi_();
            return true;
        }

        async function onPriceClearChanges_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const sure = confirm('Очистити історію змін? Це прибере lastChange/updatedAt у всіх позицій прайсу.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) {
                    alert('Немає даних');
                    return;
                }

                const docs = snap.docs;
                let done = 0;
                for (let i = 0; i < docs.length; i += 450) {
                    const chunk = docs.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);
                    for (const d of chunk) {
                        const ref = api.doc(api.db, 'priceItems', String(d.id));
                        batch.update(ref, {
                            lastChange: api.deleteField(),
                            updatedAt: api.deleteField(),
                        });
                    }
                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] cleared price change history', done, '/', docs.length);
                }

                // Refresh local state
                priceLastChanges_ = [];
                if (priceChangesOpen_) renderLastChanges_();
                await loadCatalogFromFirestore_();
                renderCatalog();
                alert('Історію змін очищено');
            } catch (e) {
                console.warn('[calc] clear price change history failed', e);
                alert('Не вдалося очистити. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceApply_() {
            if (!priceEditUnlocked_ || !priceEditMode_) return;
            if (!priceEdits_.size && !categorySortEdits_.size) {
                alert('Немає змін');
                return;
            }

            // UX: after clicking Save, immediately exit edit mode.
            priceEditMode_ = false;
            setAdminUi_();
            renderCatalog();

            try {
                const api = await initFirebaseForPrice_();
                const updates = Array.from(priceEdits_.entries());
                let done = 0;

                for (let i = 0; i < updates.length; i += 450) {
                    const chunk = updates.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);

                    for (const [docId, v] of chunk) {
                        const base = priceDocSnapshot_.get(String(docId)) || { price1: null, price2: null, sortItem: null, category: '', specialPriceBlue2: 0, specialPriceRed2: 0 };
                        const p1 = v?.price1 == null ? Number(base.price1) : Number(v.price1);
                        const p2 = v?.price2 == null ? Number(base.price2) : Number(v.price2);
                        if (!Number.isFinite(p1) || !Number.isFinite(p2)) continue;
                        const sortItem = v?.sortItem == null ? null : Number(v.sortItem);

                        const spBlue2 = v?.specialPriceBlue2 == null ? Number(base.specialPriceBlue2) : Number(v.specialPriceBlue2);
                        const spRed2 = v?.specialPriceRed2 == null ? Number(base.specialPriceRed2) : Number(v.specialPriceRed2);

                        const ref = api.doc(api.db, 'priceItems', String(docId));
                        const from1 = Number(base.price1);
                        const from2 = Number(base.price2);
                        const payload = {
                            price1: p1,
                            price2: p2,
                            specialPriceBlue2: Number.isFinite(spBlue2) ? spBlue2 : 0,
                            specialPriceRed2: Number.isFinite(spRed2) ? spRed2 : 0,
                            ...(sortItem == null ? { sortItem: api.deleteField() } : { sortItem }),
                            updatedAt: api.serverTimestamp(),
                            lastChange: {
                                at: api.serverTimestamp(),
                                fromPrice1: Number.isFinite(from1) ? from1 : null,
                                fromPrice2: Number.isFinite(from2) ? from2 : null,
                                toPrice1: p1,
                                toPrice2: p2,
                            }
                        };
                        batch.set(ref, payload, { merge: true });
                    }

                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] priceItems updated', done, '/', updates.length);
                }

                // Apply category sorting (set sortCategory on all docs within the category).
                if (categorySortEdits_.size) {
                    const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                    const allDocs = snap && snap.docs ? snap.docs : [];
                    const edits = Array.from(categorySortEdits_.entries());
                    for (const [catName, sortCategory] of edits) {
                        const cat = String(catName || '').trim();
                        if (!cat) continue;

                        const docs = allDocs.filter((d) => {
                            const data = d && typeof d.data === 'function' ? d.data() : null;
                            if (!data) return false;
                            if (data.active === false) return false;
                            return String(data.category || '').trim() === cat;
                        });
                        if (!docs.length) continue;

                        for (let i = 0; i < docs.length; i += 450) {
                            const chunk = docs.slice(i, i + 450);
                            const batch = api.writeBatch(api.db);
                            for (const d of chunk) {
                                const ref = api.doc(api.db, 'priceItems', String(d.id));
                                batch.set(ref, {
                                    sortCategory: sortCategory == null ? api.deleteField() : Number(sortCategory),
                                    updatedAt: api.serverTimestamp(),
                                }, { merge: true });
                            }
                            await batch.commit();
                        }
                    }
                }

                priceEdits_.clear();
                categorySortEdits_.clear();
                await loadCatalogFromFirestore_();
                renderCatalog();
                alert('Збережено');
            } catch (e) {
                console.warn('[calc] apply price edits failed', e);
                // Restore edit mode so the user can retry without losing inputs.
                priceEditMode_ = true;
                setAdminUi_();
                renderCatalog();
                alert('Не вдалося зберегти. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        function parsePriceNumber_(raw) {
            const s = String(raw ?? '').trim();
            if (!s) return NaN;
            const cleaned = s.replace(/\s+/g, '').replace(',', '.');
            const v = Number(cleaned);
            return Number.isFinite(v) ? v : NaN;
        }

        function computeNetFromVat_(price2) {
            const p2 = Number(price2);
            if (!Number.isFinite(p2)) return NaN;
            return Math.round(p2 / 1.2);
        }

        function getActiveDocIdSet_() {
            const s = new Set();
            for (const c of (Array.isArray(catalogData) ? catalogData : [])) {
                const items = Array.isArray(c?.items) ? c.items : [];
                for (const it of items) {
                    if (it && it.id) s.add(String(it.id));
                }
            }
            return s;
        }

        function purgeCartByDocIdSet_(allowedDocIds) {
            if (!allowedDocIds || typeof allowedDocIds.has !== 'function') return;
            let changed = false;
            for (const k of Object.keys(cart)) {
                const docId = String(cart[k]?.docId || '');
                if (docId && !allowedDocIds.has(docId)) {
                    delete cart[k];
                    changed = true;
                }
            }
            if (changed) {
                calculateTotal();
                scheduleCalcSave_();
            }
        }

        async function onPriceAddCategory_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const cat = prompt('Назва нової категорії');
            if (!cat || !cat.trim()) return;

            // Category exists only through items, so we add the first item immediately.
            await onPriceAddItem_(String(cat).trim());
        }

        async function onPriceAddItem_(prefillCategory) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            if (!priceEditMode_) {
                priceEditMode_ = true;
                setAdminUi_();
                renderCatalog();
            }

            const cats = (Array.isArray(catalogData) ? catalogData : []).map((c) => String(c?.category || '')).filter(Boolean);
            const defaultCat = prefillCategory || cats[0] || '';
            const cat = prompt('Категорія (можна ввести нову)\n\nІснуючі: ' + (cats.join(', ') || '—'), defaultCat);
            if (!cat || !cat.trim()) return;

            const name = prompt('Назва позиції', 'Нова позиція');
            if (!name || !name.trim()) return;

            const p2Raw = prompt('Ціна З ПДВ (грн)', '0');
            if (p2Raw == null) return;
            const p2 = Math.round(parsePriceNumber_(p2Raw));
            if (!Number.isFinite(p2) || p2 < 0) {
                alert('Некоректна ціна');
                return;
            }
            const p1 = computeNetFromVat_(p2);
            if (!Number.isFinite(p1) || p1 < 0) {
                alert('Не вдалося розрахувати базову ціну');
                return;
            }

            try {
                const api = await initFirebaseForPrice_();
                const col = api.collection(api.db, 'priceItems');
                if (!api.addDoc) throw new Error('Firestore addDoc not available');
                await api.addDoc(col, {
                    category: String(cat).trim(),
                    name: String(name).trim(),
                    price1: p1,
                    price2: p2,
                    active: true,
                    updatedAt: api.serverTimestamp(),
                    lastChange: {
                        at: api.serverTimestamp(),
                        fromPrice1: null,
                        fromPrice2: null,
                        toPrice1: p1,
                        toPrice2: p2,
                    }
                });

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] add price item failed', e);
                alert('Не вдалося додати позицію. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceDeleteItem_(docId) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const sure = confirm('Видалити позицію? Вона зникне з прайсу.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const ref = api.doc(api.db, 'priceItems', String(docId));
                if (!api.setDoc) throw new Error('Firestore setDoc not available');
                await api.setDoc(ref, {
                    active: false,
                    updatedAt: api.serverTimestamp(),
                }, { merge: true });

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] delete price item failed', e);
                alert('Не вдалося видалити. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceDeleteCategory_(categoryName) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const cat = String(categoryName || '').trim();
            if (!cat) return;

            const sure = confirm('Видалити категорію "' + cat + '"? Це прибере всі позиції в цій категорії.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) {
                    alert('Немає даних');
                    return;
                }

                const docs = snap.docs.filter((d) => {
                    const data = d && typeof d.data === 'function' ? d.data() : null;
                    if (!data) return false;
                    if (data.active === false) return false;
                    return String(data.category || '').trim() === cat;
                });

                if (!docs.length) {
                    alert('У категорії немає активних позицій');
                    return;
                }

                let done = 0;
                for (let i = 0; i < docs.length; i += 450) {
                    const chunk = docs.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);
                    for (const d of chunk) {
                        const ref = api.doc(api.db, 'priceItems', String(d.id));
                        batch.set(ref, {
                            active: false,
                            updatedAt: api.serverTimestamp(),
                        }, { merge: true });
                    }
                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] category deactivated', cat, done, '/', docs.length);
                }

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] delete category failed', e);
                alert('Не вдалося видалити категорію. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        function parseInput(val, total) {
            if (!val) return 0;
            val = val.trim();
            if (val.includes('%')) {
                const percent = parseFloat(val.replace('%', ''));
                return isNaN(percent) ? 0 : (total * percent / 100);
            }
            const num = parseFloat(val.replace(/\s/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function calculateTotal() {
            let itemsTotal = 0;
            const receiptItemsContainer = document.getElementById('receipt-items');
            receiptItemsContainer.innerHTML = '';
            
            if (Object.keys(cart).length === 0) {
                receiptItemsContainer.innerHTML = '<div class="text-center text-gray-400 italic">Товари не обрані</div>';
                resetCreditState_();
            }

            for (let key in cart) {
                const item = cart[key];
                const qty = Math.max(1, Math.floor(Number(item.qty) || 1));
                item.qty = qty;

                // If a special price was removed (set to 0), force-toggle it off.
                const spTag = String(item.specialTag || '');
                if (spTag === 'blue' && (Number(item.specialPriceBlue2) || 0) <= 0) {
                    const bp2 = Number(item.basePrice2);
                    const bp1 = Number(item.basePrice1);
                    if (Number.isFinite(bp2)) {
                        item.price2 = bp2;
                        item.price = bp2;
                    }
                    if (Number.isFinite(bp1)) item.price1 = bp1;
                    item.specialTag = null;
                }
                if (spTag === 'red' && (Number(item.specialPriceRed2) || 0) <= 0) {
                    const bp2 = Number(item.basePrice2);
                    const bp1 = Number(item.basePrice1);
                    if (Number.isFinite(bp2)) {
                        item.price2 = bp2;
                        item.price = bp2;
                    }
                    if (Number.isFinite(bp1)) item.price1 = bp1;
                    item.specialTag = null;
                }

                const lineTotal = item.price * qty;
                itemsTotal += lineTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = "flex items-start justify-between text-gray-700 gap-2";
                itemDiv.innerHTML = `
                    <div class="min-w-0 flex-1">
                        <div class="truncate pr-2">${item.name}</div>
                        <div class="mt-1 flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">К-сть</span>
                            <input type="number" min="1" step="1" value="${qty}" data-qty-key="${key}"
                                   class="w-16 px-2 py-1 border border-gray-200 rounded text-sm text-right outline-none focus:ring-2 focus:ring-gray-300" />
                        </div>
                    </div>
                    <div class="flex items-start gap-2 whitespace-nowrap">
                        <div class="text-right font-semibold">${lineTotal.toLocaleString()} грн</div>
                        <button type="button" title="Видалити" aria-label="Видалити" data-remove-key="${key}"
                                class="text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                receiptItemsContainer.appendChild(itemDiv);
            }

            // Qty change handlers (avoid recursive re-render on each keystroke)
            receiptItemsContainer.querySelectorAll('input[data-qty-key]').forEach((inp) => {
                inp.addEventListener('change', (e) => {
                    const el = e.target;
                    const k = String(el.getAttribute('data-qty-key') || '');
                    if (!k || !cart[k]) return;
                    const v = Math.max(1, Math.floor(Number(el.value) || 1));
                    cart[k].qty = v;
                    calculateTotal();
                    scheduleCalcSave_();
                });
            });

            receiptItemsContainer.querySelectorAll('button[data-remove-key]').forEach((btn) => {
                btn.addEventListener('click', (e) => {
                    const el = e.currentTarget;
                    const k = String(el.getAttribute('data-remove-key') || '');
                    if (!k || !cart[k]) return;
                    delete cart[k];
                    if (specialUiCartKey_ === k) specialUiCartKey_ = '';

                    // Clear active state on catalog buttons for this item id
                    document.querySelectorAll(`.price-btn[data-item-id="${CSS.escape(k)}"]`).forEach((b) => b.classList.remove('active'));

                    // VAT mode is fixed to "З ПДВ".
                    const keys = Object.keys(cart);
                    if (keys.length) {
                        setVatMode_(2, true);
                    } else {
                        setVatMode_(2, false);
                    }
                    calculateTotal();
                    scheduleCalcSave_();
                });
            });

            let baseTotal = itemsTotal;

            const adjustmentEl = document.getElementById('adjustment-input');
            const adjustmentInput = String(adjustmentEl?.value ?? '');

            let adjustmentVal = 0;
            if (adjustmentInput) {
                const num = parseFloat(adjustmentInput.replace(/\s/g, ''));
                if (!isNaN(num)) {
                    if (isPercentage_) {
                        adjustmentVal = baseTotal * num / 100;
                    } else {
                        adjustmentVal = num;
                    }
                    if (adjustmentMode_ === 'minus') {
                        adjustmentVal = -adjustmentVal;
                    }
                }
            }

            // "РАЗОМ" before compensation (includes adjustment).
            const totalBeforeComp = baseTotal + adjustmentVal;

            // 25% mode is a VISUAL "state compensation" indicator.
            // It must be calculated ONLY from the final total "РАЗОМ" (y) before compensation.
            // бухгалтерськи: ПДВ = y/6; база без ПДВ = y - ПДВ; компенсація = 25% від бази.
            let compensationVal = 0;
            const compElem = document.getElementById('receipt-compensation');
            if (vatDiscount25Active_) {
                const y = totalBeforeComp;
                const vat = y > 0 ? (y / 6) : 0;
                const net = y - vat;
                compensationVal = net > 0 ? (net * 0.25) : 0;
                if (compElem) {
                    compElem.classList.remove('hidden');
                    compElem.querySelector('span:last-child').textContent = `-${Math.round(compensationVal).toLocaleString()} грн`;
                }
            } else {
                if (compElem) compElem.classList.add('hidden');
            }

            const finalTotal = totalBeforeComp - compensationVal;

            document.getElementById('receipt-subtotal').innerHTML = `<span>Сума товарів:</span> <span class="font-bold">${itemsTotal.toLocaleString()} грн</span>`;
            
            const adjElem = document.getElementById('receipt-adjustment');
            if (adjustmentVal !== 0) {
                adjElem.classList.remove('hidden');
                const sign = adjustmentVal > 0 ? '+' : '';
                adjElem.innerHTML = `<span>Коригування:</span> <span>${sign}${Math.round(adjustmentVal).toLocaleString()} грн</span>`;
                adjElem.className = `flex justify-between ${adjustmentVal > 0 ? 'text-green-600' : 'text-red-600'}`;
            } else {
                adjElem.classList.add('hidden');
            }

            document.getElementById('final-total').textContent = `${Math.round(finalTotal).toLocaleString()} грн`;

            // Show/hide special calculator buttons for selected item
            updateGeneralXCalcPricesUi_();

            // Persist state after recalculation (debounced).
            scheduleCalcSave_();
        }

        function resetCreditState_() {
            const creditTermEl = document.getElementById('creditTerm');
            const creditAdvanceEl = document.getElementById('creditAdvance');
            const advanceUahEl = document.getElementById('advanceUah');
            const advancePercentEl = document.getElementById('advancePercent');
            const termTextEl = document.getElementById('termText');
            if (creditTermEl) creditTermEl.value = '1';
            if (creditAdvanceEl) creditAdvanceEl.value = '';
            if (advanceUahEl) {
                advanceUahEl.classList.add('bg-blue-600', 'text-white');
                advanceUahEl.classList.remove('bg-gray-200', 'text-gray-700');
            }
            if (advancePercentEl) {
                advancePercentEl.classList.add('bg-gray-200', 'text-gray-700');
                advancePercentEl.classList.remove('bg-blue-600', 'text-white');
            }
            if (termTextEl) termTextEl.innerHTML = '<span style="font-weight: bold;">1 місяць</span> | Один платіж в кінці';
        }

        function clearCart() {
            cart = {};
            specialUiCartKey_ = '';
            vatMode_ = 2;
            vatDiscount25Active_ = false;
            updateVatToggleUi_();
            updateVat25Ui_();
            document.querySelectorAll('.price-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adjustment-input').value = '';
            adjustmentMode_ = 'minus';
            isPercentage_ = false;
            calculateTotal();
            clearCalcState_();
            resetCreditState_();
        }

        // Special price buttons (blue/red) + edit-mode inputs
        (function initSpecialCalcButtons_() {
            const blueInp = document.getElementById('generalXBluePriceInput');
            const redInp = document.getElementById('generalXRedPriceInput');

            function setSpecialEdit_(field, value) {
                const docId = String(specialEditSelectedDocId_ || '').trim();
                if (!docId) return;
                const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: '', specialPriceBlue2: 0, specialPriceRed2: 0 };
                const prev = priceEdits_.get(docId) || {
                    price1: base.price1,
                    price2: base.price2,
                    sortItem: base.sortItem,
                    specialPriceBlue2: base.specialPriceBlue2,
                    specialPriceRed2: base.specialPriceRed2,
                };
                const next = { ...prev };
                next[field] = value;
                priceEdits_.set(docId, next);

                // If the currently selected cart item matches this docId, update its specials (and active override if needed).
                const key = findSelectedCartKeyForSpecialPrices_();
                if (key && cart[key] && String(cart[key].docId || '') === docId) {
                    cart[key].specialPriceBlue2 = Number(next.specialPriceBlue2) || 0;
                    cart[key].specialPriceRed2 = Number(next.specialPriceRed2) || 0;
                    const tag = String(cart[key].specialTag || '');

                    if (tag === 'blue') {
                        if (cart[key].specialPriceBlue2 > 0) {
                            const p2 = Number(cart[key].specialPriceBlue2);
                            cart[key].price2 = p2;
                            cart[key].price1 = computePrice1FromVatPrice_(p2);
                            cart[key].price = p2;
                        } else {
                            const bp2 = Number(cart[key].basePrice2);
                            const bp1 = Number(cart[key].basePrice1);
                            if (Number.isFinite(bp2)) {
                                cart[key].price2 = bp2;
                                cart[key].price = bp2;
                            }
                            if (Number.isFinite(bp1)) cart[key].price1 = bp1;
                            cart[key].specialTag = null;
                        }
                    }

                    if (tag === 'red') {
                        if (cart[key].specialPriceRed2 > 0) {
                            const p2 = Number(cart[key].specialPriceRed2);
                            cart[key].price2 = p2;
                            cart[key].price1 = computePrice1FromVatPrice_(p2);
                            cart[key].price = p2;
                        } else {
                            const bp2 = Number(cart[key].basePrice2);
                            const bp1 = Number(cart[key].basePrice1);
                            if (Number.isFinite(bp2)) {
                                cart[key].price2 = bp2;
                                cart[key].price = bp2;
                            }
                            if (Number.isFinite(bp1)) cart[key].price1 = bp1;
                            cart[key].specialTag = null;
                        }
                    }
                    calculateTotal();
                    scheduleCalcSave_();
                    return;
                }

                updateGeneralXCalcPricesUi_();
            }

            if (blueInp) {
                blueInp.addEventListener('input', () => {
                    const v = Number(String(blueInp.value || '').trim());
                    if (!Number.isFinite(v) || v < 0) return;
                    setSpecialEdit_('specialPriceBlue2', Math.round(v));
                });
            }
            if (redInp) {
                redInp.addEventListener('input', () => {
                    const v = Number(String(redInp.value || '').trim());
                    if (!Number.isFinite(v) || v < 0) return;
                    setSpecialEdit_('specialPriceRed2', Math.round(v));
                });
            }

            updateGeneralXCalcPricesUi_();
        })();

	  function scrollToBottom() {
            document.getElementById('calculator-section').scrollIntoView({ behavior: 'smooth' });
        }

        function collapseAllCatalog() {
            document.querySelectorAll('#catalog-container details[open]').forEach((d) => {
                d.open = false;
            });
        }

        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const nav = document.querySelector('.nav');
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            hamburger.classList.toggle('open');
        });

    </script>
</body>
</html>
