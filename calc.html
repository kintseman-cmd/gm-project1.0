<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <script>
            (function () {
                try {
                    document.documentElement.classList.add('pagefx');
                    window.setTimeout(function () {
                        document.documentElement.classList.add('pagefx-ready');
                    }, 900);
                } catch (e) {}
            })();
        </script>
        <style>html.pagefx:not(.pagefx-ready) body{opacity:0}</style>
        <link rel="stylesheet" href="assets/page-transitions.css">
        <script src="assets/page-transitions.js" defer></script>
        <link rel="stylesheet" href="assets/bottom-nav.css" />
        <script src="assets/bottom-nav.js" defer></script>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="manifest" href="manifest-calc.webmanifest">
    <meta name="theme-color" content="#F4C430">
    <title>Прайс-лист та Калькулятор</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        (function () {
            try {
                const params = new URLSearchParams(location.search);
                const isEmbed = params.get('embed') === '1';
                const inIframe = (function () {
                    try { return window.self !== window.top; } catch (e) { return true; }
                })();

                if (isEmbed && inIframe) {
                    document.documentElement.classList.add('embed');
                    return;
                }

                if (location.protocol === 'file:') {
                    return;
                }

                const target = new URL(location.href);
                target.search = '';
                target.pathname = target.pathname.replace(/[^/]+\.html$/i, 'index.html');
                target.hash = '#calc';
                location.replace(target.toString());
            } catch (e) {}
        })();
    </script>
    <style>
        html { overflow-y: scroll; scrollbar-gutter: stable; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; padding-top: 60px; }
        .price-btn.active {
            background-color: #22c55e; /* green-500 */
            color: rgb(255, 255, 255);
            border-color: #22c55e;
        }
        .price-btn.active:hover {
            background-color: #16a34a; /* green-600 */
        }
        .price-btn {
            transition: all 0.2s;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .chevron {
            transition: transform 0.3s;
        }
        details[open] .chevron {
            transform: rotate(180deg);
        }
        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        /* Embedded mode (inside index.html) */
        html.embed .header { display: none !important; }
        html.embed body { padding-top: 0 !important; }
        html.embed #delivery-panel { top: 0 !important; }

        .logo h1 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 800;
        }

        .nav {
            display: flex;
        }

        .nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 30px;
        }

        .nav-link {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            background: #4CAF50;
            color: #fff;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background: #333;
            margin: 3px 0;
            transition: 0.3s;
        }

        /* Стиль для калькулятора, що прилипає на десктопі */
        @media (min-width: 1024px) {
            .sticky-calc {
                position: sticky;
                top: var(--sticky-calc-top, 180px); /* auto-set via JS */
                max-height: var(--sticky-calc-maxh, calc(100vh - 200px));
                overflow-y: auto;
                scrollbar-gutter: stable;
            }
        }

        /* Mobile header */
        @media (max-width: 768px) {
            body { padding-top: 60px; }

            .header-container {
                padding: 10px 15px;
            }

            .logo h1 {
                font-size: 20px;
            }

            .nav {
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                height: calc(100vh - 60px);
                background: #fff;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 50px;
                opacity: 0;
                transform: translateY(-6px);
                pointer-events: none;
                transition: opacity 160ms ease, transform 160ms ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                z-index: 999;
            }

            .nav.open {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }

            .nav-list {
                flex-direction: column;
                gap: 20px;
            }

            .nav-item {
                opacity: 0;
                transform: translateX(-18px);
                transition: transform 180ms ease, opacity 180ms ease;
            }

            .nav-item:nth-child(even) {
                transform: translateX(18px);
            }

            .nav.open .nav-item {
                opacity: 1;
                transform: translateX(0);
            }

            @media (prefers-reduced-motion: reduce) {
                .nav,
                .nav-item {
                    transition: none;
                    transform: none;
                }
            }

            .nav-link {
                font-size: 18px;
                padding: 15px 30px;
                display: flex;
                align-items: center;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.open .bar:nth-child(1) {
                transform: rotate(-45deg) translate(-5px, 6px);
            }

            .hamburger.open .bar:nth-child(2) {
                opacity: 0;
            }

            .hamburger.open .bar:nth-child(3) {
                transform: rotate(45deg) translate(-5px, -6px);
            }
        }
    </style>
</head>
<body class="pb-10">

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <h1>General Machines</h1>
            </div>
            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="index.html#gm-script" class="nav-link"><i class="fas fa-file-code mr-2"></i>Скрипти</a></li>
                    <li class="nav-item"><a href="calc.html" class="nav-link active"><i class="fas fa-calculator mr-2"></i>Прайс</a></li>
                    <li class="nav-item"><a href="dov.html" class="nav-link"><i class="fas fa-calendar-check mr-2"></i>План</a></li>
                    <li class="nav-item"><a href="generator-ankety.html" class="nav-link"><i class="fas fa-file-excel mr-2"></i>Анкета</a></li>
                    <li class="nav-item"><a href="education.html" class="nav-link"><i class="fas fa-graduation-cap mr-2"></i>Навчання</a></li>
                </ul>
            </nav>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </header>
    <!-- Верхня панель: Доставка -->
    <div class="bg-white shadow-md sticky top-16 z-50 p-4 mb-4" id="delivery-panel">
        <div class="max-w-7xl mx-auto">
            <div id="delivery-menu">
                <h3 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">Вартість доставки:</h3>
                <div class="flex flex-wrap gap-2" id="delivery-buttons">
                    <!-- Кнопки генеруються JS -->
                </div>
            </div>

            <button id="delivery-reopen" type="button"
                    class="hidden mt-2 w-full md:w-auto px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-100 text-sm font-medium transition">
                Змінити доставку
            </button>
        </div>
    </div>

    <!-- Основний контейнер з сіткою -->
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Ліва колонка: Товари (Прайс) -->
            <div class="w-full lg:w-2/3 min-w-0" id="catalog-container">
                <!-- Категорії генеруються JS -->
            </div>

            <!-- Права колонка: Калькулятор -->
            <div class="w-full lg:w-1/3 lg:flex-none min-w-0">
                <div class="sticky-calc">
                    <!-- Міні адмін-панель прайсу (над калькулятором; НЕ в хедері) -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-3 flex flex-col gap-2" id="price-admin-bar">
                        <div class="hidden text-xs font-bold uppercase tracking-wide text-amber-600" id="priceEditModeLabel">Режим редагування</div>
                        <div class="flex flex-wrap items-center gap-2 justify-between">
                            <div class="flex flex-wrap items-center gap-2">
                                <button type="button" id="priceEditToggle" class="inline-flex items-center justify-center gap-2 text-sm font-semibold text-slate-700 hover:text-slate-900 px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition w-full sm:w-44">
                                <i class="fas fa-pen"></i>
                                <span>Редагувати</span>
                                </button>
                                <button type="button" id="priceLastChangesBtn" class="inline-flex items-center justify-center gap-2 text-sm font-semibold text-slate-700 hover:text-slate-900 px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition w-full sm:w-44">
                                <i class="fas fa-clock"></i>
                                <span>Останні зміни</span>
                                </button>
                            </div>
                            <div class="hidden flex flex-wrap items-center gap-2 justify-end" id="priceAdminControls">
                                <button type="button" id="priceAddCategoryBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-300 text-slate-700 text-sm font-semibold hover:bg-gray-50 shadow-sm whitespace-nowrap w-full sm:w-44"><i class="fas fa-folder-plus"></i>Категорія</button>
                                <button type="button" id="priceAddItemBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-300 text-slate-700 text-sm font-semibold hover:bg-gray-50 shadow-sm whitespace-nowrap w-full sm:w-44"><i class="fas fa-plus"></i>Позиція</button>
                                <button type="button" id="priceApplyBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 whitespace-nowrap w-full sm:w-44"><i class="fas fa-save"></i>Зберегти</button>
                            </div>
                        </div>
                    </div>

                    <!-- Панель "Останні зміни" -->
                    <div class="hidden bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-3" id="priceChangesPanel">
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold text-gray-800">Останні зміни цін</div>
                            <div class="flex items-center gap-2">
                                <div class="text-xs text-gray-500">(за полем updatedAt)</div>
                                <button type="button" id="priceClearChangesBtn" class="inline-flex items-center gap-2 text-xs font-semibold text-slate-700 hover:text-slate-900 px-3 py-1.5 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition">
                                    <i class="fas fa-eraser"></i>
                                    <span>Очистити</span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 max-h-56 overflow-auto">
                            <ul class="text-sm divide-y divide-gray-100" id="priceChangesList"></ul>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200" id="calculator-section">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Калькулятор</h2>
		 <!-- Кнопка "Калькулятор" (скрол до низу) -->
    <div class="fixed bottom-4 right-4 z-40 md:hidden" id="calc-fab">
        <button onclick="scrollToBottom()" class="bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition flex items-center gap-2">
            <i class="fas fa-calculator"></i> Калькулятор
        </button>
    </div>
                    <!-- Знижка та Націнка -->
                    <div class="space-y-4 mb-6">
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <label class="block text-sm font-medium text-red-700 mb-1">Знижка (грн або %)</label>
                            <input type="text" id="discount-input" placeholder="напр. 5000 або 5%" 
                                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-red-500 outline-none"
                                   oninput="calculateTotal()">
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                            <label class="block text-sm font-medium text-green-700 mb-1">Націнка (грн або %)</label>
                            <input type="text" id="markup-input" placeholder="напр. 2000 або 2%" 
                                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none"
                                   oninput="calculateTotal()">
                        </div>
                    </div>

                    <!-- Чек замовлення -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 font-mono text-sm mb-4">
                        <h3 class="font-bold text-center border-b border-dashed border-gray-400 pb-2 mb-2">ЧЕК ЗАМОВЛЕННЯ</h3>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">Ціни</span>
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1.5 text-xs font-bold rounded-lg bg-green-50 text-green-700 border border-green-200">З ПДВ</span>
                                <button type="button" id="vatDiscount25Btn" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition" title="Компенсація: 25% від бази (розрахунок від суми з ПДВ)">25%</button>
                            </div>
                        </div>
                        <div id="receipt-items" class="space-y-2 mb-4">
                            <div class="text-center text-gray-400 italic">Товари не обрані</div>
                        </div>
                        <div class="border-t border-dashed border-gray-400 my-2 pt-2 space-y-1">
                            <div class="flex justify-between" id="receipt-subtotal">
                                <span>Сума товарів:</span>
                                <span>0 грн</span>
                            </div>
                            <div class="flex justify-between text-blue-600" id="receipt-delivery">
                                <span>Доставка:</span>
                                <span>0 грн</span>
                            </div>
                            <div class="flex justify-between text-red-600 hidden" id="receipt-discount">
                                <span>Знижка:</span>
                                <span>-0 грн</span>
                            </div>
                            <div class="flex justify-between text-amber-700 hidden" id="receipt-compensation">
                                <span>Компенсація:</span>
                                <span>-0 грн</span>
                            </div>
                            <div class="flex justify-between text-green-600 hidden" id="receipt-markup">
                                <span>Націнка:</span>
                                <span>+0 грн</span>
                            </div>
                        </div>
                        <div class="border-t-2 border-gray-800 pt-2 mt-2 flex justify-between text-xl font-bold">
                            <span>РАЗОМ:</span>
                            <span id="final-total">0 грн</span>
                        </div>
                    </div>
                    
                    <div class="text-center flex items-center justify-center gap-4">
                        <button type="button" onclick="collapseAllCatalog()" class="text-gray-600 text-sm hover:underline">Згорнути все</button>
                        <button type="button" onclick="clearCart()" class="text-red-500 text-sm hover:underline">Очистити все</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Дані (незмінні) ---
        const deliveryOptions = [3000, 4000, 5000, 7000, 8000, 10000, 12000, 15000];
        const categoryColors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-orange-500', 'bg-cyan-500'];

        // --- Firebase: прайс з бази (Firestore) ---
        // Колекція: priceItems
        // Документ: довільний id
        // Поля: { category, name, price1, price2, sortCategory?, sortItem?, active? }
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCIDpmrCoITjCfqMeC94ZO7Enl4HyZ-Lkw",
            authDomain: "gm-base.firebaseapp.com",
            projectId: "gm-base",
            storageBucket: "gm-base.firebasestorage.app",
            messagingSenderId: "579626247182",
            appId: "1:579626247182:web:09324aa5823c564defc85f"
        };

        let firebasePriceApiPromise_ = null;

        async function initFirebaseForPrice_() {
            if (firebasePriceApiPromise_) return firebasePriceApiPromise_;
            firebasePriceApiPromise_ = (async () => {
                const appMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

                let app;
                const appName = 'price-calc';
                try {
                    app = appMod.initializeApp(FIREBASE_CONFIG, appName);
                } catch (e) {
                    app = appMod.getApp(appName);
                }

                const db = fsMod.getFirestore(app);
                let auth = null;

                // Anonymous auth (якщо правила Firestore вимагають auth)
                try {
                    auth = authMod.getAuth(app);
                    if (!auth.currentUser) {
                        await authMod.signInAnonymously(auth);
                        console.info('[calc] Firebase auth: anonymous signed in');
                    }
                } catch (e) {
                    // Якщо provider вимкнено або домен не дозволено — все одно спробуємо читати (може бути allow read)
                    console.warn('[calc] Firebase auth: anonymous sign-in failed', { code: e?.code, message: e?.message });
                }

                return { db, auth, authMod, ...fsMod };
            })();
            return firebasePriceApiPromise_;
        }

        function buildCatalogFromPriceDocs_(docs) {
            const byCat = new Map();
            for (const d of docs) {
                const data = d.data ? d.data() : d;
                const docId = d && typeof d.id === 'string' ? d.id : null;
                if (!data) continue;
                if (data.active === false) continue;
                const category = String(data.category || '').trim();
                const name = String(data.name || '').trim();
                const price1 = Number(data.price1);
                const price2 = Number(data.price2);
                if (!category || !name) continue;
                if (!Number.isFinite(price1) || !Number.isFinite(price2)) continue;

                const sortCategory = Number.isFinite(Number(data.sortCategory)) ? Number(data.sortCategory) : null;
                const sortItem = Number.isFinite(Number(data.sortItem)) ? Number(data.sortItem) : null;

                if (!byCat.has(category)) {
                    byCat.set(category, { category, sortCategory, items: [] });
                } else {
                    // Make category sort deterministic: keep the smallest provided sortCategory.
                    const cur = byCat.get(category).sortCategory;
                    if (cur == null) byCat.get(category).sortCategory = sortCategory;
                    else if (sortCategory != null && sortCategory < cur) byCat.get(category).sortCategory = sortCategory;
                }

                byCat.get(category).items.push({ id: docId, name, price1, price2, sortItem });
            }

            const cats = Array.from(byCat.values());
            cats.sort((a, b) => {
                const as = a.sortCategory;
                const bs = b.sortCategory;
                if (as != null && bs != null && as !== bs) return as - bs;
                if (as != null && bs == null) return -1;
                if (as == null && bs != null) return 1;
                return String(a.category).localeCompare(String(b.category), 'uk');
            });

            for (const c of cats) {
                c.items.sort((a, b) => {
                    const as = a.sortItem;
                    const bs = b.sortItem;
                    if (as != null && bs != null && as !== bs) return as - bs;
                    if (as != null && bs == null) return -1;
                    if (as == null && bs != null) return 1;
                    return String(a.name).localeCompare(String(b.name), 'uk');
                });
                // Keep sortItem in-memory so edit UI can show it.
                c.items = c.items.map(({ id, name, price1, price2, sortItem }) => ({ id, name, price1, price2, sortItem }));
            }
            return cats;
        }

        async function loadCatalogFromFirestore_() {
            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) return false;

                updateLastChangesFromPriceDocs_(snap.docs);

                const next = buildCatalogFromPriceDocs_(snap.docs);
                if (!next.length) return false;

                // Не міняємо посилання на catalogData, щоб не ламати існуючі функції.
                catalogData.length = 0;
                catalogData.push(...next);
                return true;
            } catch (e) {
                const code = e?.code;
                if (code === 'permission-denied' || /insufficient permissions/i.test(String(e?.message || ''))) {
                    console.warn('[calc] price catalog load failed: permission denied. Fix Firestore Rules for /priceItems.', e);
                } else if (code === 'auth/unauthorized-domain') {
                    console.warn('[calc] price catalog load failed: unauthorized domain. Add domain in Firebase Auth -> Settings -> Authorized domains.', e);
                } else {
                    console.warn('[calc] price catalog load failed', e);
                }
                return false;
            }
        }
        
        const catalogData = [
            {
                category: "Куни",
                items: [
                    { name: "GENERAL-X (без ковша)", price1: 170000, price2: 204000 },
                    { name: "GENERAL-XL (без ковша)", price1: 175000, price2: 210000 },
                    { name: "GENERAL-EURO (без ковша)", price1: 194167, price2: 233000 },
                    { name: "GENERAL-XL 1221 (без ковша)", price1: 183333, price2: 220000 },
                    { name: "GENERAL-EURO + 3-тя секція (без ковша) МТЗ", price1: 179167, price2: 215000 },
                    { name: "GENERAL-X (з ковшем в комплекті)", price1: 188333, price2: 226000 },
                    { name: "GENERAL-XL (з ковшем в комплекті)", price1: 193333, price2: 232000 },
                    { name: "GENERAL-EURO (з ковшем в комплекті)", price1: 212500, price2: 255000 },
                    { name: "Комплект для керування гідравлікою на дві секції (Джойстик) 2Р-40", price1: 11667, price2: 14000 },
                    { name: "Комплект для керування гідравлікою на дві секції (Джойстик) 2Р-80", price1: 15000, price2: 18000 },
                    { name: "Електро-магнітний клапан", price1: 5000, price2: 6000 }
                ]
            },
            {
                category: "Навісне до кунів",
                items: [
                    { name: "Ківш STANDART 2 м.", price1: 29167, price2: 35000 },
                    { name: "Ківш 2.2 м.", price1: 31667, price2: 38000 },
                    { name: "Ківш будівельний 1.6 м.", price1: 29167, price2: 35000 },
                    { name: "Ківш ЩЕЛЕПА 1.8 м.", price1: 59167, price2: 71000 },
                    { name: "Ківш ЩЕЛЕПА 2 м.", price1: 62500, price2: 75000 },
                    { name: "Збільшений Ківш на 1.5 м3", price1: 33333, price2: 40000 },
                    { name: "Ківш із ЗАХОПЛЕННЯМ", price1: 62500, price2: 75000 },
                    { name: "Ківш для БЕГІВ", price1: 87500, price2: 105000 },
                    { name: "Ківш для БЕГІВ (автоматичний)", price1: 91667, price2: 110000 },
                    { name: "Гак для бігбегів", price1: 25000, price2: 30000 },
                    { name: "Вила для піддонів", price1: 25000, price2: 30000 },
                    { name: "Вила для ТЮКІВ", price1: 25000, price2: 30000 },
                    { name: "Вила - Гак (2 в1)", price1: 30000, price2: 36000 },
                    { name: "Вила - Гак (3 в1)", price1: 33333, price2: 40000 },
                    { name: "Вила СІНАЖНІ", price1: 58333, price2: 70000 },
                    { name: "Захват для ТЮКІВ", price1: 58333, price2: 70000 },
                    { name: "Захват для КОЛОД", price1: 37500, price2: 45000 }
                ]
            },
            {
                category: "Культиватори",
                items: [
                    { name: "Культиватор навісний КНС 2.6", price1: 150000, price2: 165000 },
                    { name: "Культиватор навісний КНС 3.0", price1: 165000, price2: 180000 },
                    { name: "Культиватор навісний КНС 3.5", price1: 175000, price2: 190000 },
                    { name: "Культиватор навісний КНС 4.0", price1: 185000, price2: 200000 },
                    { name: "Причіпний пристрій до КНС 4.0", price1: 125000, price2: 130000 },
                    { name: "БПП балка причіпного пристрою", price1: 20000, price2: 23000 },
                    { name: "Культиватор причіпний КПС 4.0", price1: 310000, price2: 330000 },
                    { name: "Культиватор причіпний КПРС 5.0", price1: 430000, price2: 480000 },
                    { name: "Культиватор причіпний КПРС 6.0", price1: 530000, price2: 580000 }
                ]
            },
            {
                category: "Лущильники",
                items: [
                    { name: "Лущильник 2.6 м.", price1: 260000, price2: 270000 },
                    { name: "Лущильник 2.6 м. з тандемним котком", price1: 300000, price2: 310000 },
                    { name: "Лущильник 2.6 м. (причіпний)", price1: 420000, price2: 435000 },
                    { name: "Лущильник 3.2 м.", price1: 350000, price2: 360000 },
                    { name: "Лущильник 3.2 м. з тандемним котком", price1: 415000, price2: 425000 },
                    { name: "Лущильник 3.2 м. (причіпний)", price1: 530000, price2: 550000 },
                    { name: "Лущильник 4.2 м. (причіпний)", price1: 750000, price2: 780000 },
                    { name: "Лущильник 5.2 м. (причіпний)", price1: 910000, price2: 960000 },
                    { name: "Причіпний пристрій до ЛН без катків", price1: 130000, price2: 130000 },
                    { name: "Причіпний пристрій до ЛН2.6 з подвійними катками", price1: 190000, price2: 210000 },
                    { name: "Причіпний пристрій до ЛН2.6 з одинарними катками", price1: 165000, price2: 190000 },
                    { name: "Причіпний пристрій до ЛН 3.2 з одинарними катками", price1: 175000, price2: 200000 },
                    { name: "Причіпний пристрій до ЛН3.2 з подвійними катками", price1: 215000, price2: 235000 },
                    { name: "Тандемний (подвійні) котки на ЛН", price1: 65000, price2: 65000 },
                    { name: "Тандемний коток замість одинарного", price1: 40000, price2: 40000 }
                ]
            },
            {
                category: "Борони пружинні",
                items: [
                    { name: "Борона пружинна 6 м. (без опорних коліс)", price1: 130000, price2: 140000 },
                    { name: "Борона пружинна 6 м з колесами (7-ка/10-ка)", price1: 130000, price2: 140000 },
                    { name: "Борона пружинна 9 м. (без опорних коліс)", price1: 150000, price2: 160000 },
                    { name: "Борона пружинна 9 м. + опорні колеса", price1: 160000, price2: 175000 },
                    { name: "Колеса опорні", price1: 35000, price2: 40000 },
                    { name: "Кріплення \"євробалка\" до пружинної борони", price1: 5500, price2: 7000 },
                    { name: "Кріплення \"трьохточка\" до пружинної борони", price1: 8000, price2: 10000 },
                    { name: "Комплект пружин (7-ка/10ка)", price1: 40000, price2: 45000 },
                    { name: "Комплект пружин на трубі (7-ка/10ка)", price1: 65000, price2: 75000 },
                    { name: "Універсальна пружинна борона 9 м", price1: 250000, price2: 270000 }
                ]
            },
           {
                category: "КРНи",
                items: [
                    { name: "КРН 4.2 навісний (міжрядний розкладний)", price1: 290000, price2: 320000 },
                    { name: "КРН 5.6 навісний РОЗКЛАДНА рама (міжрядний)", price1: 320000, price2: 360000 },
                    { name: "КРН 5.6 навісний СУЦІЛЬНА рама (міжрядний)", price1: 250000, price2: 280000 },
                    { name: "КРН 5.6 навісний розкладний з БОЧКОЮ 500л (Під МТЗ, бочка спереду)", price1: 455000, price2: 510000 },
                    { name: "КРН 5.6 навісний розкладний з БОЧКОЮ 500л (бочка на самому КРН)", price1: 420000, price2: 510000 },
                    { name: "КРН 5.6 навісний суцільна рама з БОЧКОЮ 500л", price1: 360000, price2: 395000 },
                    { name: "Захисний щиток рядка", price1: 31000, price2: 35000 },
                    { name: "Бочка для рідких добрив на КРН на раму", price1: 130000, price2: 145000 },
                    { name: "Бочка для рідких добнив на КРН розкладний (з переду трактора)", price1: 145000, price2: 160000 }
                ]
            },
             {
                category: "Глибокорозпушувачі",
                items: [
                    { name: "Глибокорозпушувач 1.8 м.", price1: 350000, price2: 370000 },
                    { name: "Глибокорозпушувач 2.5 м.", price1: 400000, price2: 425000 },
                    { name: "Глибокорозпушувач 3 м. 5 лап", price1: 435000, price2: 450000 },
                    { name: "Глибокорозпушувач 3 м. 7 лап", price1: 490000, price2: 510000 }
                ]
            },
            {
                category: "Відвали",
                items: [
                    { name: "Грейдерний відвал", price1: 58333, price2: 70000 },
                    { name: "Відвал Універсальний (Двосторонній) на СТРІЛУ", price1: 25000, price2: 30000 },
                    { name: "Відвал Універсальний (Двосторонній)", price1: 50000, price2: 60000 },
                    { name: "Відвал Універсальний (Двосторонній) гідро-поворотний", price1: 62500, price2: 75000 },
                    { name: "Відвал Універсальний (Двосторонній) гідро-поворотний EURO", price1: 66667, price2: 80000 },
                    { name: "Відвал для буртування зерна", price1: 29167, price2: 35000 }
                ]
            },
            {
                category: "Зубові борони",
                items: [
                    { name: "Борона зубова 9 м. складна", price1: 390000, price2: 435000 }
                ]
            },
            {
                category: "Крани-маніпулятори",
                items: [
                    { name: "Кран-маніпулятор S-1500", price1: 90000, price2: 100000 },
                    { name: "Кран-маніпулятор SL-2000", price1: 300000, price2: 340000 }
                ]
            },
            {
                category: "БОЧКА КАС 8 куб.",
                items: [
                    { name: "Бочка для внесення добрив 8 куб.", price1: 480000, price2: 550000 }
                ]
            }
        ];

        // --- Стан ---
        let cart = {}; 
        let selectedDelivery = 0;
        let vatMode_ = 2; // only: 2 = З ПДВ
        let vatDiscount25Active_ = false;
        // --- LocalStorage: persist calculator state across tab switches ---
        const CALC_STATE_KEY_ = 'gm_calc_state_v1';
        let calcSaveTimer_ = null;

        function scheduleCalcSave_() {
            if (calcSaveTimer_) clearTimeout(calcSaveTimer_);
            calcSaveTimer_ = setTimeout(() => {
                calcSaveTimer_ = null;
                saveCalcState_();
            }, 200);
        }

        function saveCalcState_() {
            try {
                const discountEl = document.getElementById('discount-input');
                const markupEl = document.getElementById('markup-input');

                const cartItems = Object.keys(cart).map((k) => {
                    const it = cart[k] || {};
                    return {
                        category: String(it.category || ''),
                        name: String(it.name || ''),
                        type: 2,
                        qty: Math.max(1, Math.floor(Number(it.qty) || 1)),
                        docId: String(it.docId || '')
                    };
                }).filter(x => x.name);

                const state = {
                    v: 1,
                    t: Date.now(),
                    selectedDelivery: Number(selectedDelivery) || 0,
                    vatMode: 2,
                    vatDiscount25Active: !!vatDiscount25Active_,
                    discountInput: String(discountEl?.value ?? ''),
                    markupInput: String(markupEl?.value ?? ''),
                    cartItems
                };
                localStorage.setItem(CALC_STATE_KEY_, JSON.stringify(state));
            } catch (e) {}
        }

        function clearCalcState_() {
            try { localStorage.removeItem(CALC_STATE_KEY_); } catch (e) {}
        }

        function readCalcState_() {
            try {
                const raw = localStorage.getItem(CALC_STATE_KEY_);
                const obj = raw ? JSON.parse(raw) : null;
                return obj && typeof obj === 'object' ? obj : null;
            } catch (e) {
                return null;
            }
        }

        function findCatalogItemByRef_(ref) {
            const wantDocId = String(ref?.docId || '');
            const wantCat = String(ref?.category || '');
            const wantName = String(ref?.name || '');
            for (let ci = 0; ci < catalogData.length; ci++) {
                const cat = catalogData[ci];
                if (!cat) continue;
                if (wantCat && String(cat.category) !== wantCat) continue;
                const items = Array.isArray(cat.items) ? cat.items : [];
                for (let ii = 0; ii < items.length; ii++) {
                    const it = items[ii];
                    if (!it) continue;
                    if (wantDocId && it.id && String(it.id) === wantDocId) return { catIdx: ci, itemIdx: ii, cat, item: it };
                    if (wantName && String(it.name) === wantName) return { catIdx: ci, itemIdx: ii, cat, item: it };
                }
            }
            return null;
        }

        function applyDeliveryUiFromState_() {
            const buttonsHost = document.getElementById('delivery-buttons');
            if (!buttonsHost) return;
            const kids = buttonsHost.querySelectorAll('button[data-delivery-price]');
            kids.forEach((b) => {
                const p = Number(b.getAttribute('data-delivery-price'));
                b.classList.toggle('active', p === Number(selectedDelivery));
            });
        }

        function restoreCalcState_() {
            const st = readCalcState_();
            if (!st) return;

            // Inputs
            const discountEl = document.getElementById('discount-input');
            const markupEl = document.getElementById('markup-input');
            if (discountEl) discountEl.value = String(st.discountInput ?? '');
            if (markupEl) markupEl.value = String(st.markupInput ?? '');

            // Delivery
            selectedDelivery = Number(st.selectedDelivery) || 0;
            applyDeliveryUiFromState_();
            setDeliveryMenuCollapsed(false);

            // VAT / 25% (VAT mode is fixed: only "З ПДВ")
            vatMode_ = 2;
            vatDiscount25Active_ = !!st.vatDiscount25Active;
            updateVatToggleUi_();
            updateVat25Ui_();

            // Cart
            cart = {};
            const saved = Array.isArray(st.cartItems) ? st.cartItems : [];
            const enforcedType = 2;
            for (const ref of saved) {
                const found = findCatalogItemByRef_(ref);
                if (!found) continue;

                const id = `${found.catIdx}_${found.itemIdx}`;
                const qty = Math.max(1, Math.floor(Number(ref?.qty) || 1));
                const price1 = Number(found.item.price1);
                const price2 = Number(found.item.price2);
                cart[id] = {
                    name: String(found.item.name),
                    category: String(found.cat.category),
                    docId: found.item.id ? String(found.item.id) : '',
                    price1,
                    price2,
                    type: enforcedType,
                    price: price2,
                    qty,
                };
            }
            updateVatToggleUi_();
            syncCatalogActiveStates_();
            calculateTotal();
        }

        // --- Міні адмін редагування прайсу ---
        // ВАЖЛИВО: Firestore Rules не можуть перевіряти цей пароль.
        // Для запису з цієї сторінки використовується Firebase Auth Email/Password користувач.
        const PRICE_ADMIN_EMAIL = 'price-admin@gm-base.local';
        const PRICE_ADMIN_PASSWORD = '123456';
        let priceEditUnlocked_ = false;
        let priceEditMode_ = false;
        const priceEdits_ = new Map(); // docId -> { price1, price2, sortItem? }
        const categorySortEdits_ = new Map(); // category -> sortCategory|null
        const priceDocSnapshot_ = new Map(); // docId -> { price1, price2, sortItem, category } (current values from catalog)

        // --- Останні зміни (updatedAt) ---
        let priceLastChanges_ = []; // [{ category, name, updatedAt: Date|null, fromPrice1, fromPrice2, toPrice1, toPrice2 }]
        let priceChangesOpen_ = false;

        function tsToDate_(ts) {
            try {
                if (!ts) return null;
                if (typeof ts.toDate === 'function') return ts.toDate();
                if (typeof ts.seconds === 'number') return new Date(ts.seconds * 1000);
                return null;
            } catch (e) {
                return null;
            }
        }

        function formatUaDateTime_(d) {
            if (!d) return '—';
            try {
                return d.toLocaleString('uk-UA');
            } catch (e) {
                return String(d);
            }
        }

        function formatMoney_(n) {
            const v = Number(n);
            if (!Number.isFinite(v)) return '—';
            try {
                return v.toLocaleString('uk-UA');
            } catch (e) {
                return String(v);
            }
        }

        function formatDelta_(from, to) {
            const a = Number(from);
            const b = Number(to);
            if (!Number.isFinite(a) || !Number.isFinite(b)) return '';
            const d = b - a;
            if (!d) return '';
            const sign = d > 0 ? '+' : '';
            return ` (${sign}${formatMoney_(d)})`;
        }

        function updateLastChangesFromPriceDocs_(docs) {
            const list = [];
            for (const d of docs || []) {
                const data = d?.data ? d.data() : d;
                if (!data) continue;
                if (data.active === false) continue;
                const category = String(data.category || '').trim();
                const name = String(data.name || '').trim();
                if (!category || !name) continue;
                const lastChange = data.lastChange && typeof data.lastChange === 'object' ? data.lastChange : null;
                const updatedAt = tsToDate_(lastChange?.at || data.updatedAt);
                // If there is no timestamp, there's no "change" to show.
                if (!updatedAt) continue;
                const toPrice1 = Number(data.price1);
                const toPrice2 = Number(data.price2);
                const fromPrice1 = Number.isFinite(Number(lastChange?.fromPrice1)) ? Number(lastChange.fromPrice1) : null;
                const fromPrice2 = Number.isFinite(Number(lastChange?.fromPrice2)) ? Number(lastChange.fromPrice2) : null;
                const lastToPrice1 = Number.isFinite(Number(lastChange?.toPrice1)) ? Number(lastChange.toPrice1) : (Number.isFinite(toPrice1) ? toPrice1 : null);
                const lastToPrice2 = Number.isFinite(Number(lastChange?.toPrice2)) ? Number(lastChange.toPrice2) : (Number.isFinite(toPrice2) ? toPrice2 : null);
                list.push({ category, name, updatedAt, fromPrice1, fromPrice2, toPrice1: lastToPrice1, toPrice2: lastToPrice2 });
            }
            list.sort((a, b) => {
                const at = a.updatedAt ? a.updatedAt.getTime() : 0;
                const bt = b.updatedAt ? b.updatedAt.getTime() : 0;
                return bt - at;
            });
            priceLastChanges_ = list.slice(0, 20);
        }

        function setChangesUi_() {
            const panel = document.getElementById('priceChangesPanel');
            if (!panel) return;
            panel.classList.toggle('hidden', !priceChangesOpen_);
            if (priceChangesOpen_) renderLastChanges_();
        }

        function renderLastChanges_() {
            const ul = document.getElementById('priceChangesList');
            if (!ul) return;
            ul.innerHTML = '';

            if (!priceLastChanges_.length) {
                const li = document.createElement('li');
                li.className = 'py-2 text-gray-500';
                li.textContent = 'Немає даних. Зміни з\'являться після збереження цін.';
                ul.appendChild(li);
                return;
            }

            for (const it of priceLastChanges_) {
                const li = document.createElement('li');
                li.className = 'py-2 flex items-start justify-between gap-3';

                const hasFrom = Number.isFinite(Number(it.fromPrice1)) || Number.isFinite(Number(it.fromPrice2));
                const p2Line = hasFrom && Number.isFinite(Number(it.fromPrice2))
                    ? `З ПДВ: ${formatMoney_(it.fromPrice2)} → ${formatMoney_(it.toPrice2)}${formatDelta_(it.fromPrice2, it.toPrice2)} грн`
                    : `З ПДВ: ${formatMoney_(it.toPrice2)} грн`;

                li.innerHTML = `
                    <div class="min-w-0">
                        <div class="text-gray-800 font-medium truncate">${it.name}</div>
                        <div class="text-xs text-gray-500 truncate">${it.category}</div>
                        <div class="text-xs text-gray-700 mt-1">${p2Line}</div>
                    </div>
                    <div class="text-xs font-semibold text-gray-700 whitespace-nowrap">${formatUaDateTime_(it.updatedAt)}</div>
                `;
                ul.appendChild(li);
            }
        }

        // --- Ініціалізація ---
        document.addEventListener('DOMContentLoaded', () => {
            renderDeliveryButtons();
            renderCatalog();

            // Restore persisted state (must run after initial render so buttons exist).
            restoreCalcState_();

            updateStickyCalcOffset_();

            const vat25 = document.getElementById('vatDiscount25Btn');
            if (vat25) vat25.addEventListener('click', () => {
                if (!vatDiscount25Active_) {
                    // Toggle ON
                    vatDiscount25Active_ = true;
                    setVatMode_(2, true);
                } else {
                    // Toggle OFF
                    vatDiscount25Active_ = false;
                }
                updateVat25Ui_();
                calculateTotal();
            });
            updateVatToggleUi_();
            updateVat25Ui_();

            // Спробувати підвантажити прайс з Firestore і перерендерити каталог.
            loadCatalogFromFirestore_().then((ok) => {
                if (ok) {
                    renderCatalog();
                    // Re-apply state after catalog potentially changed.
                    restoreCalcState_();
                }
            });

            // Адмін панель
            const editBtn = document.getElementById('priceEditToggle');
            const applyBtn = document.getElementById('priceApplyBtn');
            const addCatBtn = document.getElementById('priceAddCategoryBtn');
            const addItemBtn = document.getElementById('priceAddItemBtn');
            const changesBtn = document.getElementById('priceLastChangesBtn');
            const clearChangesBtn = document.getElementById('priceClearChangesBtn');
            if (editBtn) editBtn.addEventListener('click', onPriceEditToggle_);
            if (applyBtn) applyBtn.addEventListener('click', onPriceApply_);
            if (addCatBtn) addCatBtn.addEventListener('click', onPriceAddCategory_);
            if (addItemBtn) addItemBtn.addEventListener('click', () => onPriceAddItem_(null));
            setAdminUi_();
            if (changesBtn) {
                changesBtn.addEventListener('click', () => {
                    priceChangesOpen_ = !priceChangesOpen_;
                    setChangesUi_();
                });
            }
            if (clearChangesBtn) clearChangesBtn.addEventListener('click', onPriceClearChanges_);
            setChangesUi_();

            const reopenBtn = document.getElementById('delivery-reopen');
            if (reopenBtn) {
                reopenBtn.addEventListener('click', () => setDeliveryMenuCollapsed(false));
            }

            // Якщо вийшли з мобільного режиму — повертаємо панель доставки
            window.addEventListener('resize', () => {
                if (!isMobileViewport()) setDeliveryMenuCollapsed(false);
                updateStickyCalcOffset_();
            });

            setupCalcFabVisibility_();
        });

        function setupCalcFabVisibility_() {
            const fab = document.getElementById('calc-fab');
            const target = document.getElementById('calculator-section');
            if (!fab || !target) return;

            const setHidden = (hidden) => {
                fab.classList.toggle('hidden', !!hidden);
            };

            // Prefer IntersectionObserver; fallback to scroll handler.
            if (typeof IntersectionObserver === 'function') {
                const obs = new IntersectionObserver((entries) => {
                    const e = entries && entries[0];
                    setHidden(!!e && (e.isIntersecting || (typeof e.intersectionRatio === 'number' && e.intersectionRatio > 0)));
                }, { root: null, threshold: [0, 0.05, 0.15] });
                obs.observe(target);
                return;
            }

            const onScroll = () => {
                const r = target.getBoundingClientRect();
                const vh = Math.max(1, window.innerHeight || document.documentElement.clientHeight || 1);
                const visible = r.top < vh * 0.95 && r.bottom > vh * 0.05;
                setHidden(visible);
            };
            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('resize', onScroll);
            onScroll();
        }

        function updateStickyCalcOffset_() {
            try {
                if (!window.matchMedia('(min-width: 1024px)').matches) return;
                const delivery = document.getElementById('delivery-panel');
                if (!delivery) return;

                const cs = window.getComputedStyle(delivery);
                const top = parseFloat(cs.top || '0') || 0;
                const mb = parseFloat(cs.marginBottom || '0') || 0;
                const h = delivery.offsetHeight || 0;
                const stickyTop = Math.max(0, Math.round(top + h + mb));
                document.documentElement.style.setProperty('--sticky-calc-top', stickyTop + 'px');
                document.documentElement.style.setProperty('--sticky-calc-maxh', `calc(100vh - ${stickyTop + 20}px)`);
            } catch (e) {
                // ignore
            }
        }

        function isMobileViewport() {
            return window.matchMedia('(max-width: 768px)').matches;
        }

        function setDeliveryMenuCollapsed(collapsed) {
            const menu = document.getElementById('delivery-menu');
            const reopenBtn = document.getElementById('delivery-reopen');
            if (!menu || !reopenBtn) return;

            if (collapsed) {
                menu.classList.add('hidden');
                reopenBtn.classList.remove('hidden');
            } else {
                menu.classList.remove('hidden');
                reopenBtn.classList.add('hidden');
            }
        }

        // --- Рендеринг ---
        function renderDeliveryButtons() {
            const container = document.getElementById('delivery-buttons');
            deliveryOptions.forEach(price => {
                const btn = document.createElement('button');
                btn.setAttribute('data-delivery-price', String(price));
                btn.className = 'price-btn px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-100 text-sm font-medium transition';
                btn.textContent = `+${price.toLocaleString()} грн`;
                btn.onclick = () => toggleDelivery(price, btn);
                container.appendChild(btn);
            });
        }

        function toggleDelivery(price, btn) {
            const buttons = document.getElementById('delivery-buttons').children;
            for (let b of buttons) {
                if (b !== btn) b.classList.remove('active');
            }

            if (selectedDelivery === price) {
                selectedDelivery = 0;
                btn.classList.remove('active');
                // якщо доставку зняли — показуємо меню назад
                setDeliveryMenuCollapsed(false);
            } else {
                selectedDelivery = price;
                btn.classList.add('active');

                // На мобільному після вибору доставки ховаємо меню, але залишаємо кнопку для повторного відкриття
                if (isMobileViewport()) {
                    setDeliveryMenuCollapsed(true);
                }
            }
            calculateTotal();
            scheduleCalcSave_();
        }

        function renderCatalog() {
            const container = document.getElementById('catalog-container');
            container.innerHTML = '';
            priceDocSnapshot_.clear();
            
            catalogData.forEach((cat, catIdx) => {
                const details = document.createElement('details');
                details.className = "group mb-4 bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200";
                details.setAttribute('data-cat-name', String(cat.category || ''));
                
                const summary = document.createElement('summary');
                summary.className = "flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition";
                const color = categoryColors[catIdx % categoryColors.length];
                summary.innerHTML = `
                    <span class="flex items-center">
                        <div class="w-3 h-3 rounded-full ${color} mr-3"></div>
                        <span class="font-bold text-lg text-gray-800">${cat.category}</span>
                    </span>
                    <span class="cat-actions flex items-center gap-2 justify-end">
                        <span class="chevron text-gray-400"><i class="fas fa-chevron-down"></i></span>
                    </span>
                `;

                if (priceEditMode_) {
                    const actions = summary.querySelector('.cat-actions');

                    const dragBtn = document.createElement('button');
                    dragBtn.type = 'button';
                    dragBtn.className = 'inline-flex items-center justify-center w-9 h-9 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition cursor-move';
                    dragBtn.title = 'Перетягніть, щоб змінити порядок категорій';
                    dragBtn.setAttribute('aria-label', 'Перетягнути категорію');
                    dragBtn.setAttribute('data-cat-drag-handle', String(cat.category || ''));
                    dragBtn.setAttribute('draggable', 'true');
                    dragBtn.innerHTML = '<i class="fas fa-grip-vertical"></i>';

                    const sortVal = categorySortEdits_.has(String(cat.category || ''))
                        ? categorySortEdits_.get(String(cat.category || ''))
                        : (Number.isFinite(Number(cat.sortCategory)) ? Number(cat.sortCategory) : null);

                    const sortInp = document.createElement('input');
                    sortInp.type = 'number';
                    sortInp.inputMode = 'numeric';
                    sortInp.step = '1';
                    sortInp.min = '0';
                    sortInp.value = (sortVal == null ? '' : String(sortVal));
                    sortInp.className = 'w-16 px-2 py-1 border border-gray-300 rounded text-xs text-right outline-none focus:ring-2 focus:ring-gray-300 bg-white';
                    sortInp.title = 'Сортування категорії (менше = вище)';
                    sortInp.setAttribute('aria-label', 'Сортування категорії');
                    sortInp.setAttribute('data-cat-sort', String(cat.category || ''));

                    const delCat = document.createElement('button');
                    delCat.type = 'button';
                    delCat.className = 'inline-flex items-center justify-center w-9 h-9 rounded-lg text-red-600 hover:text-red-700 hover:bg-red-50 transition';
                    delCat.title = 'Видалити категорію';
                    delCat.setAttribute('aria-label', 'Видалити категорію');
                    delCat.innerHTML = '<i class="fas fa-trash"></i>';
                    delCat.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        onPriceDeleteCategory_(String(cat.category || ''));
                    });

                    if (actions) {
                        // Place controls on the right, before the chevron.
                        const chevronEl = actions.querySelector('.chevron');
                        actions.insertBefore(dragBtn, chevronEl);
                        actions.insertBefore(sortInp, chevronEl);
                        actions.insertBefore(delCat, chevronEl);
                    }
                }
                
                const content = document.createElement('div');
                content.className = "p-4 space-y-4";
                
                cat.items.forEach((item, itemIdx) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = "flex flex-col md:flex-row md:justify-between md:items-center border-b border-gray-100 last:border-0 pb-3 last:pb-0 gap-2";
                    itemRow.setAttribute('data-cat-name', String(cat.category || ''));
                    
                    const id = `${catIdx}_${itemIdx}`;

                    const docId = item.id ? String(item.id) : '';
                    const pending = docId && priceEdits_.has(docId) ? priceEdits_.get(docId) : null;
                    const p1 = pending && Number.isFinite(Number(pending.price1)) ? Number(pending.price1) : item.price1;
                    const p2 = pending && Number.isFinite(Number(pending.price2)) ? Number(pending.price2) : item.price2;
                    const sItem = pending && Number.isFinite(Number(pending.sortItem)) ? Number(pending.sortItem) : (Number.isFinite(Number(item.sortItem)) ? Number(item.sortItem) : null);

                    if (docId && !priceDocSnapshot_.has(docId)) {
                        priceDocSnapshot_.set(docId, { price1: item.price1, price2: item.price2, sortItem: Number.isFinite(Number(item.sortItem)) ? Number(item.sortItem) : null, category: String(cat.category || '') });
                    }
                    
                    if (priceEditMode_) {
                        itemRow.setAttribute('data-doc-id', docId);
                        itemRow.innerHTML = `
                            <div class="font-medium text-gray-700 md:w-1/2 min-w-0">${item.name}</div>
                            <div class="flex items-end gap-2 md:w-1/2 justify-end">
                                <button type="button" data-item-drag-handle="${docId}" ${docId ? '' : 'disabled'}
                                        class="inline-flex items-center justify-center w-10 h-10 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition cursor-move disabled:opacity-30 disabled:cursor-not-allowed" title="Перетягнути" aria-label="Перетягнути" draggable="${docId ? 'true' : 'false'}">
                                    <i class="fas fa-grip-vertical"></i>
                                </button>
                                <div class="w-20 border border-gray-300 rounded px-2 py-2 bg-white">
                                    <span class="text-xs text-gray-500 mb-1 block">Сорт</span>
                                    <input data-sort-doc="${docId}" type="number" inputmode="numeric" step="1" min="0"
                                           class="w-full outline-none font-bold text-sm text-right"
                                           value="${sItem == null ? '' : String(sItem)}" ${docId ? '' : 'disabled'} />
                                </div>
                                <div class="w-full md:w-auto border border-gray-300 rounded px-3 py-2 bg-white min-w-[120px]">
                                    <span class="text-xs text-gray-500 mb-1 block">З ПДВ</span>
                                    <input data-price-doc="${docId}" data-price-field="price2" type="number" inputmode="numeric" step="1" min="0"
                                           class="w-full outline-none font-bold text-sm"
                                           value="${Number.isFinite(Number(p2)) ? Number(p2) : ''}" ${docId ? '' : 'disabled'} />
                                </div>
                                <button type="button" data-delete-doc="${docId}" ${docId ? '' : 'disabled'}
                                        class="inline-flex items-center justify-center w-10 h-10 rounded-lg text-red-600 hover:text-red-700 hover:bg-red-50 transition disabled:opacity-30 disabled:hover:bg-transparent" title="Видалити позицію" aria-label="Видалити позицію">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else {
                            const active2 = !!(cart[id] && cart[id].type === 2);
                        itemRow.innerHTML = `
                            <div class="font-medium text-gray-700 md:w-1/2">${item.name}</div>
                            <div class="flex gap-2 md:w-1/2 justify-end">
                                    <button data-item-id="${id}" data-item-type="2" onclick="toggleItem('${id}', '${item.name}', ${item.price1}, ${item.price2}, 2, this, '${item.id ? String(item.id) : ''}', '${cat.category}')" 
                                            class="price-btn w-full md:w-auto border border-gray-300 rounded px-3 py-2 text-center text-sm hover:bg-gray-50 flex flex-col items-center justify-center min-w-[120px] ${active2 ? 'active' : ''}">
                                    <span class="text-xs text-gray-500 mb-1">З ПДВ</span>
                                    <span class="font-bold">${item.price2.toLocaleString()} грн</span>
                                </button>
                            </div>
                        `;
                    }
                    content.appendChild(itemRow);
                });

                details.appendChild(summary);
                details.appendChild(content);
                container.appendChild(details);
            });

            if (priceEditMode_) {
                container.querySelectorAll('input[data-cat-sort]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const cat = String(el.getAttribute('data-cat-sort') || '').trim();
                        if (!cat) return;

                        const raw = String(el.value ?? '').trim();
                        if (!raw) {
                            categorySortEdits_.set(cat, null);
                            return;
                        }
                        const v = Math.floor(Number(raw));
                        if (!Number.isFinite(v) || v < 0) return;
                        categorySortEdits_.set(cat, v);
                    });
                });

                container.querySelectorAll('input[data-price-doc][data-price-field]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const docId = String(el.getAttribute('data-price-doc') || '');
                        const field = String(el.getAttribute('data-price-field') || '');
                        if (!docId) return;

                        const raw = String(el.value ?? '');
                        const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: '' };
                        const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                        const next = { ...prev };

                        // Empty input = don't overwrite; keep fallback to base on save.
                        if (raw.trim() === '') {
                            if (field === 'price1') next.price1 = null;
                            if (field === 'price2') next.price2 = null;
                            priceEdits_.set(docId, next);
                            return;
                        }

                        const v = Number(raw);
                        if (!Number.isFinite(v) || v < 0) return;
                        if (field === 'price1') next.price1 = v;
                        if (field === 'price2') next.price2 = v;
                        priceEdits_.set(docId, next);
                    });
                });

                container.querySelectorAll('input[data-sort-doc]').forEach((inp) => {
                    inp.addEventListener('input', (e) => {
                        const el = e.target;
                        const docId = String(el.getAttribute('data-sort-doc') || '');
                        if (!docId) return;

                        const raw = String(el.value ?? '').trim();
                        const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: '' };
                        const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                        const next = { ...prev };

                        if (!raw) {
                            next.sortItem = null;
                            priceEdits_.set(docId, next);
                            return;
                        }

                        const v = Math.floor(Number(raw));
                        if (!Number.isFinite(v) || v < 0) return;
                        next.sortItem = v;
                        priceEdits_.set(docId, next);
                    });
                });

                container.querySelectorAll('button[data-delete-doc]').forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        const el = e.currentTarget;
                        const docId = String(el.getAttribute('data-delete-doc') || '');
                        if (!docId) return;
                        onPriceDeleteItem_(docId);
                    });
                });

                setupDragSort_();
            }
        }

        function moveArrayItem_(arr, fromIndex, toIndex) {
            if (!Array.isArray(arr)) return;
            const from = Number(fromIndex);
            const to = Number(toIndex);
            if (!Number.isInteger(from) || !Number.isInteger(to)) return;
            if (from < 0 || from >= arr.length) return;
            const clampedTo = Math.max(0, Math.min(arr.length - 1, to));
            if (from === clampedTo) return;
            const [it] = arr.splice(from, 1);
            arr.splice(clampedTo, 0, it);
        }

        function applyAutoSortFromCurrentOrder_() {
            // Categories
            const step = 10;
            for (let i = 0; i < catalogData.length; i++) {
                const cat = catalogData[i];
                const name = String(cat?.category || '').trim();
                if (!name) continue;
                const v = (i + 1) * step;
                categorySortEdits_.set(name, v);
                cat.sortCategory = v;

                // Items
                const items = Array.isArray(cat.items) ? cat.items : [];
                for (let j = 0; j < items.length; j++) {
                    const item = items[j];
                    const docId = String(item?.id || '').trim();
                    const iv = (j + 1) * step;
                    item.sortItem = iv;
                    if (!docId) continue;
                    const base = priceDocSnapshot_.get(docId) || { price1: null, price2: null, sortItem: null, category: name };
                    const prev = priceEdits_.get(docId) || { price1: base.price1, price2: base.price2, sortItem: base.sortItem };
                    priceEdits_.set(docId, { ...prev, sortItem: iv });
                }
            }
        }

        function setupDragSort_() {
            const container = document.getElementById('catalog-container');
            if (!container) return;

            const dragState = window.__gmPriceDragState || (window.__gmPriceDragState = { type: null, cat: null, docId: null });

            // --- Categories ---
            container.querySelectorAll('button[data-cat-drag-handle]').forEach((h) => {
                h.addEventListener('click', (e) => {
                    // Prevent toggling the <details> when clicking the handle.
                    e.preventDefault();
                    e.stopPropagation();
                });
                h.addEventListener('dragstart', (e) => {
                    const cat = String(h.getAttribute('data-cat-drag-handle') || '').trim();
                    if (!cat) return;
                    dragState.type = 'cat';
                    dragState.cat = cat;
                    dragState.docId = null;
                    try {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'cat:' + cat);
                    } catch (err) {}
                });
            });

            container.querySelectorAll('details[data-cat-name]').forEach((d) => {
                d.addEventListener('dragover', (e) => {
                    if (dragState.type !== 'cat') return;
                    e.preventDefault();
                    d.classList.add('ring-2', 'ring-blue-300');
                });
                d.addEventListener('dragleave', () => {
                    d.classList.remove('ring-2', 'ring-blue-300');
                });
                d.addEventListener('drop', (e) => {
                    if (dragState.type !== 'cat') return;
                    e.preventDefault();
                    d.classList.remove('ring-2', 'ring-blue-300');
                    const fromCat = String(dragState.cat || '').trim();
                    const toCat = String(d.getAttribute('data-cat-name') || '').trim();
                    if (!fromCat || !toCat || fromCat === toCat) return;

                    const fromIndex = catalogData.findIndex((c) => String(c?.category || '').trim() === fromCat);
                    const toIndex = catalogData.findIndex((c) => String(c?.category || '').trim() === toCat);
                    if (fromIndex < 0 || toIndex < 0) return;

                    moveArrayItem_(catalogData, fromIndex, toIndex);
                    applyAutoSortFromCurrentOrder_();
                    renderCatalog();
                });
            });

            // --- Items ---
            container.querySelectorAll('button[data-item-drag-handle]').forEach((h) => {
                h.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                h.addEventListener('dragstart', (e) => {
                    const docId = String(h.getAttribute('data-item-drag-handle') || '').trim();
                    if (!docId) return;
                    dragState.type = 'item';
                    dragState.docId = docId;
                    dragState.cat = null;
                    try {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'item:' + docId);
                    } catch (err) {}
                });
            });

            container.querySelectorAll('div[data-doc-id][data-cat-name]').forEach((row) => {
                row.addEventListener('dragover', (e) => {
                    if (dragState.type !== 'item') return;
                    const docId = String(row.getAttribute('data-doc-id') || '').trim();
                    if (!docId) return;
                    e.preventDefault();
                    row.classList.add('ring-2', 'ring-blue-200');
                });
                row.addEventListener('dragleave', () => {
                    row.classList.remove('ring-2', 'ring-blue-200');
                });
                row.addEventListener('drop', (e) => {
                    if (dragState.type !== 'item') return;
                    e.preventDefault();
                    row.classList.remove('ring-2', 'ring-blue-200');

                    const fromDocId = String(dragState.docId || '').trim();
                    const toDocId = String(row.getAttribute('data-doc-id') || '').trim();
                    const catName = String(row.getAttribute('data-cat-name') || '').trim();
                    if (!fromDocId || !toDocId || !catName || fromDocId === toDocId) return;

                    const cat = catalogData.find((c) => String(c?.category || '').trim() === catName);
                    const items = cat && Array.isArray(cat.items) ? cat.items : null;
                    if (!items) return;

                    const fromIndex = items.findIndex((it) => String(it?.id || '').trim() === fromDocId);
                    const targetIndex = items.findIndex((it) => String(it?.id || '').trim() === toDocId);
                    if (fromIndex < 0 || targetIndex < 0) return;

                    const r = row.getBoundingClientRect();
                    const after = e.clientY > (r.top + r.height / 2);
                    let toIndex = after ? (targetIndex + 1) : targetIndex;
                    if (fromIndex < toIndex) toIndex -= 1;
                    toIndex = Math.max(0, Math.min(items.length - 1, toIndex));

                    moveArrayItem_(items, fromIndex, toIndex);
                    applyAutoSortFromCurrentOrder_();
                    renderCatalog();
                });
            });
        }

        function toggleItem(id, name, price1, price2, type, btn, docId, category) {
            const targetType = 2; // fixed: only "З ПДВ"
            const exists = cart[id];

            const keysNow = Object.keys(cart);
            const cartTypeNow = keysNow.length ? (Number(cart[keysNow[0]]?.type) === 2 ? 2 : 1) : null;

            if (exists) {
                // Ensure we have both prices stored for switching.
                if (!Number.isFinite(Number(exists.price1))) exists.price1 = Number(price1);
                if (!Number.isFinite(Number(exists.price2))) exists.price2 = Number(price2);

                // Same type click => toggle off (remove)
                if (Number(exists.type) === targetType) {
                    delete cart[id];
                    syncCatalogActiveStates_();
                    calculateTotal();
                    return;
                }

                // Different type click => do NOT convert other items.
                // Enforce single VAT mode: clear previous selections, then select this item in requested mode.
                cart = {};
                setVatMode_(targetType, false);
                cart[id] = {
                    name,
                    category: String(category || ''),
                    docId: String(docId || ''),
                    price1,
                    price2,
                    type: targetType,
                    price: price2,
                    qty: Math.max(1, Math.floor(Number(exists?.qty) || 1)),
                };
                syncCatalogActiveStates_();
                calculateTotal();
                scheduleCalcSave_();
                return;
            }

            // New selection: enforce single VAT mode.
            // If user selects a different VAT type than the current cart type, turn off previous items.
            if (cartTypeNow != null && cartTypeNow !== targetType) {
                cart = {};
                syncCatalogActiveStates_();
            }
            if (vatMode_ !== targetType) {
                setVatMode_(targetType, false);
            }

            const prevQty = Number.isFinite(Number(cart[id]?.qty)) ? Number(cart[id].qty) : 1;
            cart[id] = {
                name,
                category: String(category || ''),
                docId: String(docId || ''),
                price1,
                price2,
                type: targetType,
                price: price2,
                qty: Math.max(1, Math.floor(prevQty)),
            };
            syncCatalogActiveStates_();
            calculateTotal();
            scheduleCalcSave_();
        }

        function setVatMode_(mode, applyToCart) {
            vatMode_ = 2;
            updateVatToggleUi_();
            updateVat25Ui_();
            if (applyToCart) {
                for (const k of Object.keys(cart)) {
                    const it = cart[k];
                    it.type = vatMode_;
                    const p1 = Number(it.price1);
                    const p2 = Number(it.price2);
                    it.price = Number.isFinite(p2) ? p2 : (Number.isFinite(p1) ? p1 * 1.2 : 0);
                }
                syncCatalogActiveStates_();
            }
            scheduleCalcSave_();
        }

        function computeC2WithVat_() {
            // C2 = total price with VAT for goods (sum of price2 * qty)
            let c2 = 0;
            for (const k of Object.keys(cart)) {
                const it = cart[k];
                const qty = Math.max(1, Math.floor(Number(it?.qty) || 1));
                const p2 = Number(it?.price2);
                const p1 = Number(it?.price1);
                const priceWithVat = Number.isFinite(p2) ? p2 : (Number.isFinite(p1) ? p1 * 1.2 : 0);
                c2 += priceWithVat * qty;
            }
            return c2;
        }

        function updateVat25Ui_() {
            const btn = document.getElementById('vatDiscount25Btn');
            if (!btn) return;

            // Inactive: blue. Active: amber + ring (high visibility).
            btn.classList.toggle('bg-blue-600', !vatDiscount25Active_);
            btn.classList.toggle('hover:bg-blue-700', !vatDiscount25Active_);
            btn.classList.toggle('bg-amber-500', vatDiscount25Active_);
            btn.classList.toggle('hover:bg-amber-600', vatDiscount25Active_);
            btn.classList.toggle('ring-2', vatDiscount25Active_);
            btn.classList.toggle('ring-amber-300', vatDiscount25Active_);
            btn.classList.toggle('ring-offset-1', vatDiscount25Active_);

            btn.setAttribute('aria-pressed', vatDiscount25Active_ ? 'true' : 'false');
        }

        function updateVatToggleUi_() {
            // VAT mode toggle UI was removed; mode is fixed to "З ПДВ".
            vatMode_ = 2;
        }

        function syncCatalogActiveStates_() {
            document.querySelectorAll('.price-btn[data-item-id][data-item-type]').forEach((b) => {
                const id = String(b.getAttribute('data-item-id') || '');
                const t = Number(b.getAttribute('data-item-type'));
                const isActive = !!(id && cart[id] && cart[id].type === t);
                b.classList.toggle('active', isActive);
            });
        }

        function setAdminUi_() {
            const controls = document.getElementById('priceAdminControls');
            const label = document.getElementById('priceEditModeLabel');
            if (controls) controls.classList.toggle('hidden', !priceEditMode_);
            if (label) label.classList.toggle('hidden', !priceEditMode_);

            // Clear-history button is admin-only and only in edit mode.
            const clearBtn = document.getElementById('priceClearChangesBtn');
            if (clearBtn) clearBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));

            const addCatBtn = document.getElementById('priceAddCategoryBtn');
            const addItemBtn = document.getElementById('priceAddItemBtn');
            if (addCatBtn) addCatBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));
            if (addItemBtn) addItemBtn.classList.toggle('hidden', !(priceEditUnlocked_ && priceEditMode_));
        }

        async function onPriceEditToggle_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            priceEditMode_ = !priceEditMode_;
            setAdminUi_();
            renderCatalog();
        }

        async function ensurePriceAdmin_() {
            if (priceEditUnlocked_) return true;

            const pass = prompt('Пароль для редагування прайсу');
            if (pass !== PRICE_ADMIN_PASSWORD) {
                alert('Невірний пароль');
                return false;
            }

            // Sign in as price admin (Email/Password) so Firestore Rules can allow write securely.
            try {
                const api = await initFirebaseForPrice_();
                if (!api?.auth || !api?.authMod?.signInWithEmailAndPassword) {
                    throw new Error('Firebase Auth not available');
                }
                await api.authMod.signInWithEmailAndPassword(api.auth, PRICE_ADMIN_EMAIL, pass);
                console.info('[calc] price admin signed in');
            } catch (e) {
                console.warn('[calc] price admin sign-in failed', e);
                alert('Не вдалося отримати доступ до запису. Створи користувача Email/Password у Firebase Auth з email: ' + PRICE_ADMIN_EMAIL + ' та паролем 123456.');
                return false;
            }

            priceEditUnlocked_ = true;
            setAdminUi_();
            return true;
        }

        async function onPriceClearChanges_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const sure = confirm('Очистити історію змін? Це прибере lastChange/updatedAt у всіх позицій прайсу.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) {
                    alert('Немає даних');
                    return;
                }

                const docs = snap.docs;
                let done = 0;
                for (let i = 0; i < docs.length; i += 450) {
                    const chunk = docs.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);
                    for (const d of chunk) {
                        const ref = api.doc(api.db, 'priceItems', String(d.id));
                        batch.update(ref, {
                            lastChange: api.deleteField(),
                            updatedAt: api.deleteField(),
                        });
                    }
                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] cleared price change history', done, '/', docs.length);
                }

                // Refresh local state
                priceLastChanges_ = [];
                if (priceChangesOpen_) renderLastChanges_();
                await loadCatalogFromFirestore_();
                renderCatalog();
                alert('Історію змін очищено');
            } catch (e) {
                console.warn('[calc] clear price change history failed', e);
                alert('Не вдалося очистити. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceApply_() {
            if (!priceEditUnlocked_ || !priceEditMode_) return;
            if (!priceEdits_.size && !categorySortEdits_.size) {
                alert('Немає змін');
                return;
            }

            // UX: after clicking Save, immediately exit edit mode.
            priceEditMode_ = false;
            setAdminUi_();
            renderCatalog();

            try {
                const api = await initFirebaseForPrice_();
                const updates = Array.from(priceEdits_.entries());
                let done = 0;

                for (let i = 0; i < updates.length; i += 450) {
                    const chunk = updates.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);

                    for (const [docId, v] of chunk) {
                        const base = priceDocSnapshot_.get(String(docId)) || { price1: null, price2: null, sortItem: null, category: '' };
                        const p1 = v?.price1 == null ? Number(base.price1) : Number(v.price1);
                        const p2 = v?.price2 == null ? Number(base.price2) : Number(v.price2);
                        if (!Number.isFinite(p1) || !Number.isFinite(p2)) continue;
                        const sortItem = v?.sortItem == null ? null : Number(v.sortItem);
                        const ref = api.doc(api.db, 'priceItems', String(docId));
                        const from1 = Number(base.price1);
                        const from2 = Number(base.price2);
                        const payload = {
                            price1: p1,
                            price2: p2,
                            ...(sortItem == null ? { sortItem: api.deleteField() } : { sortItem }),
                            updatedAt: api.serverTimestamp(),
                            lastChange: {
                                at: api.serverTimestamp(),
                                fromPrice1: Number.isFinite(from1) ? from1 : null,
                                fromPrice2: Number.isFinite(from2) ? from2 : null,
                                toPrice1: p1,
                                toPrice2: p2,
                            }
                        };
                        batch.set(ref, payload, { merge: true });
                    }

                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] priceItems updated', done, '/', updates.length);
                }

                // Apply category sorting (set sortCategory on all docs within the category).
                if (categorySortEdits_.size) {
                    const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                    const allDocs = snap && snap.docs ? snap.docs : [];
                    const edits = Array.from(categorySortEdits_.entries());
                    for (const [catName, sortCategory] of edits) {
                        const cat = String(catName || '').trim();
                        if (!cat) continue;

                        const docs = allDocs.filter((d) => {
                            const data = d && typeof d.data === 'function' ? d.data() : null;
                            if (!data) return false;
                            if (data.active === false) return false;
                            return String(data.category || '').trim() === cat;
                        });
                        if (!docs.length) continue;

                        for (let i = 0; i < docs.length; i += 450) {
                            const chunk = docs.slice(i, i + 450);
                            const batch = api.writeBatch(api.db);
                            for (const d of chunk) {
                                const ref = api.doc(api.db, 'priceItems', String(d.id));
                                batch.set(ref, {
                                    sortCategory: sortCategory == null ? api.deleteField() : Number(sortCategory),
                                    updatedAt: api.serverTimestamp(),
                                }, { merge: true });
                            }
                            await batch.commit();
                        }
                    }
                }

                priceEdits_.clear();
                categorySortEdits_.clear();
                await loadCatalogFromFirestore_();
                renderCatalog();
                alert('Збережено');
            } catch (e) {
                console.warn('[calc] apply price edits failed', e);
                // Restore edit mode so the user can retry without losing inputs.
                priceEditMode_ = true;
                setAdminUi_();
                renderCatalog();
                alert('Не вдалося зберегти. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        function parsePriceNumber_(raw) {
            const s = String(raw ?? '').trim();
            if (!s) return NaN;
            const cleaned = s.replace(/\s+/g, '').replace(',', '.');
            const v = Number(cleaned);
            return Number.isFinite(v) ? v : NaN;
        }

        function computeNetFromVat_(price2) {
            const p2 = Number(price2);
            if (!Number.isFinite(p2)) return NaN;
            return Math.round(p2 / 1.2);
        }

        function getActiveDocIdSet_() {
            const s = new Set();
            for (const c of (Array.isArray(catalogData) ? catalogData : [])) {
                const items = Array.isArray(c?.items) ? c.items : [];
                for (const it of items) {
                    if (it && it.id) s.add(String(it.id));
                }
            }
            return s;
        }

        function purgeCartByDocIdSet_(allowedDocIds) {
            if (!allowedDocIds || typeof allowedDocIds.has !== 'function') return;
            let changed = false;
            for (const k of Object.keys(cart)) {
                const docId = String(cart[k]?.docId || '');
                if (docId && !allowedDocIds.has(docId)) {
                    delete cart[k];
                    changed = true;
                }
            }
            if (changed) {
                calculateTotal();
                scheduleCalcSave_();
            }
        }

        async function onPriceAddCategory_() {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const cat = prompt('Назва нової категорії');
            if (!cat || !cat.trim()) return;

            // Category exists only through items, so we add the first item immediately.
            await onPriceAddItem_(String(cat).trim());
        }

        async function onPriceAddItem_(prefillCategory) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            if (!priceEditMode_) {
                priceEditMode_ = true;
                setAdminUi_();
                renderCatalog();
            }

            const cats = (Array.isArray(catalogData) ? catalogData : []).map((c) => String(c?.category || '')).filter(Boolean);
            const defaultCat = prefillCategory || cats[0] || '';
            const cat = prompt('Категорія (можна ввести нову)\n\nІснуючі: ' + (cats.join(', ') || '—'), defaultCat);
            if (!cat || !cat.trim()) return;

            const name = prompt('Назва позиції', 'Нова позиція');
            if (!name || !name.trim()) return;

            const p2Raw = prompt('Ціна З ПДВ (грн)', '0');
            if (p2Raw == null) return;
            const p2 = Math.round(parsePriceNumber_(p2Raw));
            if (!Number.isFinite(p2) || p2 < 0) {
                alert('Некоректна ціна');
                return;
            }
            const p1 = computeNetFromVat_(p2);
            if (!Number.isFinite(p1) || p1 < 0) {
                alert('Не вдалося розрахувати базову ціну');
                return;
            }

            try {
                const api = await initFirebaseForPrice_();
                const col = api.collection(api.db, 'priceItems');
                if (!api.addDoc) throw new Error('Firestore addDoc not available');
                await api.addDoc(col, {
                    category: String(cat).trim(),
                    name: String(name).trim(),
                    price1: p1,
                    price2: p2,
                    active: true,
                    updatedAt: api.serverTimestamp(),
                    lastChange: {
                        at: api.serverTimestamp(),
                        fromPrice1: null,
                        fromPrice2: null,
                        toPrice1: p1,
                        toPrice2: p2,
                    }
                });

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] add price item failed', e);
                alert('Не вдалося додати позицію. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceDeleteItem_(docId) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const sure = confirm('Видалити позицію? Вона зникне з прайсу.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const ref = api.doc(api.db, 'priceItems', String(docId));
                if (!api.setDoc) throw new Error('Firestore setDoc not available');
                await api.setDoc(ref, {
                    active: false,
                    updatedAt: api.serverTimestamp(),
                }, { merge: true });

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] delete price item failed', e);
                alert('Не вдалося видалити. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        async function onPriceDeleteCategory_(categoryName) {
            const ok = await ensurePriceAdmin_();
            if (!ok) return;

            const cat = String(categoryName || '').trim();
            if (!cat) return;

            const sure = confirm('Видалити категорію "' + cat + '"? Це прибере всі позиції в цій категорії.');
            if (!sure) return;

            try {
                const api = await initFirebaseForPrice_();
                const snap = await api.getDocs(api.collection(api.db, 'priceItems'));
                if (!snap || snap.empty) {
                    alert('Немає даних');
                    return;
                }

                const docs = snap.docs.filter((d) => {
                    const data = d && typeof d.data === 'function' ? d.data() : null;
                    if (!data) return false;
                    if (data.active === false) return false;
                    return String(data.category || '').trim() === cat;
                });

                if (!docs.length) {
                    alert('У категорії немає активних позицій');
                    return;
                }

                let done = 0;
                for (let i = 0; i < docs.length; i += 450) {
                    const chunk = docs.slice(i, i + 450);
                    const batch = api.writeBatch(api.db);
                    for (const d of chunk) {
                        const ref = api.doc(api.db, 'priceItems', String(d.id));
                        batch.set(ref, {
                            active: false,
                            updatedAt: api.serverTimestamp(),
                        }, { merge: true });
                    }
                    await batch.commit();
                    done += chunk.length;
                    console.info('[calc] category deactivated', cat, done, '/', docs.length);
                }

                await loadCatalogFromFirestore_();
                renderCatalog();
                purgeCartByDocIdSet_(getActiveDocIdSet_());
            } catch (e) {
                console.warn('[calc] delete category failed', e);
                alert('Не вдалося видалити категорію. Перевір Firestore Rules для /priceItems (write) та доступ користувача.');
            }
        }

        function parseInput(val, total) {
            if (!val) return 0;
            val = val.trim();
            if (val.includes('%')) {
                const percent = parseFloat(val.replace('%', ''));
                return isNaN(percent) ? 0 : (total * percent / 100);
            }
            const num = parseFloat(val.replace(/\s/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function calculateTotal() {
            let itemsTotal = 0;
            const receiptItemsContainer = document.getElementById('receipt-items');
            receiptItemsContainer.innerHTML = '';
            
            if (Object.keys(cart).length === 0) {
                receiptItemsContainer.innerHTML = '<div class="text-center text-gray-400 italic">Товари не обрані</div>';
            }

            for (let key in cart) {
                const item = cart[key];
                const qty = Math.max(1, Math.floor(Number(item.qty) || 1));
                item.qty = qty;

                const lineTotal = item.price * qty;
                itemsTotal += lineTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = "flex items-start justify-between text-gray-700 gap-2";
                itemDiv.innerHTML = `
                    <div class="min-w-0 flex-1">
                        <div class="truncate pr-2">${item.name}</div>
                        <div class="mt-1 flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">К-сть</span>
                            <input type="number" min="1" step="1" value="${qty}" data-qty-key="${key}"
                                   class="w-16 px-2 py-1 border border-gray-200 rounded text-sm text-right outline-none focus:ring-2 focus:ring-gray-300" />
                        </div>
                    </div>
                    <div class="flex items-start gap-2 whitespace-nowrap">
                        <div class="text-right font-semibold">${lineTotal.toLocaleString()} грн</div>
                        <button type="button" title="Видалити" aria-label="Видалити" data-remove-key="${key}"
                                class="text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                receiptItemsContainer.appendChild(itemDiv);
            }

            // Qty change handlers (avoid recursive re-render on each keystroke)
            receiptItemsContainer.querySelectorAll('input[data-qty-key]').forEach((inp) => {
                inp.addEventListener('change', (e) => {
                    const el = e.target;
                    const k = String(el.getAttribute('data-qty-key') || '');
                    if (!k || !cart[k]) return;
                    const v = Math.max(1, Math.floor(Number(el.value) || 1));
                    cart[k].qty = v;
                    calculateTotal();
                    scheduleCalcSave_();
                });
            });

            receiptItemsContainer.querySelectorAll('button[data-remove-key]').forEach((btn) => {
                btn.addEventListener('click', (e) => {
                    const el = e.currentTarget;
                    const k = String(el.getAttribute('data-remove-key') || '');
                    if (!k || !cart[k]) return;
                    delete cart[k];

                    // Clear active state on catalog buttons for this item id
                    document.querySelectorAll(`.price-btn[data-item-id="${CSS.escape(k)}"]`).forEach((b) => b.classList.remove('active'));

                    // VAT mode is fixed to "З ПДВ".
                    const keys = Object.keys(cart);
                    if (keys.length) {
                        setVatMode_(2, true);
                    } else {
                        setVatMode_(2, false);
                    }
                    calculateTotal();
                    scheduleCalcSave_();
                });
            });

            let deliveryCost = selectedDelivery;
            let baseTotal = itemsTotal + deliveryCost;

            const discountEl = document.getElementById('discount-input');
            const markupEl = document.getElementById('markup-input');
            const discountInput = String(discountEl?.value ?? '');
            const markupInput = String(markupEl?.value ?? '');

            const discountVal = parseInput(discountInput, baseTotal);
            const markupVal = parseInput(markupInput, baseTotal);

            // "РАЗОМ" before compensation (includes discount/markup).
            const totalBeforeComp = baseTotal - discountVal + markupVal;

            // 25% mode is a VISUAL "state compensation" indicator.
            // It must be calculated ONLY from the final total "РАЗОМ" (y) before compensation.
            // бухгалтерськи: ПДВ = y/6; база без ПДВ = y - ПДВ; компенсація = 25% від бази.
            let compensationVal = 0;
            if (vatDiscount25Active_) {
                const y = totalBeforeComp;
                const vat = y > 0 ? (y / 6) : 0;
                const net = y - vat;
                compensationVal = net > 0 ? (net * 0.25) : 0;
            }

            const finalTotal = totalBeforeComp - compensationVal;

            document.getElementById('receipt-subtotal').innerHTML = `<span>Сума товарів:</span> <span class="font-bold">${itemsTotal.toLocaleString()} грн</span>`;
            document.getElementById('receipt-delivery').innerHTML = `<span>Доставка:</span> <span>${deliveryCost > 0 ? '+' : ''}${deliveryCost.toLocaleString()} грн</span>`;
            
            const discElem = document.getElementById('receipt-discount');
            if (discountVal > 0) {
                discElem.classList.remove('hidden');
                discElem.innerHTML = `<span>Знижка:</span> <span>-${Math.round(discountVal).toLocaleString()} грн</span>`;
            } else {
                discElem.classList.add('hidden');
            }

            const compElem = document.getElementById('receipt-compensation');
            if (compElem) {
                if (compensationVal > 0) {
                    compElem.classList.remove('hidden');
                    compElem.innerHTML = `<span>Компенсація:</span> <span>-${Math.round(compensationVal).toLocaleString()} грн</span>`;
                } else {
                    compElem.classList.add('hidden');
                }
            }

            const markElem = document.getElementById('receipt-markup');
            if (markupVal > 0) {
                markElem.classList.remove('hidden');
                markElem.innerHTML = `<span>Націнка:</span> <span>+${Math.round(markupVal).toLocaleString()} грн</span>`;
            } else {
                markElem.classList.add('hidden');
            }

            document.getElementById('final-total').textContent = `${Math.round(finalTotal).toLocaleString()} грн`;

            // Persist state after recalculation (debounced).
            scheduleCalcSave_();
        }

        function clearCart() {
            cart = {};
            selectedDelivery = 0;
            vatMode_ = 2;
            vatDiscount25Active_ = false;
            updateVatToggleUi_();
            updateVat25Ui_();
            document.querySelectorAll('.price-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#delivery-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('discount-input').value = '';
            document.getElementById('markup-input').value = '';
            setDeliveryMenuCollapsed(false);
            calculateTotal();
            clearCalcState_();
        }

	  function scrollToBottom() {
            document.getElementById('calculator-section').scrollIntoView({ behavior: 'smooth' });
        }

        function collapseAllCatalog() {
            document.querySelectorAll('#catalog-container details[open]').forEach((d) => {
                d.open = false;
            });
        }

        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const nav = document.querySelector('.nav');
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            hamburger.classList.toggle('open');
        });

    </script>
</body>
</html>
