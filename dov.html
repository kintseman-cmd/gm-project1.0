<!DOCTYPE html>
<html lang="uk">
<head>
    <script>
        (function () {
            try {
                document.documentElement.classList.add('pagefx');
                window.setTimeout(function () {
                    document.documentElement.classList.add('pagefx-ready');
                }, 900);
            } catch (e) {}
        })();
    </script>
    <style>html.pagefx:not(.pagefx-ready) body{opacity:0}</style>
    <link rel="stylesheet" href="assets/page-transitions.css">
    <script src="assets/page-transitions.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="assets/bottom-nav.css" />
    <script src="assets/bottom-nav.js" defer></script>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="manifest" href="manifest-dov.webmanifest">
    <meta name="theme-color" content="#F4C430">
    <title>CRM - Авторизація та Менеджери</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        (function () {
            try {
                const params = new URLSearchParams(location.search);
                const isEmbed = params.get('embed') === '1';
                const inIframe = (function () {
                    try { return window.self !== window.top; } catch (e) { return true; }
                })();

                if (isEmbed && inIframe) {
                    document.documentElement.classList.add('embed');
                    return;
                }
                    if (location.protocol === 'file:') {
                        return;
                    }

                const target = new URL(location.href);
                target.search = '';
                target.pathname = target.pathname.replace(/[^/]+\.html$/i, 'index.html');
                target.hash = '#plan';
                location.replace(target.toString());
            } catch (e) {}
        })();
    </script>
    <style>
        html, body { overflow-x: hidden; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; padding-top: 60px; }
        
        /* Glass effect - optimized for performance */
        .glass { 
            background: rgba(255, 255, 255, 0.97);
            /* backdrop-filter disabled on desktop for performance */
        }
        @media (max-width: 768px) {
            .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        }
        
        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Toast animation */
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        
        .progress-ring { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .salary-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .login-bg { background: radial-gradient(circle at top right, #3b82f6, #1e293b); }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .logo h1 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 800;
        }

        .nav {
            display: flex;
        }

        .nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 30px;
        }

        .nav-link {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            background: #4CAF50;
            color: #fff;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background: #333;
            margin: 3px 0;
            transition: 0.3s;
        }

        /* Mobile header */
        @media (max-width: 768px) {
            body { padding-top: 60px; }

            .header-container {
                padding: 10px 15px;
            }

            .logo h1 {
                font-size: 20px;
            }

            .nav {
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                height: calc(100vh - 60px);
                background: #fff;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 50px;
                opacity: 0;
                transform: translateY(-6px);
                pointer-events: none;
                transition: opacity 100ms ease, transform 100ms ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                z-index: 999;
            }

            .nav.open {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }

            .nav-list {
                flex-direction: column;
                gap: 20px;
                width: 100%;
                align-items: center;
                padding: 0;
                box-sizing: border-box;
            }

            .nav-item {
                width: 100%;
                display: flex;
                justify-content: center;
                opacity: 0;
                transform: translateX(-18px);
                transition: transform 100ms ease, opacity 100ms ease;
            }

            .nav-item:nth-child(even) {
                transform: translateX(18px);
            }

            .nav.open .nav-item {
                opacity: 1;
                transform: translateX(0);
            }

            @media (prefers-reduced-motion: reduce) {
                .nav,
                .nav-item {
                    transition: none;
                    transform: none;
                }
            }

            .nav-link {
                font-size: 18px;
                padding: 14px 18px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: min(340px, 88vw);
                height: 54px;
                box-sizing: border-box;
                gap: 10px;
                text-align: center;
            }

            .nav-link i {
                width: 22px;
                text-align: center;
                margin-right: 0 !important;
                display: inline-block;
                flex: 0 0 22px;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.open .bar:nth-child(1) {
                transform: rotate(-45deg) translate(-5px, 6px);
            }

            .hamburger.open .bar:nth-child(2) {
                opacity: 0;
            }

            .hamburger.open .bar:nth-child(3) {
                transform: rotate(45deg) translate(-5px, -6px);
            }
        }

        /* Embedded mode (inside index.html) */
        html.embed .header { display: none !important; }
        html.embed body { padding-top: 0 !important; }

        /* CRM small-screen fixes */
        #orderForm > div { min-width: 0; }
        #historyBody td { overflow-wrap: anywhere; }

        /* iOS modal scroll + background scroll lock */
        .modal-scroll {
            max-height: calc(100vh - 170px);
            max-height: calc(100dvh - 170px);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            overscroll-behavior-x: none;
        }

        /* Mobile: ensure content doesn't go under bottom nav */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(var(--gm-bottom-nav-height, 64px) + env(safe-area-inset-bottom, 0px) + 16px) !important;
            }

            /* Main content area needs bottom spacing */
            main.container {
                padding-bottom: calc(var(--gm-bottom-nav-height, 64px) + env(safe-area-inset-bottom, 0px) + 24px) !important;
            }

            /* History table bottom margin */
            .max-h-\[300px\] table {
                margin-bottom: calc(var(--gm-bottom-nav-height, 64px) + 60px) !important;
            }

            /* Modals: account for bottom nav */
            #orderModal > div.relative,
            #exportModal > div.relative {
                padding-bottom: calc(var(--gm-bottom-nav-height, 64px) + env(safe-area-inset-bottom, 0px) + 16px) !important;
            }

            .modal-scroll {
                max-height: calc(100dvh - 200px - var(--gm-bottom-nav-height, 64px)) !important;
            }

            /* Filter dropdowns: ensure they don't get cut off */
            #dateFilterDropdown,
            #statusFilterDropdown {
                max-height: calc(50vh - var(--gm-bottom-nav-height, 64px)) !important;
            }

            /* Auth overlay stays full screen */
            #authOverlay {
                padding-bottom: 0 !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 text-slate-900 gm-safe-bottom">

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <h1>General Machines</h1>
            </div>
            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="index.html#gm-script" class="nav-link"><i class="fas fa-file-code mr-2"></i>Скрипти</a></li>
                    <li class="nav-item"><a href="calc.html" class="nav-link"><i class="fas fa-calculator mr-2"></i>Прайс</a></li>
                    <li class="nav-item"><a href="dov.html" class="nav-link active"><i class="fas fa-calendar-check mr-2"></i>План</a></li>
                    <li class="nav-item"><a href="generator-ankety.html" class="nav-link"><i class="fas fa-file-excel mr-2"></i>Анкета</a></li>
                    <li class="nav-item"><a href="education.html" class="nav-link"><i class="fas fa-graduation-cap mr-2"></i>Навчання</a></li>
                </ul>
            </nav>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </header>

    <!-- Auth Overlay -->
    <div id="authOverlay" class="fixed inset-0 z-[100] login-bg flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800">Вхід у систему</h2>
                <p class="text-slate-500 text-sm">Оберіть профіль та введіть пароль</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Менеджер</label>
                    <select id="managerSelect" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="OleksandrNamistnyk">Олександр Намістник</option>
                        <option value="AndriyPashyk">Андрій Пашик</option>
                        <option value="OleksandrDenisov">Олександр Денисов</option>
                        <option value="ArturEvtushenko">Артур Євтушенко</option>
                        <option value="IvanYakushik">Іван Якушик</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Пароль</label>
                    <input type="password" id="passInput" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all">
                    Увійти
                </button>
                <p id="loginError" class="text-red-500 text-xs text-center hidden font-bold">Невірний пароль!</p>
            </div>
        </div>
    </div>

    <!-- Main Content (Hidden by default) -->
    <div id="appContent" class="hidden">
        <!-- Header -->
        <nav class="bg-slate-900 text-white p-4 shadow-lg mb-8">
            <div class="container mx-auto flex justify-between items-center flex-wrap gap-2">
                <div class="flex items-center gap-2 md:gap-4 flex-wrap">
                    <h1 class="text-lg md:text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-wallet text-blue-400"></i> <span id="displayMonth">Грудень</span>
                    </h1>
                    <div class="hidden md:block h-6 w-px bg-slate-700"></div>
                    <div class="text-xs md:text-sm font-medium text-blue-300">
                        <i class="fa-solid fa-user-tie"></i> <span id="currentManagerName">Менеджер</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4 flex-wrap justify-end">
                    <button onclick="togglePlans()" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/60 hover:bg-slate-700/70 text-slate-100 transition-colors text-sm font-semibold whitespace-nowrap">
                        <i class="fa-solid fa-flag"></i> <span>Плани</span>
                    </button>
                    <button onclick="toggleSettings()" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/60 hover:bg-slate-700/70 text-slate-100 transition-colors text-sm font-semibold whitespace-nowrap">
                        <i class="fa-solid fa-gear"></i> <span>Налаштування</span>
                    </button>
                    <button onclick="logout()" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/15 hover:bg-red-500/25 text-red-200 transition-colors text-sm font-semibold whitespace-nowrap">
                        <i class="fa-solid fa-right-from-bracket"></i> <span>Вихід</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto px-4 max-w-6xl">
            <!-- Settings Panel -->
            <div id="settingsPanel" class="hidden mb-8 glass p-6 rounded-2xl border border-blue-200 shadow-xl">
                <div class="flex items-center justify-between gap-3 mb-2">
                    <h3 class="text-lg font-bold">Налаштування</h3>
                    <span class="text-xs text-slate-500">Скоро</span>
                </div>
                <div class="text-sm text-slate-500">Поки що немає налаштувань.</div>
            </div>

            <!-- Plans Panel -->
            <div id="plansPanel" class="hidden mb-8 glass p-6 rounded-2xl border border-blue-200 shadow-xl">
                <div class="flex items-center justify-between gap-3 mb-2">
                    <h3 class="text-lg font-bold">Плани</h3>
                    <span class="text-xs text-slate-500">Зберігається в БД</span>
                </div>
                <div class="flex items-center justify-end">
                    <button type="button" id="addPlanBtn" class="px-4 py-3 rounded-2xl bg-blue-600 text-white font-semibold">Додати план</button>
                </div>

                <div id="addPlanPanel" class="hidden mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Рік</label>
                            <input type="number" id="addPlanYear" min="2000" max="2100" placeholder="2025" class="w-full p-3 rounded-2xl bg-slate-50 border border-slate-200">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Місяць</label>
                            <select id="addPlanMonth" class="w-full p-3 rounded-2xl bg-slate-50 border border-slate-200"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Сума, ₴</label>
                            <input type="number" id="addPlanGoal" min="0" placeholder="0" class="w-full p-3 rounded-2xl bg-slate-50 border border-slate-200">
                        </div>
                        <div class="md:col-span-3 flex justify-end gap-2">
                                    <button type="button" id="addPlanCancelBtn" class="px-4 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold transition-colors">Скасувати</button>
                                    <button type="button" id="addPlanSaveBtn" class="px-4 py-3 rounded-2xl bg-slate-800 hover:bg-slate-900 text-white font-semibold transition-colors disabled:cursor-not-allowed">Зберегти</button>
                                </div>
                    </div>
                </div>

                <div class="mt-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs font-bold text-slate-400 uppercase">Збережені плани</div>
                        <div class="text-xs text-slate-400">Редагування локально</div>
                    </div>
                    <div id="plansList" class="space-y-2"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left Column: Salary & Stats -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="salary-card p-6 rounded-3xl shadow-2xl text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="opacity-70 text-xs font-bold uppercase mb-1">Особиста Зарплата</h3>
                            <div id="salaryAmount" class="text-5xl font-black mb-4 text-blue-400 text-shadow-lg">40,000 ₴</div>
                            
                            <div class="space-y-4">
                                <div>
                                    <div class="flex flex-col sm:flex-row sm:justify-between gap-1 text-xs mb-1 opacity-70 min-w-0">
                                        <span class="whitespace-nowrap">Ставка: 40к</span>
                                        <span class="sm:text-right">План (50%): <span id="goalMidLabel">500к</span></span>
                                    </div>
                                    <div class="w-full bg-white/10 h-2 rounded-full overflow-hidden">
                                        <div id="salaryBar" class="bg-blue-500 h-full transition-all" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 pt-2">
                                    <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                                        <div class="text-[10px] uppercase opacity-50">Бонус за план</div>
                                        <div id="bonusLabel" class="text-lg font-bold text-green-400">+0 ₴</div>
                                    </div>
                                    <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                                        <div class="text-[10px] uppercase opacity-50">Понад план (1%)</div>
                                        <div id="extraLabel" class="text-lg font-bold text-yellow-400">+0 ₴</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-3xl shadow-sm border border-slate-200 text-center">
                        <div class="flex justify-end mb-2">
                            <div class="relative inline-flex items-center gap-2">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Період</span>
                                <button type="button" id="progressPeriodBtn" class="p-2 rounded-xl bg-slate-50 border border-slate-200 text-xs font-semibold">
                                    Обрати місяці
                                </button>
                                <div id="progressPeriodMenu" class="hidden absolute right-0 top-full mt-2 w-64 max-h-64 overflow-auto bg-white border border-slate-200 rounded-2xl shadow-lg p-3 text-left z-10"></div>
                            </div>
                        </div>
                        <div class="relative inline-flex items-center justify-center">
                            <svg width="180" height="180">
                                <circle stroke="#f1f5f9" stroke-width="14" fill="transparent" r="80" cx="90" cy="90"/>
                                <circle id="progressCircle" stroke="#3b82f6" stroke-width="14" stroke-dasharray="502" stroke-dashoffset="502" stroke-linecap="round" fill="transparent" r="80" cx="90" cy="90" class="progress-ring"/>
                            </svg>
                            <div class="absolute">
                                <div id="percentLabel" class="text-4xl font-black text-slate-800">0%</div>
                                <div class="text-[10px] text-slate-400 uppercase font-bold">мій план</div>
                            </div>
                        </div>

                        <div class="mt-3 flex justify-center">
                            <label class="inline-flex items-center gap-2 text-xs font-semibold text-slate-600 select-none cursor-pointer">
                                <input id="conversionToggle" type="checkbox" class="h-4 w-4 rounded border-slate-300" checked>
                                <span>Конверсія</span>
                            </label>
                        </div>

                        <div class="mt-4 flex flex-col sm:flex-row sm:justify-between gap-3 text-sm px-4">
                            <div class="text-left">
                                <div class="text-slate-400 text-[10px] uppercase font-bold">Продано мною</div>
                                <div id="totalSalesLabel" class="font-bold text-slate-800 text-lg break-words">0 ₴</div>
                            </div>
                            <div class="text-right">
                                <div class="text-slate-400 text-[10px] uppercase font-bold text-red-400">Залишилось</div>
                                <div id="remainingLabel" class="font-bold text-red-500 text-lg break-words">0 ₴</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Form & History -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="glass p-6 rounded-3xl shadow-sm border border-slate-200">
                        <button type="button" id="openOrderModalBtn" class="w-full flex items-center justify-between gap-3 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-4 shadow-lg transition-all">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid fa-plus-circle"></i>
                                Нове замовлення
                            </span>
                            <i class="fa-solid fa-chevron-right opacity-90"></i>
                        </button>
                        <div class="mt-3 text-xs text-slate-500">Натисніть, щоб відкрити форму додавання замовлення</div>
                    </div>

                    <div class="glass rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                        <div class="p-5 bg-slate-50/50 flex flex-col gap-3 border-b border-slate-100 relative z-20">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 font-bold text-xs uppercase tracking-wider text-slate-500">
                                <span>Мої продажі</span>
                                <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto justify-start sm:justify-end">
                                    <button type="button" id="showShipmentNotifBtn" title="Показати ближні відгрузки" class="w-10 sm:w-auto text-xs font-bold tracking-wider px-3 py-2 rounded-xl bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors flex items-center justify-center gap-1">
                                        <i class="fa-solid fa-truck"></i>
                                        <span class="hidden sm:inline">Відгрузки</span>
                                    </button>
                                    <button type="button" id="openExportModalBtn" class="w-full sm:w-auto text-xs font-bold tracking-wider px-3 py-2 rounded-xl bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors">
                                        Експорт
                                    </button>
                                    <div id="connectionStatus" class="w-full sm:w-auto text-center text-xs text-green-600 bg-green-50 px-3 py-2 rounded-xl">З'єднано</div>
                                </div>
                            </div>
                            <!-- Сортування та фільтрація -->
                            <div class="flex flex-wrap items-center gap-2">
                                <button type="button" id="sortByDateBtn" data-sort-dir="desc" class="flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 transition">
                                    <i class="fa-solid fa-calendar-days text-[10px]"></i>
                                    <span>Дата</span>
                                    <i class="fa-solid fa-arrow-down text-[9px]" id="sortDateIcon"></i>
                                </button>
                                <div class="relative inline-block" id="dateFilterWrapper">
                                    <button type="button" id="dateFilterBtn" class="flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200 transition">
                                        <i class="fa-solid fa-calendar-week text-[10px]"></i>
                                        <span id="dateFilterLabel">Всі дати</span>
                                        <i class="fa-solid fa-chevron-down text-[8px]"></i>
                                    </button>
                                    <div id="dateFilterDropdown" class="hidden absolute left-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl z-[100] min-w-[200px] py-1 max-h-[300px] overflow-y-auto">
                                        <div data-filter-date="" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer border-b border-slate-100 font-medium">Всі дати</div>
                                        <div data-filter-date="this_week" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer">Цей тиждень</div>
                                        <div data-filter-date="last_week" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer">Минулий тиждень</div>
                                        <div data-filter-date="this_month" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer">Цей місяць</div>
                                        <div data-filter-date="last_month" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer">Минулий місяць</div>
                                    </div>
                                </div>
                                <div class="relative inline-block" id="statusFilterWrapper">
                                    <button type="button" id="statusFilterBtn" class="flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200 transition">
                                        <i class="fa-solid fa-filter text-[10px]"></i>
                                        <span id="statusFilterLabel">Всі статуси</span>
                                        <i class="fa-solid fa-chevron-down text-[8px]"></i>
                                    </button>
                                    <div id="statusFilterDropdown" class="hidden absolute left-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl z-[100] min-w-[200px] py-1 max-h-[300px] overflow-y-auto">
                                        <div data-filter-status="" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer border-b border-slate-100 font-medium">Всі статуси</div>
                                        <div data-filter-status="no_status" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer">— Без статусу —</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="max-h-[300px] lg:max-h-[375px] overflow-y-auto overflow-x-hidden relative z-10">
                            <table class="w-full text-left table-fixed mb-24 sm:mb-4">
                                <tbody id="historyBody" class="text-sm divide-y divide-slate-100">
                                    <tr><td class="p-10 text-center text-slate-400 italic">Синхронізація...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: New Order -->
    <div id="orderModal" class="hidden fixed inset-0 z-50">
        <div id="orderModalBackdrop" class="absolute inset-0 bg-slate-900/50"></div>
        <div class="relative w-full h-full flex items-end sm:items-center justify-center p-3 sm:p-6">
            <div class="w-full max-w-xl glass rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
                <div class="p-4 sm:p-6 bg-slate-50/60 flex items-center justify-between gap-3 border-b border-slate-100">
                    <div class="flex items-center gap-2 font-bold text-slate-800">
                        <i id="orderModalIcon" class="fa-solid fa-plus-circle text-blue-600"></i>
                        <span id="orderModalTitle">Нове замовлення</span>
                    </div>
                    <button type="button" id="closeOrderModalBtn" class="w-10 h-10 rounded-2xl bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors flex items-center justify-center" aria-label="Закрити">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="p-4 sm:p-6 modal-scroll">
                    <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="editingOrderId" value="">
                        <input type="hidden" id="editingOrderPrevAmount" value="">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Дата</label>
                            <input type="date" id="orderDate" required
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Дата відгрузки <span class="text-slate-300 font-normal normal-case">(опціонально)</span></label>
                            <input type="date" id="orderShipmentDate"
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Платник</label>
                            <input type="text" id="payer" required placeholder="Назва клієнта"
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Посилання в CRM (опціонально)</label>
                            <input type="url" id="orderCrmLink" placeholder="https://..."
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Область</label>
                            <select id="regionSelect" class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Оберіть область</option>
                                <option value="Вінницька">Вінницька</option>
                                <option value="Волинська">Волинська</option>
                                <option value="Дніпропетровська">Дніпропетровська</option>
                                <option value="Донецька">Донецька</option>
                                <option value="Житомирська">Житомирська</option>
                                <option value="Закарпатська">Закарпатська</option>
                                <option value="Запорізька">Запорізька</option>
                                <option value="Івано-Франківська">Івано-Франківська</option>
                                <option value="Київська">Київська</option>
                                <option value="Кіровоградська">Кіровоградська</option>
                                <option value="Луганська">Луганська</option>
                                <option value="Львівська">Львівська</option>
                                <option value="Миколаївська">Миколаївська</option>
                                <option value="Одеська">Одеська</option>
                                <option value="Полтавська">Полтавська</option>
                                <option value="Рівненська">Рівненська</option>
                                <option value="Сумська">Сумська</option>
                                <option value="Тернопільська">Тернопільська</option>
                                <option value="Харківська">Харківська</option>
                                <option value="Херсонська">Херсонська</option>
                                <option value="Хмельницька">Хмельницька</option>
                                <option value="Черкаська">Черкаська</option>
                                <option value="Чернівецька">Чернівецька</option>
                                <option value="Чернігівська">Чернігівська</option>
                                <option value="м. Київ">м. Київ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Сума (₴)</label>
                            <input type="number" id="amount" required placeholder="0.00"
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Додаткові пункти / позиції (опціонально)</label>
                            <input type="text" id="orderItems" placeholder="Напр.: ЛН 2.6; ковш 2.2; доставка"
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Коментар (опціонально)</label>
                            <input type="text" id="orderComment" placeholder="Будь-які примітки по замовленню"
                                class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Статус</label>
                            <select id="orderStatus" class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- Без статусу --</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 flex items-end">
                            <button type="submit" id="submitBtn" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all">
                                Додати
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Export -->
    <div id="exportModal" class="hidden fixed inset-0 z-50">
        <div id="exportModalBackdrop" class="absolute inset-0 bg-slate-900/50"></div>
        <div class="relative w-full h-full flex items-end sm:items-center justify-center p-3 sm:p-6">
            <div class="w-full max-w-xl glass rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
                <div class="p-4 sm:p-6 bg-slate-50/60 flex items-center justify-between gap-3 border-b border-slate-100">
                    <div class="flex items-center gap-2 font-bold text-slate-800">
                        <i class="fa-solid fa-file-export text-slate-700"></i>
                        <span>Експорт</span>
                    </div>
                    <button type="button" id="closeExportModalBtn" class="w-10 h-10 rounded-2xl bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors flex items-center justify-center" aria-label="Закрити">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="p-4 sm:p-6 modal-scroll">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Дата з</label>
                            <input type="date" id="exportFromDate" aria-label="Дата з" class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-0 sm:ml-1 text-center sm:text-left">Дата по</label>
                            <input type="date" id="exportToDate" aria-label="Дата по" class="w-full p-3 sm:p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                    </div>

                    <div class="mt-4 flex flex-col sm:flex-row gap-2 sm:justify-end">
                        <button type="button" id="cancelExportBtn" class="w-full sm:w-auto px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 font-bold">
                            Скасувати
                        </button>
                        <button type="button" id="exportOrdersBtn" class="w-full sm:w-auto px-4 py-3 rounded-2xl bg-slate-800 text-white font-bold">
                            Експорт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- КОНФІГУРАЦІЯ МЕНЕДЖЕРІВ ---
        const MANAGERS = {
            'OleksandrNamistnyk': { name: 'Олександр Намістник', pass: '1111' },
            'AndriyPashyk': { name: 'Андрій Пашик', pass: '2222' },
            'OleksandrDenisov': { name: 'Олександр Денисов', pass: '3333' },
            'ArturEvtushenko': { name: 'Артур Євтушенко', pass: '4444' },
            'IvanYakushik': { name: 'Іван Якушик', pass: '5555' },
            'manager6': { name: 'Адмін', pass: '6666' }
        };

        // Order statuses with colors
        const ORDER_STATUSES = {
            'not_paid': { label: 'Не оплачено', bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-300' },
            'preorder_unpaid': { label: 'Передзамовлення не оплачено', bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-300' },
            'preorder_paid': { label: 'Передзамовлення оплачено', bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-300' },
            'fully_paid': { label: 'Повністю оплачено', bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-300' },
            'partially_paid': { label: 'Частково оплачено', bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-300' },
            'pay_on_delivery': { label: 'Оплата при отриманні', bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-300' },
            'done': { label: 'Готово', bg: 'bg-slate-200', text: 'text-slate-700', border: 'border-slate-400' }
        };

        // Стан сортування та фільтрації
        window.__sortFilterState = { sortDir: 'desc', filterStatus: '', filterDate: '' };

        // Ініціалізація dropdown статусів для фільтру
        (function initStatusFilterDropdown() {
            const dropdown = document.getElementById('statusFilterDropdown');
            if (!dropdown) return;
            for (const [key, st] of Object.entries(ORDER_STATUSES)) {
                const div = document.createElement('div');
                div.setAttribute('data-filter-status', key);
                div.className = 'px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer flex items-center gap-2';
                div.innerHTML = `<span class="w-2 h-2 rounded-full ${st.bg} ${st.border} border"></span>${st.label}`;
                dropdown.appendChild(div);
            }
        })();

        function escapeHtml_(v) {
            return String(v ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getStatusOptions_(selectedValue) {
            let html = '<option value="">-- Без статусу --</option>';
            for (const [key, st] of Object.entries(ORDER_STATUSES)) {
                const sel = selectedValue === key ? 'selected' : '';
                html += `<option value="${key}" ${sel}>${st.label}</option>`;
            }
            return html;
        }

        function renderStatusBadge_(statusKey) {
            if (!statusKey || !ORDER_STATUSES[statusKey]) return '';
            const st = ORDER_STATUSES[statusKey];
            return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold ${st.bg} ${st.text} ${st.border} border">${st.label}</span>`;
        }

        function renderQuickStatusButtons_(orderId, rowId, currentStatus) {
            let optionsHtml = `<div data-action="quick-status-option" data-status="" data-rowid="${rowId}" data-orderid="${orderId}" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer border-b border-slate-100">— Без статусу —</div>`;
            for (const [key, st] of Object.entries(ORDER_STATUSES)) {
                const activeClass = currentStatus === key ? 'bg-slate-100 font-bold' : '';
                optionsHtml += `<div data-action="quick-status-option" data-status="${key}" data-rowid="${rowId}" data-orderid="${orderId}" class="px-3 py-2 text-xs hover:bg-slate-100 cursor-pointer flex items-center gap-2 ${activeClass}"><span class="w-2 h-2 rounded-full ${st.bg} ${st.border} border"></span>${st.label}</div>`;
            }
            
            return `
                <div class="relative inline-block status-dropdown-wrapper">
                    <button type="button" data-action="toggle-status-dropdown" data-rowid="${rowId}" title="Змінити статус" class="w-9 h-9 rounded-xl bg-slate-200 text-slate-800 text-xs font-bold flex items-center justify-center hover:bg-slate-300 transition">
                        <i class="fa-solid fa-tag"></i>
                    </button>
                    <div data-status-dropdown="${rowId}" class="hidden absolute right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl z-[150] min-w-[200px] py-1 max-h-[300px] overflow-y-auto">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        }

        // --- FIREBASE (основна БД для UI) ---
        // Структура Firestore:
        // managers/{managerId}
        // managers/{managerId}/plans/{period}
        // managers/{managerId}/orders/{orderId}
        // де managerId = "старий" id (OleksandrNamistnyk, ...)
        // Google Sheets backup зараз вимкнено.
        //
        // (Опційно) Можна додати окремий тестовий Firebase project у FIREBASE_CONFIGS.test.
        const FIREBASE_CONFIGS = {
            prod: {
                apiKey: "AIzaSyCIDpmrCoITjCfqMeC94ZO7Enl4HyZ-Lkw",
                authDomain: "gm-base.firebaseapp.com",
                projectId: "gm-base",
                storageBucket: "gm-base.firebasestorage.app",
                messagingSenderId: "579626247182",
                appId: "1:579626247182:web:09324aa5823c564defc85f"
            },
            // TODO: вставте firebaseConfig тестового проекту (наприклад gm-base-test)
            test: null
        };

        const DEFAULT_FIREBASE_ENV = 'prod';
        // Зараз: усі менеджери працюють з prod Firebase.
        const FIREBASE_ENV_BY_MANAGER = {};

        function resolveFirebaseEnvForManager_(managerId) {
            return FIREBASE_ENV_BY_MANAGER[String(managerId || '')] || DEFAULT_FIREBASE_ENV;
        }

        function getFirebaseConfigForManager_(managerId) {
            const env = resolveFirebaseEnvForManager_(managerId);
            const cfg = FIREBASE_CONFIGS && FIREBASE_CONFIGS[env];
            // Якщо тестовий конфіг ще не вставили — акуратно повертаємось на prod,
            // щоб сторінка не ламалась.
            if (!cfg && env !== DEFAULT_FIREBASE_ENV) return FIREBASE_CONFIGS[DEFAULT_FIREBASE_ENV] || null;
            return cfg || null;
        }

        let firebaseModulesPromise_ = null;
        const firebaseEnvState_ = Object.create(null);
        window.__crmDataSource = 'unknown';

        function normalizeAmount_(value) {
            if (value == null) return 0;
            const cleaned = String(value).replace(/\s+/g, '').replace(/,/g, '.');
            const n = Number(cleaned);
            return Number.isFinite(n) ? n : 0;
        }

        function toLocalYmd_(d) {
            const dt = d instanceof Date ? d : new Date(d);
            if (!Number.isFinite(dt.getTime())) return '';
            const yyyy = String(dt.getFullYear());
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const dd = String(dt.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function toIsoDate_(v) {
            if (!v) return toLocalYmd_(new Date()) || '';
            if (typeof v === 'string') {
                const s = v.slice(0, 10);
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                const t = Date.parse(v);
                if (Number.isFinite(t)) return toLocalYmd_(new Date(t)) || '';
            }
            if (v?.toDate) {
                const d = v.toDate();
                const s = toLocalYmd_(d);
                if (s) return s;
            }
            const d = new Date(v);
            const s = toLocalYmd_(d);
            if (s) return s;
            return toLocalYmd_(new Date()) || '';
        }

        function normalizeCrmUrl_(raw) {
            const s = String(raw || '').trim();
            if (!s) return '';
            const hasScheme = /^https?:\/\//i.test(s);
            const candidate = hasScheme ? s : `https://${s.replace(/^\/\//, '')}`;
            try {
                const u = new URL(candidate);
                if (u.protocol !== 'http:' && u.protocol !== 'https:') return '';
                return u.toString();
            } catch (e) {
                return '';
            }
        }

        async function loadFirebaseModules_() {
            if (firebaseModulesPromise_) return firebaseModulesPromise_;
            firebaseModulesPromise_ = (async () => {
                const appMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                return { appMod, fsMod, authMod };
            })();
            return firebaseModulesPromise_;
        }

        async function initFirebaseForManager_(managerId) {
            const env = resolveFirebaseEnvForManager_(managerId);
            const cfg = getFirebaseConfigForManager_(managerId);
            if (!cfg || typeof cfg !== 'object') return null;

            const key = String(env);
            const state = firebaseEnvState_[key] || (firebaseEnvState_[key] = { api: null, initPromise: null });
            if (state.api) return state.api;
            if (state.initPromise) return state.initPromise;

            state.initPromise = (async () => {
                const { appMod, fsMod, authMod } = await loadFirebaseModules_();
                const appName = `crm-${key}`;
                let app;
                try {
                    app = appMod.initializeApp(cfg, appName);
                } catch (e) {
                    try {
                        app = appMod.getApp(appName);
                    } catch (e2) {
                        throw e;
                    }
                }
                const db = fsMod.getFirestore(app);

                // Anonymous Auth (потрібно увімкнути в Firebase Console → Authentication → Sign-in method → Anonymous)
                let auth = null;
                try {
                    auth = authMod.getAuth(app);
                    if (!auth.currentUser) {
                        await authMod.signInAnonymously(auth);
                        console.info('[CRM] Firebase auth: anonymous signed in');
                    }
                } catch (e) {
                    // Якщо Anonymous provider вимкнено або домен не дозволено — Firestore може впасти з permissions.
                    // Тоді UI покаже помилку доступу до бази.
                    console.warn('[CRM] Firebase auth: anonymous sign-in failed (enable Anonymous provider in Firebase Auth).', e);
                }

                state.api = { db, auth, ...fsMod, __env: key, __projectId: cfg.projectId || '' };
                console.info(`[CRM] Firebase initialized env=${key} project=${cfg.projectId || ''}`);
                return state.api;
            })();

            return state.initPromise;
        }

        async function fs_getStats_(managerId) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const managerRef = api.doc(api.db, 'managers', managerId);
            const managerSnap = await api.getDoc(managerRef);

            const plansSnap = await api.getDocs(api.collection(api.db, 'managers', managerId, 'plans'));
            const plans = [];
            plansSnap.forEach((d) => {
                const data = d.data() || {};
                const updatedAt = data.updatedAt?.toDate ? data.updatedAt.toDate().toISOString() : (data.updatedAt || null);
                plans.push({
                    period: data.period || d.id,
                    label: data.label || data.period || d.id,
                    goal: Number(data.goal) || 0,
                    updatedAt
                });
            });

            const ordersQuery = api.query(
                api.collection(api.db, 'managers', managerId, 'orders'),
                api.orderBy('date', 'desc'),
                api.limit(500)
            );
            const ordersSnap = await api.getDocs(ordersQuery);
            const history = [];
            ordersSnap.forEach((d) => {
                const o = d.data() || {};
                const id = d.id;
                history.push({
                    id,
                    rowId: id,
                    date: toIsoDate_(o.date),
                    shipmentDate: o.shipmentDate ? toIsoDate_(o.shipmentDate) : '',
                    payer: o.payer || '',
                    region: o.region || '',
                    items: o.items || '',
                    comment: o.comment || '',
                    crmLink: String(o.crmLink || o.link || ''),
                    status: o.status || '',
                    amount: Number(o.amount) || 0
                });
            });

            let total = 0;
            const manager = managerSnap.exists() ? (managerSnap.data() || {}) : null;
            if (manager && typeof manager.totalSales === 'number') {
                total = manager.totalSales;
            } else {
                total = history.reduce((s, x) => s + (Number(x.amount) || 0), 0);
            }

            return { total, history, plans };
        }

        async function fs_addOrder_(managerId, payload) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const amount = normalizeAmount_(payload.amount);
            const dateStr = String(payload.date || '').trim();
            const date = /^\d{4}-\d{2}-\d{2}$/.test(dateStr) ? new Date(dateStr + 'T00:00:00') : new Date();
            
            const shipmentDateStr = String(payload.shipmentDate || '').trim();
            const shipmentDate = /^\d{4}-\d{2}-\d{2}$/.test(shipmentDateStr) ? new Date(shipmentDateStr + 'T00:00:00') : null;

            const docRef = await api.addDoc(api.collection(api.db, 'managers', managerId, 'orders'), {
                managerId,
                payer: payload.payer || '',
                region: payload.region || '',
                items: payload.items || '',
                comment: payload.comment || '',
                crmLink: payload.crmLink || '',
                status: payload.status || '',
                amount,
                date,
                shipmentDate,
                createdAt: api.serverTimestamp(),
                updatedAt: api.serverTimestamp()
            });

            await api.setDoc(
                api.doc(api.db, 'managers', managerId),
                { totalSales: api.increment(amount), updatedAt: api.serverTimestamp() },
                { merge: true }
            );

            return docRef.id;
        }

        async function fs_updateOrder_(managerId, orderId, payload, prevAmount) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const amount = normalizeAmount_(payload.amount);
            const dateStr = String(payload.date || '').trim();
            const date = /^\d{4}-\d{2}-\d{2}$/.test(dateStr) ? new Date(dateStr + 'T00:00:00') : new Date();
            
            const shipmentDateStr = String(payload.shipmentDate || '').trim();
            const shipmentDate = /^\d{4}-\d{2}-\d{2}$/.test(shipmentDateStr) ? new Date(shipmentDateStr + 'T00:00:00') : null;

            await api.setDoc(
                api.doc(api.db, 'managers', managerId, 'orders', orderId),
                {
                    payer: payload.payer || '',
                    region: payload.region || '',
                    items: payload.items || '',
                    comment: payload.comment || '',
                    crmLink: payload.crmLink || '',
                    status: payload.status || '',
                    amount,
                    date,
                    shipmentDate,
                    updatedAt: api.serverTimestamp()
                },
                { merge: true }
            );

            const oldAmount = Number(prevAmount);
            if (Number.isFinite(oldAmount)) {
                const delta = amount - oldAmount;
                if (delta) {
                    await api.setDoc(
                        api.doc(api.db, 'managers', managerId),
                        { totalSales: api.increment(delta), updatedAt: api.serverTimestamp() },
                        { merge: true }
                    );
                }
            }
        }

        async function fs_deleteOrder_(managerId, orderId, prevAmount) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            await api.deleteDoc(api.doc(api.db, 'managers', managerId, 'orders', orderId));

            const oldAmount = Number(prevAmount);
            if (Number.isFinite(oldAmount) && oldAmount) {
                await api.setDoc(
                    api.doc(api.db, 'managers', managerId),
                    { totalSales: api.increment(-oldAmount), updatedAt: api.serverTimestamp() },
                    { merge: true }
                );
            }
        }

        async function fs_setPlan_(managerId, plan) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const period = String(plan.period || '').trim();
            if (!period) throw new Error('period is required');

            await api.setDoc(
                api.doc(api.db, 'managers', managerId, 'plans', period),
                {
                    period,
                    label: plan.label || period,
                    goal: Number(plan.goal) || 0,
                    updatedAt: api.serverTimestamp()
                },
                { merge: true }
            );
        }

        async function fs_deletePlan_(managerId, period) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const p = String(period || '').trim();
            if (!p) throw new Error('period is required');

            await api.deleteDoc(api.doc(api.db, 'managers', managerId, 'plans', p));
        }

        // --- EXPORT (Excel) ---
        let xlsxLoadPromise_ = null;

        async function loadXlsx_() {
            if (window.XLSX) return window.XLSX;
            if (xlsxLoadPromise_) return xlsxLoadPromise_;
            xlsxLoadPromise_ = (async () => {
                await new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                    s.async = true;
                    s.onload = resolve;
                    s.onerror = reject;
                    document.head.appendChild(s);
                });
                if (!window.XLSX) throw new Error('XLSX failed to load');
                return window.XLSX;
            })();
            return xlsxLoadPromise_;
        }

        async function fs_listAllOrders_(managerId, range) {
            const api = await initFirebaseForManager_(managerId);
            if (!api) throw new Error('Firebase not configured');

            const from = range?.from ? String(range.from) : '';
            const to = range?.to ? String(range.to) : '';
            const hasFrom = /^\d{4}-\d{2}-\d{2}$/.test(from);
            const hasTo = /^\d{4}-\d{2}-\d{2}$/.test(to);
            const fromDate = hasFrom ? new Date(from + 'T00:00:00') : null;
            const toDate = hasTo ? new Date(to + 'T23:59:59') : null;

            const out = [];
            let lastDoc = null;
            // Safety cap to avoid infinite loops; practically "all" for typical usage.
            for (let page = 0; page < 500; page++) {
                const constraints = [
                    api.orderBy('date', 'desc')
                ];
                if (fromDate && Number.isFinite(fromDate.getTime())) constraints.push(api.where('date', '>=', fromDate));
                if (toDate && Number.isFinite(toDate.getTime())) constraints.push(api.where('date', '<=', toDate));
                if (lastDoc) constraints.push(api.startAfter(lastDoc));
                constraints.push(api.limit(1000));

                const q = api.query(
                    api.collection(api.db, 'managers', managerId, 'orders'),
                    ...constraints
                );

                const snap = await api.getDocs(q);
                if (snap.empty) break;

                snap.forEach((d) => {
                    const o = d.data() || {};
                    out.push({
                        id: d.id,
                        date: toIsoDate_(o.date),
                        managerId: String(o.managerId || managerId),
                        payer: String(o.payer || ''),
                        region: String(o.region || ''),
                        items: String(o.items || ''),
                        comment: String(o.comment || ''),
                        crmLink: String(o.crmLink || o.link || ''),
                        amount: Number(o.amount) || 0
                    });
                });

                lastDoc = snap.docs[snap.docs.length - 1];
                if (snap.docs.length < 1000) break;
            }
            return out;
        }

        function downloadBlob_(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        async function exportOrdersToExcel_() {
            if (!loggedInManagerId) return;
            const btn = document.getElementById('exportOrdersBtn');
            withButtonLoading_(btn, true, 'Експорт', 'Експорт...');
            try {
                const XLSX = await loadXlsx_();

                const from = document.getElementById('exportFromDate')?.value || '';
                const to = document.getElementById('exportToDate')?.value || '';
                if (from && to && from > to) {
                    alert('Невірний діапазон дат: "з" не може бути пізніше ніж "по".');
                    return;
                }

                // Fetch all orders for current manager from Firebase
                const orders = await fs_listAllOrders_(loggedInManagerId, { from, to });

                const rows = orders.map((o) => ({
                    'Дата': o.date,
                    'Менеджер': o.managerId,
                    'Платник': o.payer,
                    'Область': o.region,
                    'Додаткові пункти': o.items,
                    'Коментар': o.comment,
                    'Посилання CRM': o.crmLink || '',
                    'Сума': o.amount,
                    'ID': o.id
                }));

                const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: false });
                ws['!cols'] = [
                    { wch: 12 },
                    { wch: 20 },
                    { wch: 28 },
                    { wch: 16 },
                    { wch: 30 },
                    { wch: 30 },
                    { wch: 44 },
                    { wch: 12 },
                    { wch: 26 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Orders');

                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const filename = `GM-orders-${loggedInManagerId}-${yyyy}-${mm}-${dd}.xlsx`;

                const arr = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([arr], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                downloadBlob_(blob, filename);
                if (typeof closeExportModal_ === 'function') closeExportModal_();
            } catch (e) {
                console.warn('[CRM] export failed', e);
                alert('Не вдалося зробити експорт. Спробуйте ще раз.');
            } finally {
                withButtonLoading_(btn, false, 'Експорт');
            }
        }

        // Google Sheets / Apps Script (ВИМКНЕНО)
        const ENABLE_GOOGLE_SHEETS_BACKUP = false;
        const SCRIPT_URL = ''; 
        
        let loggedInManagerId = null;
        let currentMonth = 'План';
        let currentGoal = 1000000;
        const BASE_SALARY = 40000;
        // KPI model:
        // - Turnover KPI: up to 40k (0 if <=50% plan; proportional 51–100%; capped at 40k)
        // - Conversion KPI: +20k if target is met
        // - Over-plan bonus: +1% of sales above goal
        const MAX_BONUS = 40000;
        const CONVERSION_BONUS = 20000;
        let conversionMet = true;

        const MONTH_LABELS = {
            '01': 'Січень',
            '02': 'Лютий',
            '03': 'Березень',
            '04': 'Квітень',
            '05': 'Травень',
            '06': 'Червень',
            '07': 'Липень',
            '08': 'Серпень',
            '09': 'Вересень',
            '10': 'Жовтень',
            '11': 'Листопад',
            '12': 'Грудень'
        };

        const MONTH_KEYS = ['01','02','03','04','05','06','07','08','09','10','11','12'];

        async function postToScript_(payload) {
            if (!ENABLE_GOOGLE_SHEETS_BACKUP) return false;
            if (!loggedInManagerId) return false;
            if (!SCRIPT_URL || SCRIPT_URL.includes('ВАШ_URL')) return false;
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload || {})
                });
                return true;
            } catch (e) {
                return false;
            }
        }

        const SHEETS_QUEUE_KEY_ = '__gm_sheets_queue_v1';

        function enqueueSheetsOp_(op) {
            if (!ENABLE_GOOGLE_SHEETS_BACKUP) return;
            try {
                const raw = localStorage.getItem(SHEETS_QUEUE_KEY_);
                const arr = raw ? JSON.parse(raw) : [];
                arr.push({ t: Date.now(), op: op || {} });
                // Keep queue bounded
                if (arr.length > 200) arr.splice(0, arr.length - 200);
                localStorage.setItem(SHEETS_QUEUE_KEY_, JSON.stringify(arr));
            } catch (e) {}
        }

        async function flushSheetsQueue_() {
            if (!ENABLE_GOOGLE_SHEETS_BACKUP) {
                try { localStorage.removeItem(SHEETS_QUEUE_KEY_); } catch (e) {}
                return;
            }
            if (!loggedInManagerId) return;
            if (flushSheetsQueue_.inFlight) return;
            flushSheetsQueue_.inFlight = true;
            try {
                const raw = localStorage.getItem(SHEETS_QUEUE_KEY_);
                const arr = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(arr) || !arr.length) return;

                const remaining = [];
                for (const item of arr) {
                    const op = item?.op || {};
                    const payload = op.payload || {};
                    const ok = await postToScript_(payload);
                    if (!ok) {
                        remaining.push(item);
                        // Stop early; keep the rest for later.
                        break;
                    }
                }

                localStorage.setItem(SHEETS_QUEUE_KEY_, JSON.stringify(remaining));
            } catch (e) {
                // Keep queue as-is on unexpected errors.
            } finally {
                flushSheetsQueue_.inFlight = false;
            }
        }

        function setLoading_(isLoading) {
            const status = document.getElementById('connectionStatus');
            if (status) {
                if (isLoading) {
                    status.textContent = 'Завантаження...';
                    status.className = 'text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded';
                } else {
                    status.textContent = "З'єднано";
                    status.className = 'text-[10px] text-green-500 bg-green-50 px-2 py-1 rounded';
                }
            }

            const plansHost = document.getElementById('plansList');
            if (isLoading && plansHost && !plansHost.children.length) {
                plansHost.innerHTML = '<div class="text-sm text-slate-400 italic">Завантаження...</div>';
            }

            const historyBody = document.getElementById('historyBody');
            if (isLoading && historyBody && !historyBody.dataset.loadingSet) {
                historyBody.dataset.loadingSet = '1';
                historyBody.innerHTML = '<tr><td class="p-10 text-center text-slate-400 italic">Завантаження...</td></tr>';
            }
            if (!isLoading && historyBody) {
                delete historyBody.dataset.loadingSet;
            }
        }

        function withButtonLoading_(btn, isLoading, idleText, loadingText) {
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.dataset.idleText = btn.dataset.idleText || (idleText || btn.textContent || '');
                btn.textContent = loadingText || '...';
                btn.classList.add('opacity-60');
            } else {
                btn.disabled = false;
                const t = btn.dataset.idleText || idleText;
                if (t) btn.textContent = t;
                btn.classList.remove('opacity-60');
            }
        }

        function normalizePlanPeriodClient_(v) {
            if (v instanceof Date && Number.isFinite(v.getTime())) {
                const yyyy = v.getFullYear();
                const mm = String(v.getMonth() + 1).padStart(2, '0');
                return `${yyyy}-${mm}`;
            }
            const s = String(v == null ? '' : v).trim();
            if (!s) return '';
            if (/^\d{4}-\d{2}$/.test(s)) return s;
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (m) return `${m[1]}-${m[2]}`;
            const t = Date.parse(s);
            if (Number.isFinite(t)) {
                const d = new Date(t);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                return `${yyyy}-${mm}`;
            }
            return '';
        }

        // Plans source of truth: Firebase (Firestore). No localStorage for plans.
        // NOTE: Sheets may coerce "2025-12" into a Date; we normalize to YYYY-MM for UI.
        function setDbPlans_(plansArr) {
            const arr = Array.isArray(plansArr) ? plansArr : [];
            window.__dbPlans = arr;

            // Map: normalizedPeriod -> { goal, label, rawPeriod, updatedAt }
            const map = {};
            for (const p of arr) {
                const rawPeriod = p?.period;
                const period = normalizePlanPeriodClient_(rawPeriod);
                if (!/^\d{4}-\d{2}$/.test(period)) continue;
                const goal = Number(p?.goal);
                const updatedAt = String(p?.updatedAt || '');
                const item = {
                    period,
                    rawPeriod: String(rawPeriod ?? ''),
                    label: String(p?.label || ''),
                    goal: Number.isFinite(goal) ? goal : 0,
                    updatedAt
                };

                const existing = map[period];
                if (!existing) {
                    map[period] = item;
                } else {
                    const a = existing.updatedAt ? Date.parse(existing.updatedAt) : 0;
                    const b = item.updatedAt ? Date.parse(item.updatedAt) : 0;
                    if (b >= a) map[period] = item;
                }
            }
            window.__dbPlansMap = map;
        }

        function getDbPlansMap_() {
            return window.__dbPlansMap && typeof window.__dbPlansMap === 'object' ? window.__dbPlansMap : {};
        }

        function getDbPlanGoal_(period) {
            const map = getDbPlansMap_();
            const key = String(period || '').trim();
            const v = Number(map?.[key]?.goal);
            return Number.isFinite(v) ? v : 0;
        }

        function optimisticUpsertPlan_(period, label, goal) {
            const p = normalizePlanPeriodClient_(period);
            if (!/^\d{4}-\d{2}$/.test(p)) return;

            const nowIso = new Date().toISOString();
            const safeGoal = Number(goal);

            const map = { ...(getDbPlansMap_() || {}) };
            map[p] = {
                period: p,
                rawPeriod: String(period ?? p),
                label: String(label || ''),
                goal: Number.isFinite(safeGoal) ? safeGoal : 0,
                updatedAt: nowIso
            };
            window.__dbPlansMap = map;

            const arr = Array.isArray(window.__dbPlans) ? window.__dbPlans.slice() : [];
            const idx = arr.findIndex(x => normalizePlanPeriodClient_(x?.period) === p);
            const item = { period: p, label: String(label || ''), goal: Number.isFinite(safeGoal) ? safeGoal : 0, updatedAt: nowIso };
            if (idx >= 0) arr[idx] = item; else arr.push(item);
            window.__dbPlans = arr;
        }

        function optimisticDeletePlan_(period) {
            const p = normalizePlanPeriodClient_(period);
            if (!/^\d{4}-\d{2}$/.test(p)) return;

            const map = { ...(getDbPlansMap_() || {}) };
            delete map[p];
            window.__dbPlansMap = map;

            const arr = Array.isArray(window.__dbPlans) ? window.__dbPlans : [];
            window.__dbPlans = arr.filter(x => normalizePlanPeriodClient_(x?.period) !== p);
        }

        function refreshGoalFromPlans_() {
            const allHistory = Array.isArray(window.__lastAllHistory) ? window.__lastAllHistory : [];
            const view = buildProgressView_(allHistory);
            currentGoal = Number(view.goal) || currentGoal;
            currentMonth = view.label || currentMonth;
            updateUI(view.total || 0, allHistory);
        }

        function getProgressPeriodsStorageKey_(managerId) {
            return `crm_progress_periods_${managerId}`;
        }

        function loadSelectedProgressPeriods_() {
            if (!loggedInManagerId) return [];
            try {
                const raw = localStorage.getItem(getProgressPeriodsStorageKey_(loggedInManagerId));
                const parsed = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parsed)) return [];
                return parsed.map(String);
            } catch (e) {
                return [];
            }
        }

        function saveSelectedProgressPeriods_(periods) {
            if (!loggedInManagerId) return;
            const unique = Array.from(new Set((periods || []).map(String))).filter(p => /^\d{4}-\d{2}$/.test(p));
            localStorage.setItem(getProgressPeriodsStorageKey_(loggedInManagerId), JSON.stringify(unique));
        }

        function getAvailablePlanPeriods_() {
            const plans = getDbPlansMap_();
            return Object.keys(plans || {})
                .filter(p => /^\d{4}-\d{2}$/.test(p))
                .sort((a, b) => {
                    const ma = a.match(/^(\d{4})-(\d{2})$/);
                    const mb = b.match(/^(\d{4})-(\d{2})$/);
                    const ya = ma ? Number(ma[1]) : 0;
                    const yb = mb ? Number(mb[1]) : 0;
                    if (ya !== yb) return ya - yb;
                    const mna = ma ? Number(ma[2]) : 0;
                    const mnb = mb ? Number(mb[2]) : 0;
                    return mna - mnb;
                });
        }

        function normalizeSelectedProgressPeriods_() {
            if (!loggedInManagerId) return;
            const available = new Set(getAvailablePlanPeriods_());
            const selected = loadSelectedProgressPeriods_().filter(p => available.has(p));

            // Default to current month if it exists, otherwise last available
            if (!selected.length) {
                const now = new Date();
                const current = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                if (available.has(current)) selected.push(current);
                else {
                    const all = Array.from(available).sort();
                    if (all.length) selected.push(all[all.length - 1]);
                }
            }

            saveSelectedProgressPeriods_(selected);
        }

        function updateProgressPeriodBtnLabel_() {
            const btn = document.getElementById('progressPeriodBtn');
            if (!btn) return;
            const selected = loadSelectedProgressPeriods_();
            if (!selected.length) {
                btn.textContent = 'Обрати місяці';
                return;
            }
            if (selected.length === 1) {
                btn.textContent = formatPeriodLabel_(selected[0]);
                return;
            }
            btn.textContent = `${selected.length} місяців`;
        }

        function renderProgressPeriodPicker_() {
            const btn = document.getElementById('progressPeriodBtn');
            const menu = document.getElementById('progressPeriodMenu');
            if (!btn || !menu) return;

            if (!loggedInManagerId) {
                menu.innerHTML = '<div class="text-sm text-slate-400">Увійдіть, щоб обрати період.</div>';
                btn.disabled = true;
                btn.classList.add('opacity-50');
                btn.textContent = 'Обрати місяці';
                return;
            }

            btn.disabled = false;
            btn.classList.remove('opacity-50');

            normalizeSelectedProgressPeriods_();
            const available = getAvailablePlanPeriods_();
            const selected = new Set(loadSelectedProgressPeriods_());

            if (!available.length) {
                menu.innerHTML = '<div class="text-sm text-slate-400">Немає планів. Додайте план у «Плани».</div>';
                btn.textContent = 'Немає планів';
                return;
            }

            menu.innerHTML = '';
            const title = document.createElement('div');
            title.className = 'text-xs font-bold text-slate-400 uppercase mb-2';
            title.textContent = 'Оберіть місяці';
            menu.appendChild(title);

            for (const period of available) {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 py-1 text-sm text-slate-700 cursor-pointer select-none';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = period;
                cb.checked = selected.has(period);
                cb.addEventListener('change', () => {
                    const next = new Set(loadSelectedProgressPeriods_());
                    if (cb.checked) next.add(period); else next.delete(period);
                    saveSelectedProgressPeriods_(Array.from(next));
                    updateProgressPeriodBtnLabel_();
                    updateStats();
                });

                const text = document.createElement('span');
                text.textContent = formatPeriodLabel_(period);

                label.appendChild(cb);
                label.appendChild(text);
                menu.appendChild(label);
            }

            updateProgressPeriodBtnLabel_();

            // Bind toggles once
            if (!btn.dataset.bound) {
                btn.dataset.bound = '1';
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.classList.toggle('hidden');
                });
                document.addEventListener('click', () => {
                    menu.classList.add('hidden');
                });
                menu.addEventListener('click', (e) => {
                    // allow clicking inside menu without closing
                    e.stopPropagation();
                });
            }
        }

        function monthName_(mm) {
            return MONTH_LABELS[String(mm).padStart(2, '0')] || String(mm);
        }

        function formatPeriodLabel_(period) {
            const m = String(period || '').match(/^(\d{4})-(\d{2})$/);
            if (!m) return String(period || '');
            const yyyy = m[1];
            const mm = m[2];
            return `${monthName_(mm)} ${yyyy}`;
        }

        function renderLocalPlans_() {
            const host = document.getElementById('plansList');
            if (!host) return;
            host.innerHTML = '';

            if (!loggedInManagerId) {
                host.innerHTML = '<div class="text-sm text-slate-400">Увійдіть, щоб побачити плани.</div>';
                return;
            }

            const plans = getDbPlansMap_();
            const periods = Object.keys(plans || {})
                .filter(p => /^\d{4}-\d{2}$/.test(p))
                .sort((a, b) => {
                    const ma = a.match(/^(\d{4})-(\d{2})$/);
                    const mb = b.match(/^(\d{4})-(\d{2})$/);
                    const ya = ma ? Number(ma[1]) : 0;
                    const yb = mb ? Number(mb[1]) : 0;
                    if (ya !== yb) return ya - yb;
                    const mna = ma ? Number(ma[2]) : 0;
                    const mnb = mb ? Number(mb[2]) : 0;
                    return mna - mnb;
                });

            if (!periods.length) {
                host.innerHTML = '<div class="text-sm text-slate-400">Планів ще немає. Натисніть «Додати план».</div>';
                return;
            }

            for (const period of periods) {
                const entry = plans?.[period] || {};
                const rawPeriod = String(entry.rawPeriod || '');

                const row = document.createElement('div');
                row.className = 'flex flex-col sm:flex-row sm:items-center gap-2 bg-slate-50 border border-slate-200 rounded-2xl p-3';

                const m = String(period).match(/^(\d{4})-(\d{2})$/);
                const initYear = m ? m[1] : '';
                const initMonth = m ? m[2] : '';

                const yearInput = document.createElement('input');
                yearInput.type = 'number';
                yearInput.min = '2000';
                yearInput.max = '2100';
                yearInput.inputMode = 'numeric';
                yearInput.className = 'w-full sm:w-24 p-2 rounded-xl bg-white border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold text-slate-800';
                yearInput.value = initYear;

                const monthSelect = document.createElement('select');
                monthSelect.className = 'w-full sm:w-40 p-2 rounded-xl bg-white border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold text-slate-800';
                MONTH_KEYS.forEach((mm) => {
                    const opt = document.createElement('option');
                    opt.value = mm;
                    opt.textContent = MONTH_LABELS[mm];
                    monthSelect.appendChild(opt);
                });
                monthSelect.value = initMonth;

                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.inputMode = 'numeric';
                input.className = 'w-full sm:w-36 p-2 rounded-xl bg-white border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold text-slate-800';
                const v = Number(entry?.goal);
                input.value = Number.isFinite(v) && v > 0 ? String(v) : '';

                const saveBtn = document.createElement('button');
                saveBtn.type = 'button';
                saveBtn.className = 'w-full sm:w-auto px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold transition-colors disabled:cursor-not-allowed';
                saveBtn.textContent = 'Зберегти';
                saveBtn.addEventListener('click', async () => {
                    withButtonLoading_(saveBtn, true, 'Зберегти', 'Збереження...');
                    const yyyy = String(yearInput.value || '').trim();
                    const mm = String(monthSelect.value || '').trim();
                    if (!/^\d{4}$/.test(yyyy) || !/^\d{2}$/.test(mm)) {
                        withButtonLoading_(saveBtn, false);
                        alert('Вкажіть коректний рік і місяць');
                        return;
                    }
                    const newPeriod = `${yyyy}-${mm}`;
                    const newGoal = Number(input.value || 0);
                    const safeGoal = Number.isFinite(newGoal) && newGoal > 0 ? newGoal : 0;

                    try {
                        // If month changed, delete old Firebase doc to keep uniqueness.
                        if (String(newPeriod) !== String(period)) {
                            await fs_deletePlan_(loggedInManagerId, period);

                            // Sheets backup (best-effort)
                            const delPayload = { action: 'deletePlan', managerId: loggedInManagerId, period: rawPeriod || period };
                            const delOk = await postToScript_(delPayload);
                            if (!delOk) enqueueSheetsOp_({ type: 'deletePlan', payload: delPayload });

                            optimisticDeletePlan_(period);
                        }

                        await fs_setPlan_(loggedInManagerId, { period: newPeriod, label: formatPeriodLabel_(newPeriod), goal: safeGoal });

                        // Sheets backup (best-effort)
                        const setPayload = { action: 'setPlan', managerId: loggedInManagerId, period: newPeriod, label: formatPeriodLabel_(newPeriod), goal: safeGoal };
                        const setOk = await postToScript_(setPayload);
                        if (!setOk) enqueueSheetsOp_({ type: 'setPlan', payload: setPayload });

                        optimisticUpsertPlan_(newPeriod, formatPeriodLabel_(newPeriod), safeGoal);
                    } catch (e) {
                        console.warn('[CRM] setPlan firebase failed', e);
                        withButtonLoading_(saveBtn, false);
                        alert('Помилка збереження плану в базі. Спробуйте ще раз.');
                        return;
                    }

                    renderLocalPlans_();
                    renderProgressPeriodPicker_();
                    refreshGoalFromPlans_();

                    withButtonLoading_(saveBtn, false);

                    // Refresh from DB in background
                    setTimeout(updateStats, 600);
                });

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'w-full sm:w-auto px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-800 text-xs font-bold transition-colors disabled:cursor-not-allowed';
                delBtn.textContent = 'Видалити';
                delBtn.addEventListener('click', async () => {
                    withButtonLoading_(delBtn, true, 'Видалити', 'Видалення...');
                    try {
                        await fs_deletePlan_(loggedInManagerId, period);

                        // Sheets backup (best-effort)
                        const payload = { action: 'deletePlan', managerId: loggedInManagerId, period: rawPeriod || period };
                        const ok = await postToScript_(payload);
                        if (!ok) enqueueSheetsOp_({ type: 'deletePlan', payload });

                        optimisticDeletePlan_(period);
                    } catch (e) {
                        console.warn('[CRM] deletePlan firebase failed', e);
                        withButtonLoading_(delBtn, false);
                        alert('Помилка видалення плану в базі. Спробуйте ще раз.');
                        return;
                    }
                    renderLocalPlans_();
                    renderProgressPeriodPicker_();
                    refreshGoalFromPlans_();
                    withButtonLoading_(delBtn, false);

                    // Refresh from DB in background
                    setTimeout(updateStats, 600);
                });

                const label = document.createElement('div');
                label.className = 'hidden md:block flex-1 text-xs text-slate-500';
                label.textContent = formatPeriodLabel_(period);

                row.appendChild(yearInput);
                row.appendChild(monthSelect);
                row.appendChild(input);
                row.appendChild(saveBtn);
                row.appendChild(delBtn);
                row.appendChild(label);
                host.appendChild(row);
            }
        }

        function getGoalForMonth_(yyyy, mm) {
            const period = `${String(yyyy)}-${String(mm).padStart(2, '0')}`;
            return getDbPlanGoal_(period);
        }

        function getQuarterInfo_(date) {
            const d = date instanceof Date ? date : new Date(date);
            const yyyy = d.getFullYear();
            const q = Math.floor(d.getMonth() / 3) + 1;
            const startMonth = (q - 1) * 3 + 1;
            const months = [startMonth, startMonth + 1, startMonth + 2].map(m => String(m).padStart(2, '0'));
            return { yyyy: String(yyyy), q, months };
        }

        function filterHistoryByRange_(history, start, endExclusive) {
            const out = [];
            let total = 0;
            for (const item of (history || [])) {
                const d = new Date(item.date);
                if (!Number.isFinite(d.getTime())) continue;
                if (d >= start && d < endExclusive) {
                    out.push(item);
                    total += Number(item.amount) || 0;
                }
            }
            return { total, history: out };
        }

        function buildProgressView_(allHistory) {
            const now = new Date();

            const selected = loadSelectedProgressPeriods_();
            if (selected.length) {
                const set = new Set(selected);
                const out = [];
                let total = 0;
                for (const item of (allHistory || [])) {
                    const d = new Date(item.date);
                    if (!Number.isFinite(d.getTime())) continue;
                    const p = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (set.has(p)) {
                        out.push(item);
                        total += Number(item.amount) || 0;
                    }
                }

                let goal = 0;
                for (const p of selected) goal += getDbPlanGoal_(p) || 0;
                if (!goal) goal = currentGoal;

                let label = '';
                if (selected.length === 1) label = formatPeriodLabel_(selected[0]);
                else if (selected.length === 2) label = `${formatPeriodLabel_(selected[0])}, ${formatPeriodLabel_(selected[1])}`;
                else label = `${formatPeriodLabel_(selected[0])} +${selected.length - 1}`;

                return { total, history: out, goal, label };
            }

            // fallback: current month
            const yyyy = String(now.getFullYear());
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const start = new Date(Number(yyyy), Number(mm) - 1, 1, 0, 0, 0, 0);
            const end = new Date(Number(yyyy), Number(mm), 1, 0, 0, 0, 0);
            const filtered = filterHistoryByRange_(allHistory, start, end);
            let goal = getGoalForMonth_(yyyy, mm) || 0;
            if (!goal) goal = currentGoal;
            return { total: filtered.total, history: filtered.history, goal, label: `${monthName_(mm)} ${yyyy}` };
        }

        // --- АВТОРИЗАЦІЯ ---
        function initDateInputs_() {
            const today = toLocalYmd_(new Date());

            const orderDate = document.getElementById('orderDate');
            if (orderDate && !String(orderDate.value || '').trim()) {
                orderDate.value = today;
            }

            const to = document.getElementById('exportToDate');
            if (to && !String(to.value || '').trim()) {
                to.value = today;
            }

            const from = document.getElementById('exportFromDate');
            if (from && !String(from.value || '').trim()) {
                const d = new Date();
                d.setDate(1);
                from.value = toLocalYmd_(d);
            }
        }

        async function login() {
            const mId = document.getElementById('managerSelect').value;
            const pass = document.getElementById('passInput').value;
            const error = document.getElementById('loginError');

            if (MANAGERS[mId] && MANAGERS[mId].pass === pass) {
                loggedInManagerId = mId;
                localStorage.setItem('crm_logged_manager', mId);
                error.classList.add('hidden');
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('currentManagerName').innerText = MANAGERS[mId].name;
                initDateInputs_();
                renderLocalPlans_();
                renderProgressPeriodPicker_();
                updateStats();
            } else {
                error.classList.remove('hidden');
            }
        }

        function logout() {
            loggedInManagerId = null;
            localStorage.removeItem('crm_logged_manager');
            document.getElementById('passInput').value = '';
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('appContent').classList.add('hidden');
            renderProgressPeriodPicker_();
            // Do not clear drafts globally; they are per-manager.
        }

        document.getElementById('exportOrdersBtn')?.addEventListener('click', exportOrdersToExcel_);

        // --- LocalStorage: draft for New Order modal ---
        function orderDraftKey_() {
            const mid = String(loggedInManagerId || 'anonymous');
            return `crm_order_draft_v1_${mid}`;
        }

        function readOrderDraft_() {
            try {
                const raw = localStorage.getItem(orderDraftKey_());
                const obj = raw ? JSON.parse(raw) : null;
                return obj && typeof obj === 'object' ? obj : null;
            } catch (e) {
                return null;
            }
        }

        function writeOrderDraft_() {
            try {
                if (!loggedInManagerId) return;
                const draft = {
                    t: Date.now(),
                    orderDate: document.getElementById('orderDate')?.value || '',
                    payer: document.getElementById('payer')?.value || '',
                    crmLink: document.getElementById('orderCrmLink')?.value || '',
                    region: document.getElementById('regionSelect')?.value || '',
                    amount: document.getElementById('amount')?.value || '',
                    items: document.getElementById('orderItems')?.value || '',
                    comment: document.getElementById('orderComment')?.value || ''
                };
                localStorage.setItem(orderDraftKey_(), JSON.stringify(draft));
            } catch (e) {}
        }

        let orderDraftSaveTimer_ = null;
        function scheduleOrderDraftSave_() {
            if (orderDraftSaveTimer_) clearTimeout(orderDraftSaveTimer_);
            orderDraftSaveTimer_ = setTimeout(() => {
                orderDraftSaveTimer_ = null;
                writeOrderDraft_();
            }, 200);
        }

        function clearOrderDraft_() {
            try {
                if (!loggedInManagerId) return;
                localStorage.removeItem(orderDraftKey_());
            } catch (e) {}
        }

        function applyOrderDraftToUi_() {
            const d = readOrderDraft_();
            if (!d) return;
            const setIfEmpty = (id, val) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (String(el.value || '').trim()) return;
                el.value = String(val ?? '');
            };

            setIfEmpty('orderDate', d.orderDate);
            setIfEmpty('payer', d.payer);
            setIfEmpty('orderCrmLink', d.crmLink);
            setIfEmpty('regionSelect', d.region);
            setIfEmpty('amount', d.amount);
            setIfEmpty('orderItems', d.items);
            setIfEmpty('orderComment', d.comment);
        }

        function bindOrderDraftAutosave_() {
            const form = document.getElementById('orderForm');
            if (!form || form.dataset.draftBound) return;
            form.dataset.draftBound = '1';
            form.addEventListener('input', () => scheduleOrderDraftSave_());
            form.addEventListener('change', () => scheduleOrderDraftSave_());
        }

        let bodyScrollLocked_ = false;
        let bodyScrollY_ = 0;

        function lockBodyScroll_() {
            if (bodyScrollLocked_) return;
            bodyScrollY_ = window.scrollY || window.pageYOffset || 0;

            // iOS-safe scroll lock: position fixed preserves viewport and prevents background scroll.
            document.body.classList.add('overflow-hidden');
            document.body.style.position = 'fixed';
            document.body.style.top = `-${bodyScrollY_}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';

            bodyScrollLocked_ = true;
        }

        function unlockBodyScroll_() {
            if (!bodyScrollLocked_) return;

            document.body.classList.remove('overflow-hidden');
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';

            window.scrollTo(0, bodyScrollY_);
            bodyScrollLocked_ = false;
        }

        function syncBodyScrollLock_() {
            const orderOpen = !document.getElementById('orderModal')?.classList.contains('hidden');
            const exportOpen = !document.getElementById('exportModal')?.classList.contains('hidden');
            if (orderOpen || exportOpen) lockBodyScroll_();
            else unlockBodyScroll_();
        }

        // Prevent background iOS scroll while allowing scroll inside modal body.
        (function bindModalTouchGuard_() {
            if (bindModalTouchGuard_.bound) return;
            bindModalTouchGuard_.bound = true;
            document.addEventListener('touchmove', (e) => {
                if (!bodyScrollLocked_) return;
                const inScroller = e.target && e.target.closest && e.target.closest('.modal-scroll');
                if (inScroller) return;
                e.preventDefault();
            }, { passive: false });
        })();

        // --- Modal: New Order ---
        function initOrderStatusDropdown_() {
            const statusSelect = document.getElementById('orderStatus');
            if (!statusSelect || statusSelect.options.length > 1) return;
            for (const [key, st] of Object.entries(ORDER_STATUSES)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = st.label;
                statusSelect.appendChild(opt);
            }
        }

        function resetOrderModal_() {
            // Reset to "new order" mode
            document.getElementById('editingOrderId').value = '';
            document.getElementById('editingOrderPrevAmount').value = '';
            document.getElementById('orderModalTitle').textContent = 'Нове замовлення';
            document.getElementById('orderModalIcon').className = 'fa-solid fa-plus-circle text-blue-600';
            document.getElementById('submitBtn').textContent = 'Додати';
            
            // Clear form fields
            document.getElementById('orderDate').value = '';
            document.getElementById('orderShipmentDate').value = '';
            document.getElementById('payer').value = '';
            document.getElementById('orderCrmLink').value = '';
            document.getElementById('regionSelect').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('orderItems').value = '';
            document.getElementById('orderComment').value = '';
            document.getElementById('orderStatus').value = '';
        }

        function openOrderModal_(editData = null) {
            const modal = document.getElementById('orderModal');
            if (!modal) return;
            
            initOrderStatusDropdown_();
            
            if (editData) {
                // Edit mode
                document.getElementById('editingOrderId').value = editData.id || '';
                document.getElementById('editingOrderPrevAmount').value = editData.amount || '';
                document.getElementById('orderModalTitle').textContent = 'Редагування замовлення';
                document.getElementById('orderModalIcon').className = 'fa-solid fa-pen text-amber-600';
                document.getElementById('submitBtn').textContent = 'Зберегти';
                
                // Fill form with existing data
                const dateVal = toIsoDate_(editData.date);
                document.getElementById('orderDate').value = dateVal;
                document.getElementById('orderShipmentDate').value = editData.shipmentDate ? toIsoDate_(editData.shipmentDate) : '';
                document.getElementById('payer').value = editData.payer || '';
                document.getElementById('orderCrmLink').value = editData.crmLink || editData.link || '';
                document.getElementById('regionSelect').value = editData.region || '';
                document.getElementById('amount').value = editData.amount || '';
                document.getElementById('orderItems').value = editData.items || '';
                document.getElementById('orderComment').value = editData.comment || '';
                document.getElementById('orderStatus').value = editData.status || '';
            } else {
                // New order mode
                resetOrderModal_();
                initDateInputs_();
                applyOrderDraftToUi_();
            }
            
            modal.classList.remove('hidden');
            syncBodyScrollLock_();
            bindOrderDraftAutosave_();
            setTimeout(() => {
                const payer = document.getElementById('payer');
                if (payer) payer.focus();
            }, 0);
        }

        function closeOrderModal_() {
            const modal = document.getElementById('orderModal');
            if (!modal) return;
            modal.classList.add('hidden');
            syncBodyScrollLock_();
            // Reset to new mode when closing
            resetOrderModal_();
        }

        document.getElementById('openOrderModalBtn')?.addEventListener('click', () => openOrderModal_(null));
        document.getElementById('closeOrderModalBtn')?.addEventListener('click', closeOrderModal_);
        document.getElementById('orderModalBackdrop')?.addEventListener('click', closeOrderModal_);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeOrderModal_();
        });

        // --- Shipment Notifications Button ---
        document.getElementById('showShipmentNotifBtn')?.addEventListener('click', () => {
            const state = window.__historyState;
            if (!state || !state.allHistory) {
                alert('Історія замовлень ще не завантажена');
                return;
            }
            showAllShipments_(state.allHistory);
        });

        // --- Modal: Export ---
        function openExportModal_() {
            const modal = document.getElementById('exportModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            syncBodyScrollLock_();
            initDateInputs_();
            setTimeout(() => {
                const from = document.getElementById('exportFromDate');
                if (from) from.focus();
            }, 0);
        }

        function closeExportModal_() {
            const modal = document.getElementById('exportModal');
            if (!modal) return;
            modal.classList.add('hidden');
            syncBodyScrollLock_();
        }

        document.getElementById('openExportModalBtn')?.addEventListener('click', openExportModal_);
        document.getElementById('closeExportModalBtn')?.addEventListener('click', closeExportModal_);
        document.getElementById('cancelExportBtn')?.addEventListener('click', closeExportModal_);
        document.getElementById('exportModalBackdrop')?.addEventListener('click', closeExportModal_);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeExportModal_();
        });

        // --- СОРТУВАННЯ ТА ФІЛЬТРАЦІЯ ---
        document.getElementById('sortByDateBtn')?.addEventListener('click', () => {
            const sfState = window.__sortFilterState;
            sfState.sortDir = sfState.sortDir === 'desc' ? 'asc' : 'desc';
            const icon = document.getElementById('sortDateIcon');
            if (icon) {
                icon.className = sfState.sortDir === 'desc' ? 'fa-solid fa-arrow-down text-[9px]' : 'fa-solid fa-arrow-up text-[9px]';
            }
            updateStats();
        });

        const DATE_FILTER_LABELS = {
            '': 'Всі дати',
            this_week: 'Цей тиждень',
            last_week: 'Минулий тиждень',
            this_month: 'Цей місяць',
            last_month: 'Минулий місяць'
        };

        document.getElementById('dateFilterBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('statusFilterDropdown')?.classList.add('hidden');
            const dropdown = document.getElementById('dateFilterDropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        });

        document.getElementById('dateFilterDropdown')?.addEventListener('click', (e) => {
            const option = e.target.closest('[data-filter-date]');
            if (!option) return;
            const dateKey = option.dataset.filterDate || '';
            window.__sortFilterState.filterDate = dateKey;

            const label = document.getElementById('dateFilterLabel');
            const btn = document.getElementById('dateFilterBtn');
            if (label) label.textContent = DATE_FILTER_LABELS[dateKey] || 'Всі дати';
            if (btn) {
                if (dateKey === '') {
                    btn.className = 'flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200 transition';
                } else {
                    btn.className = 'flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700 border border-slate-300 hover:bg-slate-300 transition';
                }
            }

            document.getElementById('dateFilterDropdown')?.classList.add('hidden');
            updateStats();
        });

        document.getElementById('statusFilterBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('dateFilterDropdown')?.classList.add('hidden');
            const dropdown = document.getElementById('statusFilterDropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        });

        document.getElementById('statusFilterDropdown')?.addEventListener('click', (e) => {
            const option = e.target.closest('[data-filter-status]');
            if (!option) return;
            const status = option.dataset.filterStatus;
            window.__sortFilterState.filterStatus = status;
            
            const label = document.getElementById('statusFilterLabel');
            const btn = document.getElementById('statusFilterBtn');
            if (status === '') {
                label.textContent = 'Всі статуси';
                btn.className = 'flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200 transition';
            } else if (status === 'no_status') {
                label.textContent = 'Без статусу';
                btn.className = 'flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg bg-slate-200 text-slate-700 border border-slate-300 hover:bg-slate-300 transition';
            } else {
                const st = ORDER_STATUSES[status];
                label.textContent = st?.label || status;
                btn.className = `flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-lg ${st?.bg || 'bg-slate-100'} ${st?.text || 'text-slate-600'} ${st?.border || 'border-slate-200'} border hover:opacity-90 transition`;
            }
            
            document.getElementById('statusFilterDropdown')?.classList.add('hidden');
            updateStats();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#statusFilterWrapper')) {
                document.getElementById('statusFilterDropdown')?.classList.add('hidden');
            }
            if (!e.target.closest('#dateFilterWrapper')) {
                document.getElementById('dateFilterDropdown')?.classList.add('hidden');
            }
        });

        // --- ЛОГІКА ТА UI ---
        function calculateSalary(totalSales) {
            const goal = currentGoal > 0 ? currentGoal : 1;
            let salary = BASE_SALARY;
            let bonus = 0;
            let extra = 0;
            const progress = totalSales / goal;

            // Turnover KPI (max 40k)
            if (totalSales <= 0.5 * goal) {
                bonus = 0;
            } else if (totalSales < goal) {
                bonus = MAX_BONUS * progress;
            } else {
                bonus = MAX_BONUS;
                extra = (totalSales - goal) * 0.01;
            }

            // Conversion KPI (20k)
            const convBonus = (conversionMet) ? CONVERSION_BONUS : 0;
            bonus += convBonus;

            return { total: salary + bonus + extra, bonus, extra, percent: progress * 100 };
        }

        function updateUI(total, history) {
            const stats = calculateSalary(total);
            const remaining = currentGoal - total;

            // Верхні показники (залишаємо як було)
            document.getElementById('salaryAmount').innerText = Math.round(stats.total).toLocaleString() + ' ₴';
            document.getElementById('bonusLabel').innerText = '+' + Math.round(stats.bonus).toLocaleString() + ' ₴';
            document.getElementById('extraLabel').innerText = '+' + Math.round(stats.extra).toLocaleString() + ' ₴';
            
            let salaryProgress = stats.percent < 50 ? 0 : (stats.percent - 50) * 2;
            document.getElementById('salaryBar').style.width = Math.min(salaryProgress, 100) + '%';

            document.getElementById('totalSalesLabel').innerText = total.toLocaleString() + ' ₴';
            document.getElementById('remainingLabel').innerText = (remaining > 0 ? remaining.toLocaleString() : 'Виконано!') + ' ₴';
            document.getElementById('percentLabel').innerText = Math.round(stats.percent) + '%';
            
            const circumference = 80 * 2 * Math.PI;
            const offset = circumference - (Math.min(stats.percent, 100) / 100 * circumference);
            document.getElementById('progressCircle').style.strokeDashoffset = offset;
            document.getElementById('displayMonth').innerText = currentMonth;
            document.getElementById('goalMidLabel').innerText = (currentGoal / 2 / 1000) + 'к';

            const conv = document.getElementById('conversionToggle');
            if (conv) conv.checked = !!conversionMet;

            // Історія з кнопкою видалення
            const historyBody = document.getElementById('historyBody');
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            const regionOptionsHtml = document.getElementById('regionSelect')?.innerHTML || '';
            if (!window.__historyState) window.__historyState = { editingOrderId: null, byOrderId: {}, allHistory: [] };
            const state = window.__historyState;
            state.byOrderId = {};
            state.allHistory = history; // Store for shipment notifications

            // Застосувати сортування та фільтрацію
            const sfState = window.__sortFilterState || { sortDir: 'desc', filterStatus: '', filterDate: '' };
            let filteredHistory = [...history];

            const toDateOnly_ = (v) => {
                const d = new Date(v);
                if (!Number.isFinite(d.getTime())) return null;
                return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            };

            const getDateRangeForFilter_ = (key) => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const startOfWeek = (d) => {
                    const day = d.getDay();
                    const diff = day === 0 ? -6 : 1 - day; // Monday as start
                    const s = new Date(d);
                    s.setDate(d.getDate() + diff);
                    return new Date(s.getFullYear(), s.getMonth(), s.getDate());
                };

                if (!key) return null;

                if (key === 'this_week') {
                    const from = startOfWeek(today);
                    const to = new Date(from);
                    to.setDate(from.getDate() + 6);
                    return { from, to };
                }
                if (key === 'last_week') {
                    const thisWeekStart = startOfWeek(today);
                    const from = new Date(thisWeekStart);
                    from.setDate(thisWeekStart.getDate() - 7);
                    const to = new Date(thisWeekStart);
                    to.setDate(thisWeekStart.getDate() - 1);
                    return { from, to };
                }
                if (key === 'this_month') {
                    const from = new Date(today.getFullYear(), today.getMonth(), 1);
                    const to = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    return { from, to };
                }
                if (key === 'last_month') {
                    const from = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const to = new Date(today.getFullYear(), today.getMonth(), 0);
                    return { from, to };
                }

                return null;
            };

            // Фільтрація по даті
            if (sfState.filterDate) {
                const range = getDateRangeForFilter_(sfState.filterDate);
                if (range) {
                    filteredHistory = filteredHistory.filter(item => {
                        const d = toDateOnly_(item.date);
                        if (!d) return false;
                        return d >= range.from && d <= range.to;
                    });
                }
            }

            // Фільтрація по статусу
            if (sfState.filterStatus) {
                if (sfState.filterStatus === 'no_status') {
                    filteredHistory = filteredHistory.filter(item => !item.status);
                } else {
                    filteredHistory = filteredHistory.filter(item => item.status === sfState.filterStatus);
                }
            }

            // Сортування по даті
            filteredHistory.sort((a, b) => {
                const dateA = new Date(a.date).getTime();
                const dateB = new Date(b.date).getTime();
                return sfState.sortDir === 'desc' ? dateB - dateA : dateA - dateB;
            });

            // Замінюємо history на відфільтрований список
            history = filteredHistory;

            const toInputDate = (v) => {
                const d = new Date(v);
                const s1 = toLocalYmd_(d);
                if (s1) return s1;
                const s = String(v || '').slice(0, 10);
                return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
            };

            // Use global escapeHtml_ function
            const escapeHtml = escapeHtml_;

            history.forEach(item => {
                const orderId = String(item.id || '');
                if (orderId) state.byOrderId[orderId] = item;

                const crmUrl = normalizeCrmUrl_(item.crmLink || item.link || '');
                const payerText = escapeHtml(item.payer);
                const payerHtml = crmUrl
                    ? `<a href="${escapeHtml(crmUrl)}" target="_blank" rel="noopener noreferrer" class="block truncate whitespace-nowrap text-blue-700 hover:underline">${payerText}</a>`
                    : `<span class="block truncate whitespace-nowrap">${payerText}</span>`;

                const region = (item.region || '').toString().trim();
                const items = (item.items || '').toString().trim();
                const comment = (item.comment || '').toString().trim();

                const regionLabel = region || '—';
                const itemsLabel = items || '—';
                const commentLabel = comment || '';
                const itemsCommentText = commentLabel ? `${itemsLabel} • ${commentLabel}` : itemsLabel;

                const rowId = String(item.rowId);
                const orderIdAttr = String(item.id || '');

                const statusBadge = renderStatusBadge_(item.status);
                const quickStatusBtns = renderQuickStatusButtons_(orderIdAttr, rowId, item.status);
                
                // Shipment date badge with color coding
                let shipmentBadge = '';
                if (item.shipmentDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const shipDate = new Date(item.shipmentDate);
                    shipDate.setHours(0, 0, 0, 0);
                    const daysUntil = Math.ceil((shipDate - today) / (1000 * 60 * 60 * 24));
                    
                    let badgeClass = '';
                    let badgeTitle = '';
                    if (daysUntil < 0) {
                        badgeClass = 'bg-slate-200 text-slate-500';
                        badgeTitle = 'Прострочено';
                    } else if (daysUntil <= 3) {
                        badgeClass = 'bg-red-100 text-red-700';
                        badgeTitle = daysUntil === 0 ? 'Сьогодні!' : `Через ${daysUntil} дн.`;
                    } else if (daysUntil <= 7) {
                        badgeClass = 'bg-amber-100 text-amber-700';
                        badgeTitle = `Через ${daysUntil} дн.`;
                    } else if (daysUntil <= 10) {
                        badgeClass = 'bg-blue-100 text-blue-700';
                        badgeTitle = `Через ${daysUntil} дн.`;
                    } else {
                        badgeClass = 'bg-slate-100 text-slate-600';
                        badgeTitle = `Через ${daysUntil} дн.`;
                    }
                    shipmentBadge = `<div class="shrink-0 px-2 py-0.5 rounded-lg text-[10px] font-medium ${badgeClass}" title="${badgeTitle}"><i class="fa-solid fa-truck mr-1"></i>${new Date(item.shipmentDate).toLocaleDateString('uk-UA')}</div>`;
                }

                const rowHtml = `
                    <tr class="hover:bg-slate-50 group">
                        <td class="p-0" colspan="4">
                            <div class="px-4 py-3">
                                <div class="min-w-0">
                                    <div class="flex items-center gap-2 min-w-0 flex-wrap">
                                        <div class="shrink-0 text-slate-400 text-xs tabular-nums whitespace-nowrap">
                                            ${new Date(item.date).toLocaleDateString('uk-UA')}
                                        </div>
                                        <div class="shrink-0 text-slate-300">•</div>
                                        <div class="min-w-0 text-xs font-medium text-slate-600 truncate whitespace-nowrap" title="${escapeHtml(regionLabel)}">
                                            ${escapeHtml(regionLabel)}
                                        </div>
                                        ${statusBadge ? `<div class="shrink-0">${statusBadge}</div>` : ''}
                                        ${shipmentBadge}
                                    </div>

                                    <div class="mt-1 min-w-0 text-[11px] font-medium text-slate-900 truncate whitespace-nowrap leading-tight" title="${escapeHtml(item.payer)}">
                                        ${payerHtml}
                                    </div>

                                    <div class="mt-1 min-w-0 text-xs text-slate-500 truncate whitespace-nowrap" title="${escapeHtml(itemsCommentText)}">
                                        ${escapeHtml(itemsCommentText)}
                                    </div>

                                    <div class="mt-2 flex items-center justify-between gap-2">
                                        <div class="shrink-0 text-right font-bold text-blue-600 tabular-nums whitespace-nowrap">
                                            ${Number(item.amount).toLocaleString()} ₴
                                        </div>

                                        <div class="shrink-0 flex items-center opacity-100 sm:opacity-0 group-hover:opacity-100">
                                            <div class="flex items-center space-x-2">
                                                ${quickStatusBtns}
                                                <button type="button" title="Редагувати" aria-label="Редагувати" data-action="edit" data-rowid="${rowId}" data-orderid="${escapeHtml(orderIdAttr)}" class="w-9 h-9 rounded-xl bg-slate-200 text-slate-800 text-xs font-bold flex items-center justify-center">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button type="button" title="Видалити" aria-label="Видалити" data-action="delete" data-rowid="${rowId}" data-orderid="${escapeHtml(orderIdAttr)}" class="w-9 h-9 rounded-xl bg-red-100 text-red-700 text-xs font-bold flex items-center justify-center">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Add row to fragment
                const tempDiv = document.createElement('tbody');
                tempDiv.innerHTML = rowHtml;
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }
            });
            
            // Single DOM update
            historyBody.innerHTML = '';
            historyBody.appendChild(fragment);
            
            // Check for upcoming shipments (3 days before)
            checkUpcomingShipments_(history);
        }

        // --- Shipment Notification System ---
        function checkUpcomingShipments_(history, force = false) {
            if (!history || !history.length) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingShipments = history.filter(order => {
                if (!order.shipmentDate) return false;
                const shipDate = new Date(order.shipmentDate);
                shipDate.setHours(0, 0, 0, 0);
                // Show notification for orders shipping in 3 days or less (but not past)
                const daysUntil = Math.ceil((shipDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil >= 0 && daysUntil <= 3;
            });
            
            if (upcomingShipments.length === 0) {
                console.log('[Shipment] Немає замовлень з відгрузкою в найближчі 3 дні');
                return;
            }
            
            // Check if we already showed notification today (skip if force=true)
            if (!force) {
                const lastNotifDate = localStorage.getItem('lastShipmentNotifDate_' + loggedInManagerId);
                const todayStr = today.toISOString().split('T')[0];
                if (lastNotifDate === todayStr) {
                    console.log('[Shipment] Сповіщення вже показано сьогодні');
                    return;
                }
                localStorage.setItem('lastShipmentNotifDate_' + loggedInManagerId, todayStr);
            }
            
            // Request notification permission if needed
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Show notification
            showShipmentNotification_(upcomingShipments);
        }
        
        function showShipmentNotification_(orders) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const messages = orders.map(o => {
                const shipDate = new Date(o.shipmentDate);
                shipDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((shipDate - today) / (1000 * 60 * 60 * 24));
                let dayText = '';
                if (daysUntil === 0) dayText = 'сьогодні';
                else if (daysUntil === 1) dayText = 'завтра';
                else if (daysUntil === 2) dayText = 'післязавтра';
                else dayText = `через ${daysUntil} дні`;
                return `• ${o.payer} (${dayText})`;
            }).join('\n');
            
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`🚚 Відгрузка: ${orders.length} замовл.`, {
                    body: messages,
                    icon: '/images/icon-192.png',
                    tag: 'shipment-reminder'
                });
            }
            
            // Also show in-page toast
            showShipmentToast_(orders);
        }
        
        function showShipmentToast_(orders) {
            // Remove existing toast if any
            document.getElementById('shipmentToast')?.remove();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const listHtml = orders.map(o => {
                const shipDate = new Date(o.shipmentDate);
                shipDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((shipDate - today) / (1000 * 60 * 60 * 24));
                let dayText = '';
                let urgencyClass = 'bg-slate-100 text-slate-600';
                if (daysUntil === 0) { dayText = 'Сьогодні'; urgencyClass = 'bg-red-100 text-red-700'; }
                else if (daysUntil === 1) { dayText = 'Завтра'; urgencyClass = 'bg-orange-100 text-orange-700'; }
                else if (daysUntil === 2) { dayText = 'Післязавтра'; urgencyClass = 'bg-amber-100 text-amber-700'; }
                else { dayText = `Через ${daysUntil} дні`; urgencyClass = 'bg-amber-100 text-amber-700'; }
                return `<div class="flex items-center justify-between gap-2 py-2 border-b border-slate-100 last:border-0">
                    <span class="text-sm font-medium text-slate-800 truncate">${escapeHtml_(o.payer)}</span>
                    <span class="shrink-0 px-2 py-1 rounded-lg text-xs font-bold ${urgencyClass}">${dayText}</span>
                </div>`;
            }).join('');
            
            const toast = document.createElement('div');
            toast.id = 'shipmentToast';
            toast.className = 'fixed bottom-20 sm:bottom-6 right-4 left-4 sm:left-auto sm:w-80 z-50 glass rounded-2xl shadow-2xl border border-amber-200 overflow-hidden animate-slide-up';
            toast.innerHTML = `
                <div class="p-4 bg-amber-50/80">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2 text-amber-700 font-bold">
                            <i class="fa-solid fa-truck"></i>
                            <span>Ближні відгрузки</span>
                        </div>
                        <button id="closeShipmentToast" class="w-8 h-8 rounded-xl bg-amber-200 text-amber-700 hover:bg-amber-300 flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto">${listHtml}</div>
                </div>
            `;
            document.body.appendChild(toast);
            
            document.getElementById('closeShipmentToast')?.addEventListener('click', () => {
                toast.remove();
            });
            
            // Auto-hide after 15 seconds
            setTimeout(() => toast.remove(), 15000);
        }
        
        // Show all shipments sorted by date
        function showAllShipments_(history) {
            if (!history || !history.length) {
                alert('Немає замовлень');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filter orders with shipmentDate and sort by date
            const shipmentsWithDate = history
                .filter(order => order.shipmentDate)
                .map(order => {
                    const shipDate = new Date(order.shipmentDate);
                    shipDate.setHours(0, 0, 0, 0);
                    const daysUntil = Math.ceil((shipDate - today) / (1000 * 60 * 60 * 24));
                    return { ...order, shipDate, daysUntil };
                })
                .sort((a, b) => a.shipDate - b.shipDate); // Sort by shipment date ascending
            
            if (shipmentsWithDate.length === 0) {
                alert('Немає замовлень з датою відгрузки');
                return;
            }
            
            // Remove existing toast
            document.getElementById('shipmentToast')?.remove();
            
            const listHtml = shipmentsWithDate.map(o => {
                let dayText = '';
                let urgencyClass = 'bg-slate-100 text-slate-600';
                
                if (o.daysUntil < 0) {
                    dayText = `${Math.abs(o.daysUntil)} дн. тому`;
                    urgencyClass = 'bg-slate-200 text-slate-500';
                } else if (o.daysUntil === 0) {
                    dayText = 'Сьогодні';
                    urgencyClass = 'bg-red-100 text-red-700';
                } else if (o.daysUntil === 1) {
                    dayText = 'Завтра';
                    urgencyClass = 'bg-red-100 text-red-700';
                } else if (o.daysUntil <= 3) {
                    dayText = `${o.daysUntil} дні`;
                    urgencyClass = 'bg-red-100 text-red-700';
                } else if (o.daysUntil <= 7) {
                    dayText = `${o.daysUntil} дн.`;
                    urgencyClass = 'bg-amber-100 text-amber-700';
                } else if (o.daysUntil <= 10) {
                    dayText = `${o.daysUntil} дн.`;
                    urgencyClass = 'bg-blue-100 text-blue-700';
                } else {
                    dayText = `${o.daysUntil} дн.`;
                    urgencyClass = 'bg-slate-100 text-slate-600';
                }
                
                const dateStr = new Date(o.shipmentDate).toLocaleDateString('uk-UA');
                
                return `<div class="flex items-center justify-between gap-2 py-2 border-b border-slate-100 last:border-0">
                    <div class="min-w-0 flex-1">
                        <div class="text-sm font-medium text-slate-800 truncate">${escapeHtml_(o.payer)}</div>
                        <div class="text-[10px] text-slate-400">${dateStr}</div>
                    </div>
                    <span class="shrink-0 px-2 py-1 rounded-lg text-xs font-bold ${urgencyClass}">${dayText}</span>
                </div>`;
            }).join('');
            
            const toast = document.createElement('div');
            toast.id = 'shipmentToast';
            toast.className = 'fixed bottom-20 sm:bottom-6 right-4 left-4 sm:left-auto sm:w-96 z-50 glass rounded-2xl shadow-2xl border border-slate-200 overflow-hidden animate-slide-up';
            toast.innerHTML = `
                <div class="p-4 bg-white/90">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2 text-slate-700 font-bold">
                            <i class="fa-solid fa-truck"></i>
                            <span>Всі відгрузки (${shipmentsWithDate.length})</span>
                        </div>
                        <button id="closeShipmentToast" class="w-8 h-8 rounded-xl bg-slate-200 text-slate-700 hover:bg-slate-300 flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="max-h-64 overflow-y-auto">${listHtml}</div>
                </div>
            `;
            document.body.appendChild(toast);
            
            document.getElementById('closeShipmentToast')?.addEventListener('click', () => {
                toast.remove();
            });
        }

        // History actions (edit/save/cancel/delete)
        document.getElementById('historyBody')?.addEventListener('click', async (e) => {
            // Handle status dropdown toggle
            const toggleBtn = e.target.closest('[data-action="toggle-status-dropdown"]');
            if (toggleBtn) {
                const rowId = toggleBtn.dataset.rowid;
                const dropdown = document.querySelector(`[data-status-dropdown="${rowId}"]`);
                if (dropdown) {
                    // Close all other dropdowns
                    document.querySelectorAll('[data-status-dropdown]').forEach(d => {
                        if (d !== dropdown) d.classList.add('hidden');
                    });
                    dropdown.classList.toggle('hidden');
                }
                return;
            }

            // Handle status option selection
            const statusOption = e.target.closest('[data-action="quick-status-option"]');
            if (statusOption) {
                if (!window.__historyState) return;
                const state = window.__historyState;
                const newStatus = statusOption.dataset.status || '';
                const orderId = statusOption.dataset.orderid;
                const rowId = statusOption.dataset.rowid;

                // Close dropdown
                const dropdown = document.querySelector(`[data-status-dropdown="${rowId}"]`);
                if (dropdown) dropdown.classList.add('hidden');

                if (!orderId) {
                    alert('Не вдалося визначити ID замовлення');
                    return;
                }
                const existingOrder = state.byOrderId?.[orderId];
                if (!existingOrder) {
                    alert('Замовлення не знайдено');
                    return;
                }

                try {
                    await fs_updateOrder_(loggedInManagerId, orderId, { 
                        date: existingOrder.date, 
                        payer: existingOrder.payer, 
                        crmLink: existingOrder.crmLink || '', 
                        region: existingOrder.region || '', 
                        items: existingOrder.items || '', 
                        comment: existingOrder.comment || '', 
                        amount: existingOrder.amount,
                        status: newStatus 
                    }, existingOrder.amount);
                    console.info('[CRM] quick-status update source: firebase');

                    const payload = { 
                        action: 'updateOrder', 
                        managerId: loggedInManagerId, 
                        id: orderId, 
                        date: existingOrder.date, 
                        payer: existingOrder.payer, 
                        crmLink: existingOrder.crmLink || '', 
                        region: existingOrder.region || '', 
                        items: existingOrder.items || '', 
                        comment: existingOrder.comment || '', 
                        amount: existingOrder.amount,
                        status: newStatus 
                    };
                    const ok = await postToScript_(payload);
                    if (!ok) enqueueSheetsOp_({ type: 'updateOrder', payload });
                } catch (err) {
                    console.warn('[CRM] quick-status update firebase failed', err);
                    alert('Помилка зміни статусу. Спробуйте ще раз.');
                    return;
                }

                setTimeout(updateStats, 600);
                return;
            }

            const btn = e.target.closest('button[data-action][data-rowid]');
            if (!btn) return;
            if (!window.__historyState) return;
            const state = window.__historyState;
            const action = btn.dataset.action;
            const rowId = String(btn.dataset.rowid || '');
            const orderId = String(btn.dataset.orderid || '');
            if (!rowId) return;

            const editKey = orderId || rowId;

            if (action === 'edit') {
                // Open modal with order data for editing
                const orderData = state.byOrderId?.[orderId];
                if (!orderData) {
                    alert('Не вдалося знайти дані замовлення');
                    return;
                }
                openOrderModal_(orderData);
                return;
            }
            if (action === 'delete') {
                if (!confirm('Видалити це замовлення?')) return;
                const prevAmount = state.byOrderId?.[orderId]?.amount;
                if (!orderId) {
                    alert('Не вдалося визначити ID замовлення для видалення');
                    return;
                }

                try {
                    await fs_deleteOrder_(loggedInManagerId, orderId, prevAmount);
                    console.info('[CRM] deleteOrder source: firebase');

                    // Sheets backup: try now; if fails, queue for later.
                    const payload = { action: 'deleteOrder', managerId: loggedInManagerId, id: orderId };
                    const ok = await postToScript_(payload);
                    if (!ok) enqueueSheetsOp_({ type: 'deleteOrder', payload });
                } catch (e) {
                    console.warn('[CRM] deleteOrder firebase failed', e);
                    alert('Помилка видалення в базі. Спробуйте ще раз.');
                    return;
                }
                setTimeout(updateStats, 600);
                return;
            }
        });

        // Close status dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.status-dropdown-wrapper')) {
                document.querySelectorAll('[data-status-dropdown]').forEach(d => d.classList.add('hidden'));
            }
        });

        async function updateStats() {
            try {
                setLoading_(true);
                let data;
                try {
                    data = await fs_getStats_(loggedInManagerId);
                    window.__crmDataSource = 'firebase';
                    console.info('[CRM] updateStats source: firebase');
                } catch (e) {
                    console.warn('[CRM] updateStats firebase failed', e);
                    const status = document.getElementById('connectionStatus');
                    if (status) {
                        status.textContent = 'Немає доступу до бази';
                        status.className = 'text-[10px] text-red-600 bg-red-50 px-2 py-1 rounded';
                    }
                    setLoading_(false);
                    return;
                }

                // Plans come from backend
                setDbPlans_(data.plans);
                renderLocalPlans_();
                renderProgressPeriodPicker_();

                const allHistory = Array.isArray(data.history) ? data.history : [];
                window.__lastAllHistory = allHistory;
                const view = buildProgressView_(allHistory);
                currentGoal = Number(view.goal) || currentGoal;
                currentMonth = view.label || currentMonth;
                // Progress metrics respect selected plan months, but the orders list should show all saved orders.
                updateUI(view.total || 0, allHistory);
                setLoading_(false);
            } catch (e) { console.error(e); }
        }

        // Conversion toggle (client-side only)
        (function () {
            try {
                const conv = document.getElementById('conversionToggle');
                if (!conv) return;
                conv.checked = true;
                conversionMet = true;
                conv.addEventListener('change', () => {
                    conversionMet = !!conv.checked;
                    const allHistory = Array.isArray(window.__lastAllHistory) ? window.__lastAllHistory : [];
                    const view = buildProgressView_(allHistory);
                    updateUI(view.total || 0, allHistory);
                });
            } catch (e) {}
        })();

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const editingOrderId = document.getElementById('editingOrderId')?.value || '';
            const editingOrderPrevAmount = document.getElementById('editingOrderPrevAmount')?.value || '';
            const isEditing = !!editingOrderId;
            
            const orderDate = document.getElementById('orderDate')?.value;
            const shipmentDate = document.getElementById('orderShipmentDate')?.value || '';
            const payer = document.getElementById('payer').value.trim();
            const crmLinkRaw = document.getElementById('orderCrmLink')?.value?.trim() || '';
            const crmLink = normalizeCrmUrl_(crmLinkRaw);
            const region = document.getElementById('regionSelect').value;
            const amount = document.getElementById('amount').value;
            const items = document.getElementById('orderItems')?.value?.trim() || '';
            const comment = document.getElementById('orderComment')?.value?.trim() || '';
            const status = document.getElementById('orderStatus')?.value || '';

            if (!orderDate) {
                alert('Оберіть дату');
                return;
            }

            if (crmLinkRaw && !crmLink) {
                alert('Некоректне посилання в CRM');
                return;
            }

            btn.disabled = true;
            btn.innerText = isEditing ? 'Зберігаємо...' : 'Додаємо...';

            try {
                if (isEditing) {
                    // Update existing order
                    try {
                        await fs_updateOrder_(loggedInManagerId, editingOrderId, { 
                            date: orderDate, shipmentDate, payer, crmLink, region, items, comment, amount, status 
                        }, editingOrderPrevAmount);
                        console.info('[CRM] updateOrder source: firebase');
                        
                        // Sheets backup
                        const payload = { 
                            action: 'updateOrder', 
                            managerId: loggedInManagerId, 
                            id: editingOrderId, 
                            date: orderDate, shipmentDate, payer, crmLink, region, items, comment, amount, status 
                        };
                        const ok = await postToScript_(payload);
                        if (!ok) enqueueSheetsOp_({ type: 'updateOrder', payload });
                    } catch (err) {
                        console.warn('[CRM] updateOrder firebase failed', err);
                        alert('Помилка збереження в базі. Спробуйте ще раз.');
                        btn.disabled = false;
                        btn.innerText = 'Зберегти';
                        return;
                    }
                } else {
                    // Create new order
                    let newId = '';
                    try {
                        newId = await fs_addOrder_(loggedInManagerId, { date: orderDate, shipmentDate, payer, crmLink, region, items, comment, amount, status });
                        window.__crmDataSource = 'firebase';
                        console.info('[CRM] addOrder source: firebase');
                    } catch (err) {
                        console.warn('[CRM] addOrder firebase failed', err);
                        alert('Помилка збереження в базі. Спробуйте ще раз.');
                        btn.disabled = false;
                        btn.innerText = 'Додати';
                        return;
                    }

                    // Backup to Sheets (best-effort, do not block UI)
                    if (newId) {
                        const payload = {
                            managerId: loggedInManagerId,
                            id: newId,
                            date: orderDate,
                            shipmentDate,
                            payer,
                            crmLink,
                            region,
                            items,
                            comment,
                            amount,
                            status
                        };
                        const ok = await postToScript_(payload);
                        if (!ok) enqueueSheetsOp_({ type: 'createOrder', payload });
                    }
                }

                setTimeout(() => {
                    document.getElementById('orderForm').reset();
                    const d = new Date();
                    const el = document.getElementById('orderDate');
                    if (el) el.value = toLocalYmd_(d);
                    clearOrderDraft_();
                    btn.disabled = false;
                    btn.innerText = 'Додати';
                    closeOrderModal_();
                    updateStats();
                }, 800);
            } catch (err) {
                btn.disabled = false;
                btn.innerText = isEditing ? 'Зберегти' : 'Додати';
            }
        });

        function initAddPlanUI_() {
            const monthSelect = document.getElementById('addPlanMonth');
            if (!monthSelect || monthSelect.options.length) return;

            const now = new Date();
            const yyyy = String(now.getFullYear());

            const yearInput = document.getElementById('addPlanYear');
            if (yearInput && !String(yearInput.value || '').trim()) yearInput.value = yyyy;

            MONTH_KEYS.forEach((mm) => {
                const opt = document.createElement('option');
                opt.value = mm;
                opt.textContent = `${MONTH_LABELS[mm]}`;
                monthSelect.appendChild(opt);
            });

            const currentMm = String(now.getMonth() + 1).padStart(2, '0');
            monthSelect.value = `${currentMm}`;
        }

        function getAddPlanPeriod_() {
            const yearRaw = String(document.getElementById('addPlanYear')?.value || '').trim();
            const monthRaw = String(document.getElementById('addPlanMonth')?.value || '').trim();
            const yyyy = yearRaw;
            const mm = String(monthRaw).padStart(2, '0');
            if (!/^\d{4}$/.test(yyyy)) return '';
            if (!/^\d{2}$/.test(mm)) return '';
            return `${yyyy}-${mm}`;
        }

        function refreshAddPlanGoal_() {
            const period = getAddPlanPeriod_();
            const goalEl = document.getElementById('addPlanGoal');
            if (!goalEl) return;
            const existing = period ? getDbPlanGoal_(period) : 0;
            goalEl.value = existing > 0 ? String(existing) : '';
        }

        function openAddPlanPanel_() {
            initAddPlanUI_();
            document.getElementById('addPlanPanel')?.classList.remove('hidden');
            refreshAddPlanGoal_();
        }

        function closeAddPlanPanel_() {
            document.getElementById('addPlanPanel')?.classList.add('hidden');
        }

        document.getElementById('addPlanBtn')?.addEventListener('click', openAddPlanPanel_);
        document.getElementById('addPlanCancelBtn')?.addEventListener('click', closeAddPlanPanel_);
        document.getElementById('addPlanYear')?.addEventListener('input', refreshAddPlanGoal_);
        document.getElementById('addPlanMonth')?.addEventListener('change', refreshAddPlanGoal_);
        document.getElementById('addPlanSaveBtn')?.addEventListener('click', async () => {
            if (!loggedInManagerId) return;
            const btn = document.getElementById('addPlanSaveBtn');
            withButtonLoading_(btn, true, 'Зберегти', 'Збереження...');
            const period = getAddPlanPeriod_();
            if (!period) {
                withButtonLoading_(btn, false);
                alert('Вкажіть коректний рік і місяць');
                return;
            }
            const goal = Number(document.getElementById('addPlanGoal')?.value || 0);

            const safeGoal = Number.isFinite(goal) && goal > 0 ? goal : 0;
            try {
                await fs_setPlan_(loggedInManagerId, { period, label: formatPeriodLabel_(period), goal: safeGoal });
                console.info('[CRM] setPlan source: firebase');
                // Backup to Sheets (best-effort)
                const payload = { action: 'setPlan', managerId: loggedInManagerId, period, label: formatPeriodLabel_(period), goal: safeGoal };
                const ok = await postToScript_(payload);
                if (!ok) enqueueSheetsOp_({ type: 'setPlan', payload });
            } catch (e) {
                console.warn('[CRM] setPlan firebase failed', e);
                withButtonLoading_(btn, false);
                alert('Помилка збереження плану в базі. Спробуйте ще раз.');
                return;
            }

            optimisticUpsertPlan_(period, formatPeriodLabel_(period), Number.isFinite(goal) && goal > 0 ? goal : 0);
            closeAddPlanPanel_();
            renderLocalPlans_();
            renderProgressPeriodPicker_();
            refreshGoalFromPlans_();
            withButtonLoading_(btn, false);

            setTimeout(updateStats, 600);
        });

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function togglePlans() {
            document.getElementById('plansPanel').classList.toggle('hidden');
        }

        // Восстановление сессии при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            initAddPlanUI_();
            renderProgressPeriodPicker_();

            const d = new Date();
            const dateEl = document.getElementById('orderDate');
            if (dateEl && !dateEl.value) dateEl.value = toLocalYmd_(d);

            const stored = localStorage.getItem('crm_logged_manager');
            if (stored && MANAGERS[stored]) {
                loggedInManagerId = stored;
                // Синхронизируем UI
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('currentManagerName').innerText = MANAGERS[stored].name;
                // Установим селектор менеджера, если он есть
                const sel = document.getElementById('managerSelect');
                if (sel) sel.value = stored;
                renderLocalPlans_();
                renderProgressPeriodPicker_();
                updateStats();
            }
        });

        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const nav = document.querySelector('.nav');
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            hamburger.classList.toggle('open');
        });

        setInterval(updateStats, 60000);
    </script>
</body>
</html>